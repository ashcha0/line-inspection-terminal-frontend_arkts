import { HttpUtil } from '../utils/HttpUtil';
import { AppConstants } from '../constants/AppConstants';
import { AgvMovementService } from './AgvMovementService';

// AGVé…ç½®æ¥å£å®šä¹‰
export interface AgvConfig {
  id: number;
  host: string;
  drivePort: number;
  analysisPort: number;
  cloudUrl: string;
  cam1: string;
  cam2: string;
  cam3: string;
  cam4: string;
  username1: string;
  username2: string;
  username3: string;
  username4: string;
  password1: string;
  password2: string;
  password3: string;
  password4: string;
  deleteFlag?: boolean;
}

// æ‘„åƒå¤´è®¾å¤‡æ¥å£
export interface CameraDevice {
  id: string;
  name: string;
  status: string;
  ip?: string;
  port?: number;
  username?: string;
  password?: string;
}

// æ‘„åƒå¤´è®¾å¤‡åˆ—è¡¨å“åº”æ¥å£
export interface CameraDeviceResponse {
  total: number;
  rows: CameraDevice[];
  code: number;
  msg: string;
}

// é…ç½®éªŒè¯ç»“æœæ¥å£
export interface ValidationResult {
  valid: boolean;
  errors: string[];
}

/**
 * é…ç½®ç®¡ç†æœåŠ¡ç±»
 * æä¾›ç³»ç»Ÿé…ç½®çš„è·å–ã€æ›´æ–°å’Œæ‘„åƒå¤´è®¾å¤‡ç®¡ç†åŠŸèƒ½
 */
export class ConfigService {
  
  /**
   * è·å–ç³»ç»Ÿé…ç½®
   * @returns ç³»ç»Ÿé…ç½®ä¿¡æ¯
   */
  static async getConfig(): Promise<AgvConfig> {
    try {
      console.info('[ConfigService] ğŸ”§ è·å–ç³»ç»Ÿé…ç½®');
      const response = await HttpUtil.get('/agv/config');
      console.info('[ConfigService] âœ… ç³»ç»Ÿé…ç½®è·å–æˆåŠŸ');
      return response.data as AgvConfig;
    } catch (error) {
      console.error('[ConfigService] âŒ è·å–ç³»ç»Ÿé…ç½®å¤±è´¥:', error);
      throw new Error('è·å–ç³»ç»Ÿé…ç½®å¤±è´¥');
    }
  }
  
  /**
   * æ›´æ–°ç³»ç»Ÿé…ç½®
   * @param config é…ç½®å¯¹è±¡
   * @returns æ›´æ–°ç»“æœ
   */
  static async updateConfig(config: AgvConfig): Promise<Object> {
    try {
      console.info('[ConfigService] ğŸ“ æ›´æ–°ç³»ç»Ÿé…ç½®');
      const response = await HttpUtil.put('/agv/config', config);
      console.info('[ConfigService] âœ… ç³»ç»Ÿé…ç½®æ›´æ–°æˆåŠŸ');
      return response;
    } catch (error) {
      console.error('[ConfigService] âŒ æ›´æ–°ç³»ç»Ÿé…ç½®å¤±è´¥:', error);
      throw new Error('æ›´æ–°ç³»ç»Ÿé…ç½®å¤±è´¥');
    }
  }
  
  /**
   * è·å–æ‘„åƒå¤´è®¾å¤‡åˆ—è¡¨
   * @param page é¡µç ï¼Œé»˜è®¤1
   * @param size æ¯é¡µå¤§å°ï¼Œé»˜è®¤999
   * @param status è®¾å¤‡çŠ¶æ€ç­›é€‰
   * @param id è®¾å¤‡IDç­›é€‰
   * @param name è®¾å¤‡åç§°ç­›é€‰
   * @returns æ‘„åƒå¤´è®¾å¤‡åˆ—è¡¨
   */
  static async getDeviceList(
    page: number = 1, 
    size: number = 999, 
    status?: string, 
    id?: string, 
    name?: string
  ): Promise<CameraDeviceResponse> {
    try {
      console.info('[ConfigService] ğŸ“¹ è·å–æ‘„åƒå¤´è®¾å¤‡åˆ—è¡¨');
      
      let queryString = `page=${page}&size=${size}`;
      
      if (status) queryString += `&status=${status}`;
      if (id) queryString += `&id=${id}`;
      if (name) queryString += `&name=${name}`;
      
      const response = await HttpUtil.get(
        `${AppConstants.CAMERA_BASE_URL}/devices?${queryString}`,
        {
          headers: {
            'Authorization': 'Basic YWRtaW4xMjM6QWRtaW5AMTIz'
          }
        }
      );
      
      interface DeviceResponseData {
        total?: number;
        rows?: CameraDevice[];
      }
      const deviceData = response.data as DeviceResponseData;
      console.info('[ConfigService] âœ… æ‘„åƒå¤´è®¾å¤‡åˆ—è¡¨è·å–æˆåŠŸï¼Œæ•°é‡:', deviceData?.total || 0);
      
      return {
        total: deviceData?.total || 0,
        rows: deviceData?.rows || [],
        code: response.code,
        msg: response.msg
      };
    } catch (error) {
      console.error('[ConfigService] âŒ è·å–æ‘„åƒå¤´è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
      throw new Error('è·å–æ‘„åƒå¤´è®¾å¤‡åˆ—è¡¨å¤±è´¥');
    }
  }
  
  /**
   * æµ‹è¯•AGVè¿æ¥
   * @param host AGVä¸»æœºåœ°å€
   * @param port AGVç«¯å£
   * @returns è¿æ¥æµ‹è¯•ç»“æœ
   */
  static async testAgvConnection(host: string, port: number): Promise<boolean> {
    try {
      console.info(`[ConfigService] ğŸ”— æµ‹è¯•AGVè¿æ¥: ${host}:${port}`);
      
      // ä½¿ç”¨AgvMovementServiceçš„å¿ƒè·³æ£€æµ‹æ¥æµ‹è¯•è¿æ¥
      const heartbeatResult = await AgvMovementService.heartbeat();
      
      const isConnected = heartbeatResult.success;
      console.info(`[ConfigService] ${isConnected ? 'âœ…' : 'âŒ'} AGVè¿æ¥æµ‹è¯•${isConnected ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
      console.info(`[ConfigService] ğŸ“Š AGVçŠ¶æ€: ${heartbeatResult.status}, æ¶ˆæ¯: ${heartbeatResult.message || 'æ— '}`);
      
      return isConnected;
    } catch (error) {
      console.error('[ConfigService] âŒ AGVè¿æ¥æµ‹è¯•å¤±è´¥:', error);
      return false;
    }
  }
  
  /**
   * æµ‹è¯•æ‘„åƒå¤´è¿æ¥
   * @param cameraUrl æ‘„åƒå¤´åœ°å€
   * @param username ç”¨æˆ·å
   * @param password å¯†ç 
   * @returns è¿æ¥æµ‹è¯•ç»“æœ
   */
  static async testCameraConnection(cameraUrl: string, username: string, password: string): Promise<boolean> {
    try {
      console.info(`[ConfigService] ğŸ“¹ æµ‹è¯•æ‘„åƒå¤´è¿æ¥: ${cameraUrl}`);
      
      // è¿™é‡Œå¯ä»¥å°è¯•è·å–æ‘„åƒå¤´è®¾å¤‡åˆ—è¡¨æ¥æµ‹è¯•è¿æ¥
      const response = await HttpUtil.get(
        `${AppConstants.CAMERA_BASE_URL}/devices?page=1&size=1`,
        {
          headers: {
            'Authorization': 'Basic YWRtaW4xMjM6QWRtaW5AMTIz'
          },
          timeout: 5000 // 5ç§’è¶…æ—¶
        }
      );
      
      const isConnected = response.code === 200;
      console.info(`[ConfigService] ${isConnected ? 'âœ…' : 'âŒ'} æ‘„åƒå¤´è¿æ¥æµ‹è¯•${isConnected ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
      return isConnected;
    } catch (error) {
      console.error('[ConfigService] âŒ æ‘„åƒå¤´è¿æ¥æµ‹è¯•å¤±è´¥:', error);
      return false;
    }
  }
  
  /**
   * éªŒè¯é…ç½®å‚æ•°
   * @param config é…ç½®å¯¹è±¡
   * @returns éªŒè¯ç»“æœ
   */
  static validateConfig(config: AgvConfig): ValidationResult {
    const errors: string[] = [];
    
    // éªŒè¯AGVé…ç½®
    if (!config.host || config.host.trim() === '') {
      errors.push('AGVä¸»æœºåœ°å€ä¸èƒ½ä¸ºç©º');
    }
    
    if (!config.drivePort || config.drivePort <= 0 || config.drivePort > 65535) {
      errors.push('AGVé©±åŠ¨ç«¯å£å¿…é¡»åœ¨1-65535ä¹‹é—´');
    }
    
    if (!config.analysisPort || config.analysisPort <= 0 || config.analysisPort > 65535) {
      errors.push('AGVåˆ†æç«¯å£å¿…é¡»åœ¨1-65535ä¹‹é—´');
    }
    
    // éªŒè¯äº‘ç«¯åœ°å€
    if (!config.cloudUrl || config.cloudUrl.trim() === '') {
      errors.push('äº‘ç«¯åœ°å€ä¸èƒ½ä¸ºç©º');
    }
    
    // éªŒè¯æ‘„åƒå¤´é…ç½®
    const cameras = [config.cam1, config.cam2, config.cam3, config.cam4];
    const usernames = [config.username1, config.username2, config.username3, config.username4];
    const passwords = [config.password1, config.password2, config.password3, config.password4];
    
    for (let i = 0; i < cameras.length; i++) {
      if (cameras[i] && cameras[i].trim() !== '') {
        if (!usernames[i] || usernames[i].trim() === '') {
          errors.push(`æ‘„åƒå¤´${i + 1}ç”¨æˆ·åä¸èƒ½ä¸ºç©º`);
        }
        if (!passwords[i] || passwords[i].trim() === '') {
          errors.push(`æ‘„åƒå¤´${i + 1}å¯†ç ä¸èƒ½ä¸ºç©º`);
        }
      }
    }
    
    console.info(`[ConfigService] ğŸ” é…ç½®éªŒè¯${errors.length === 0 ? 'é€šè¿‡' : 'å¤±è´¥'}ï¼Œé”™è¯¯æ•°é‡: ${errors.length}`);
    
    const result: ValidationResult = {
      valid: errors.length === 0,
      errors: errors
    };
    return result;
  }
  
  /**
   * è·å–é»˜è®¤é…ç½®
   * @returns é»˜è®¤é…ç½®å¯¹è±¡
   */
  static getDefaultConfig(): AgvConfig {
    const defaultConfig: AgvConfig = {
      id: 0,
      host: '192.168.2.57',
      drivePort: 8080,
      analysisPort: 8081,
      cloudUrl: 'http://192.168.2.57/prod-api',
      cam1: '',
      cam2: '',
      cam3: '',
      cam4: '',
      username1: 'admin123',
      username2: 'admin123',
      username3: 'admin123',
      username4: 'admin123',
      password1: 'Admin@123',
      password2: 'Admin@123',
      password3: 'Admin@123',
      password4: 'Admin@123'
    };
    return defaultConfig;
  }
}

// æ·»åŠ æ°´å°æ ‡è¯†
console.info('ğŸ·ï¸ [ConfigService] æ™ºèƒ½å·¡çº¿è½¦æ‰‹æŒç»ˆç«¯ - é…ç½®ç®¡ç†æœåŠ¡å·²åŠ è½½');