import { HttpUtil } from '../utils/HttpUtil';
import { AppConstants } from '../constants/AppConstants';

// AGVçŠ¶æ€æ¥å£å®šä¹‰
export interface AgvStatusVO {
  sysTime: string;
  isRunning: boolean;
  currentPosition: number;
}

// AGVå¿ƒè·³çŠ¶æ€æ¥å£
export interface HeartbeatResult {
  success: boolean;
  status: string;
  timestamp: string;
  message?: string;
}

/**
 * AGVç§»åŠ¨æ§åˆ¶æœåŠ¡ç±»
 * æä¾›AGVçš„ç§»åŠ¨æ§åˆ¶ã€çŠ¶æ€æŸ¥è¯¢ç­‰åŠŸèƒ½
 */
export class AgvMovementService {
  
  /**
   * æŸ¥è¯¢AGVå¿ƒè·³çŠ¶æ€
   * @returns AGVå¿ƒè·³çŠ¶æ€
   */
  static async heartbeat(): Promise<HeartbeatResult> {
    try {
      console.info('[AgvMovementService] ğŸ’“ æŸ¥è¯¢AGVå¿ƒè·³çŠ¶æ€');
      const response = await HttpUtil.get('/agv/movement/heartbeat');
      interface HeartbeatData {
        status?: string;
      }
      const heartbeatData = response.data as HeartbeatData;
      console.info('[AgvMovementService] âœ… AGVå¿ƒè·³çŠ¶æ€è·å–æˆåŠŸ:', heartbeatData?.status || 'æœªçŸ¥');
      
      return {
        success: response.code === 200,
        status: heartbeatData?.status || 'unknown',
        timestamp: new Date().toISOString(),
        message: response.msg
      };
    } catch (error) {
      console.error('[AgvMovementService] âŒ æŸ¥è¯¢AGVå¿ƒè·³çŠ¶æ€å¤±è´¥:', error);
      return {
        success: false,
        status: 'offline',
        timestamp: new Date().toISOString(),
        message: 'å¿ƒè·³æ£€æµ‹å¤±è´¥'
      };
    }
  }
  
  /**
   * æ§åˆ¶AGVå‘å‰ç§»åŠ¨
   * @returns æ§åˆ¶ç»“æœ
   */
  static async agvForward(): Promise<Object> {
    try {
      console.info('[AgvMovementService] â¬†ï¸ æ§åˆ¶AGVå‘å‰ç§»åŠ¨');
      const response = await HttpUtil.post('/agv/movement/forward');
      console.info('[AgvMovementService] âœ… AGVå‘å‰ç§»åŠ¨æŒ‡ä»¤å‘é€æˆåŠŸ');
      return response;
    } catch (error) {
      console.error('[AgvMovementService] âŒ AGVå‘å‰ç§»åŠ¨å¤±è´¥:', error);
      throw new Error('AGVå‘å‰ç§»åŠ¨å¤±è´¥');
    }
  }
  
  /**
   * åœæ­¢AGV
   * @returns æ§åˆ¶ç»“æœ
   */
  static async agvStop(): Promise<Object> {
    try {
      console.info('[AgvMovementService] â¹ï¸ åœæ­¢AGV');
      const response = await HttpUtil.post('/agv/movement/stop');
      console.info('[AgvMovementService] âœ… AGVåœæ­¢æŒ‡ä»¤å‘é€æˆåŠŸ');
      return response;
    } catch (error) {
      console.error('[AgvMovementService] âŒ åœæ­¢AGVå¤±è´¥:', error);
      throw new Error('åœæ­¢AGVå¤±è´¥');
    }
  }
  
  /**
   * æ§åˆ¶AGVå‘åç§»åŠ¨
   * @returns æ§åˆ¶ç»“æœ
   */
  static async agvBackward(): Promise<Object> {
    try {
      console.info('[AgvMovementService] â¬‡ï¸ æ§åˆ¶AGVå‘åç§»åŠ¨');
      const response = await HttpUtil.post('/agv/movement/backward');
      console.info('[AgvMovementService] âœ… AGVå‘åç§»åŠ¨æŒ‡ä»¤å‘é€æˆåŠŸ');
      return response;
    } catch (error) {
      console.error('[AgvMovementService] âŒ AGVå‘åç§»åŠ¨å¤±è´¥:', error);
      throw new Error('AGVå‘åç§»åŠ¨å¤±è´¥');
    }
  }
  
  /**
   * è·å–AGVå½“å‰çŠ¶æ€ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
   * æ³¨ï¼šç”±äºæ¥å£æ–‡æ¡£ä¸­æ²¡æœ‰ç›´æ¥çš„çŠ¶æ€è·å–æ¥å£ï¼Œè¿™é‡Œæä¾›æ¨¡æ‹Ÿæ•°æ®
   * @returns AGVçŠ¶æ€ä¿¡æ¯
   */
  static async getAgvStatus(): Promise<AgvStatusVO> {
    try {
      console.info('[AgvMovementService] ğŸ“Š è·å–AGVå½“å‰çŠ¶æ€');
      
      // å…ˆæ£€æŸ¥å¿ƒè·³çŠ¶æ€
      const heartbeatResult = await AgvMovementService.heartbeat();
      
      // æ¨¡æ‹ŸAGVçŠ¶æ€æ•°æ®
      const mockStatus: AgvStatusVO = {
        sysTime: new Date().toLocaleString('zh-CN'),
        isRunning: heartbeatResult.success && heartbeatResult.status === 'running',
        currentPosition: Math.floor(Math.random() * 1000) + 100 // æ¨¡æ‹Ÿå½“å‰ä½ç½®
      };
      
      console.info('[AgvMovementService] âœ… AGVçŠ¶æ€è·å–æˆåŠŸ:', JSON.stringify(mockStatus));
      return mockStatus;
    } catch (error) {
      console.error('[AgvMovementService] âŒ è·å–AGVçŠ¶æ€å¤±è´¥:', error);
      // è¿”å›é»˜è®¤çŠ¶æ€
      return {
        sysTime: new Date().toLocaleString('zh-CN'),
        isRunning: false,
        currentPosition: 0
      };
    }
  }
  
  /**
   * ç´§æ€¥åœæ­¢AGV
   * @returns æ§åˆ¶ç»“æœ
   */
  static async emergencyStop(): Promise<Object> {
    try {
      console.warn('[AgvMovementService] ğŸš¨ ç´§æ€¥åœæ­¢AGV');
      const response = await AgvMovementService.agvStop();
      console.info('[AgvMovementService] âœ… ç´§æ€¥åœæ­¢æŒ‡ä»¤å‘é€æˆåŠŸ');
      return response;
    } catch (error) {
      console.error('[AgvMovementService] âŒ ç´§æ€¥åœæ­¢AGVå¤±è´¥:', error);
      throw new Error('ç´§æ€¥åœæ­¢AGVå¤±è´¥');
    }
  }
  
  /**
   * æ£€æŸ¥AGVæ˜¯å¦åœ¨çº¿
   * @returns åœ¨çº¿çŠ¶æ€
   */
  static async isOnline(): Promise<boolean> {
    try {
      const heartbeatResult = await AgvMovementService.heartbeat();
      return heartbeatResult.success;
    } catch (error) {
      console.error('[AgvMovementService] âŒ æ£€æŸ¥AGVåœ¨çº¿çŠ¶æ€å¤±è´¥:', error);
      return false;
    }
  }
}

// æ·»åŠ æ°´å°æ ‡è¯†
console.info('ğŸ·ï¸ [AgvMovementService] æ™ºèƒ½å·¡çº¿è½¦æ‰‹æŒç»ˆç«¯ - AGVç§»åŠ¨æ§åˆ¶æœåŠ¡å·²åŠ è½½');