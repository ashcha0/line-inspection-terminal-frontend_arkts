import { HttpUtil } from '../utils/HttpUtil';
import { AppConstants } from '../constants/AppConstants';

// ä»»åŠ¡æ¥å£å®šä¹‰
export interface AgvTask {
  id: number;
  taskCode: string;
  taskName: string;
  startPos: string;
  taskTrip: string;
  creator: string;
  executor: string;
  execTime?: Date;
  endTime?: Date;
  createTime: Date;
  taskStatus: string;
  round: number;
  uploaded: boolean;
  remark?: string;
  cloudTaskId?: number;
  deleteFlag?: boolean;
}

// åˆ†é¡µå‚æ•°æ¥å£
export interface PageParam {
  pageNum: number;
  pageSize: number;
  taskCode?: string;
  creator?: string;
  executor?: string;
  taskStatus?: string;
}

// åˆ†é¡µè¿”å›ç»“æœæ¥å£
export interface TableDataInfo<T> {
  total: number;
  rows: T[];
  code: number;
  msg: string;
}

// ä¸Šä¼ ä¿¡æ¯æ¥å£
export interface AgvUploadInfoVO {
  info: string;
  type: string;
  status: string;
}

/**
 * ä»»åŠ¡ç®¡ç†æœåŠ¡ç±»
 * æä¾›ä»»åŠ¡çš„å¢åˆ æ”¹æŸ¥ã€å¯åŠ¨ã€ç»“æŸã€ä¸Šä¼ ç­‰åŠŸèƒ½
 */
export class TaskService {
  
  /**
   * è·å–ä»»åŠ¡åˆ—è¡¨
   * @param params åˆ†é¡µå’Œç­›é€‰å‚æ•°
   * @returns ä»»åŠ¡åˆ—è¡¨æ•°æ®
   */
  static async listTask(params: PageParam): Promise<TableDataInfo<AgvTask>> {
    try {
      console.info('[TaskService] ğŸ” è·å–ä»»åŠ¡åˆ—è¡¨ï¼Œå‚æ•°:', JSON.stringify(params));
      
      let queryString = `pageNum=${params.pageNum}&pageSize=${params.pageSize}`;
      
      if (params.taskCode) queryString += `&taskCode=${encodeURIComponent(params.taskCode)}`;
      if (params.creator) queryString += `&creator=${encodeURIComponent(params.creator)}`;
      if (params.executor) queryString += `&executor=${encodeURIComponent(params.executor)}`;
      if (params.taskStatus) queryString += `&taskStatus=${encodeURIComponent(params.taskStatus)}`;
      
      const response = await HttpUtil.get(`/agv/task/list?${queryString}`);
      console.info('[TaskService] ğŸ“‹ åŸå§‹å“åº”æ•°æ®:', JSON.stringify(response));
      
      // æ ¹æ®æ—¥å¿—ï¼ŒAPIç›´æ¥è¿”å›åŒ…å«totalå’Œrowsçš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯åµŒå¥—åœ¨dataä¸­
      interface ResponseData {
        total?: number;
        rows?: AgvTask[];
        code?: number;
        msg?: string;
      }
      
      let responseData: ResponseData;
      // æ£€æŸ¥æ•°æ®æ˜¯å¦åœ¨response.dataä¸­è¿˜æ˜¯ç›´æ¥åœ¨responseä¸­
      if (response.data && typeof response.data === 'object' && (response.data as ResponseData).total !== undefined) {
        responseData = response.data as ResponseData;
      } else if ((response as ResponseData).total !== undefined) {
        responseData = response as ResponseData;
      } else {
        responseData = response.data as ResponseData;
      }
      
      console.info('[TaskService] âœ… ä»»åŠ¡åˆ—è¡¨è·å–æˆåŠŸï¼Œæ•°é‡:', responseData?.total || 0);
      console.info('[TaskService] ğŸ“‹ è§£æåçš„ä»»åŠ¡æ•°æ®:', responseData?.rows?.length || 0, 'æ¡');
      
      return {
        total: responseData?.total || 0,
        rows: responseData?.rows || [],
        code: responseData?.code || response.code || 200,
        msg: responseData?.msg || response.msg || 'æŸ¥è¯¢æˆåŠŸ'
      } as TableDataInfo<AgvTask>;
    } catch (error) {
      console.error('[TaskService] âŒ è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
      throw new Error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
    }
  }
  
  /**
   * è·å–ä»»åŠ¡è¯¦æƒ…
   * @param id ä»»åŠ¡ID
   * @returns ä»»åŠ¡è¯¦æƒ…
   */
  static async getTask(id: number): Promise<AgvTask> {
    try {
      console.info(`[TaskService] ğŸ” è·å–ä»»åŠ¡è¯¦æƒ…ï¼ŒID: ${id}`);
      const response = await HttpUtil.get(`/agv/task/${id}`);
      const taskData = response.data as AgvTask;
      console.info('[TaskService] âœ… ä»»åŠ¡è¯¦æƒ…è·å–æˆåŠŸ:', taskData?.taskName || 'æœªçŸ¥ä»»åŠ¡');
      return taskData;
    } catch (error) {
      console.error(`[TaskService] âŒ è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥ï¼ŒID: ${id}`, error);
      throw new Error(`è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥ï¼ŒID: ${id}`);
    }
  }
  
  /**
   * æ–°å»ºä»»åŠ¡
   * @param task ä»»åŠ¡æ•°æ®
   * @returns åˆ›å»ºç»“æœ
   */
  static async addTask(task: Partial<AgvTask>): Promise<Object> {
    try {
      console.info('[TaskService] ğŸ“ åˆ›å»ºæ–°ä»»åŠ¡:', task.taskName);
      const response = await HttpUtil.post('/agv/task', task);
      const responseData = response.data as AgvTask;
      console.info('[TaskService] âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼ŒID:', responseData?.id);
      return response;
    } catch (error) {
      console.error('[TaskService] âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
      throw new Error('åˆ›å»ºä»»åŠ¡å¤±è´¥');
    }
  }
  
  /**
   * æ›´æ–°ä»»åŠ¡
   * @param task ä»»åŠ¡æ•°æ®
   * @returns æ›´æ–°ç»“æœ
   */
  static async updateTask(task: AgvTask): Promise<Object> {
    try {
      console.info(`[TaskService] ğŸ“ æ›´æ–°ä»»åŠ¡ï¼ŒID: ${task.id}`);
      const response = await HttpUtil.put('/agv/task', task);
      console.info('[TaskService] âœ… ä»»åŠ¡æ›´æ–°æˆåŠŸ');
      return response;
    } catch (error) {
      console.error(`[TaskService] âŒ æ›´æ–°ä»»åŠ¡å¤±è´¥ï¼ŒID: ${task.id}`, error);
      throw new Error(`æ›´æ–°ä»»åŠ¡å¤±è´¥ï¼ŒID: ${task.id}`);
    }
  }
  
  /**
   * åˆ é™¤ä»»åŠ¡
   * @param id ä»»åŠ¡ID
   * @returns åˆ é™¤ç»“æœ
   */
  static async delTask(id: number): Promise<Object> {
    try {
      console.info(`[TaskService] ğŸ—‘ï¸ åˆ é™¤ä»»åŠ¡ï¼ŒID: ${id}`);
      const response = await HttpUtil.delete(`/agv/task/${id}`);
      console.info('[TaskService] âœ… ä»»åŠ¡åˆ é™¤æˆåŠŸ');
      return response;
    } catch (error) {
      console.error(`[TaskService] âŒ åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼ŒID: ${id}`, error);
      throw new Error(`åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼ŒID: ${id}`);
    }
  }
  
  /**
   * å¯åŠ¨ä»»åŠ¡
   * @param id ä»»åŠ¡ID
   * @returns å¯åŠ¨ç»“æœ
   */
  static async startTask(id: number): Promise<Object> {
    try {
      console.info(`[TaskService] ğŸš€ å¯åŠ¨ä»»åŠ¡ï¼ŒID: ${id}`);
      const response = await HttpUtil.post(`/agv/task/start/${id}`);
      console.info('[TaskService] âœ… ä»»åŠ¡å¯åŠ¨æˆåŠŸ');
      return response;
    } catch (error) {
      console.error(`[TaskService] âŒ å¯åŠ¨ä»»åŠ¡å¤±è´¥ï¼ŒID: ${id}`, error);
      throw new Error(`å¯åŠ¨ä»»åŠ¡å¤±è´¥ï¼ŒID: ${id}`);
    }
  }
  
  /**
   * ç»“æŸä»»åŠ¡
   * @param id ä»»åŠ¡ID
   * @param isAbort æ˜¯å¦ä¸­æ­¢ï¼ˆtrue: ä¸­æ­¢, false: å®Œæˆï¼‰
   * @returns ç»“æŸç»“æœ
   */
  static async endTask(id: number, isAbort: boolean = false): Promise<Object> {
    try {
      console.info(`[TaskService] ğŸ›‘ ç»“æŸä»»åŠ¡ï¼ŒID: ${id}, ä¸­æ­¢: ${isAbort}`);
      const response = await HttpUtil.post(`/agv/task/end/${id}?isAbort=${isAbort}`);
      console.info('[TaskService] âœ… ä»»åŠ¡ç»“æŸæˆåŠŸ');
      return response;
    } catch (error) {
      console.error(`[TaskService] âŒ ç»“æŸä»»åŠ¡å¤±è´¥ï¼ŒID: ${id}`, error);
      throw new Error(`ç»“æŸä»»åŠ¡å¤±è´¥ï¼ŒID: ${id}`);
    }
  }
  
  /**
   * æŸ¥è¯¢å¾…ä¸Šä¼ çš„æ•°æ®
   * @param id ä»»åŠ¡ID
   * @returns å¾…ä¸Šä¼ æ•°æ®ä¿¡æ¯
   */
  static async preUploadTask(id: number): Promise<AgvUploadInfoVO[]> {
    try {
      console.info(`[TaskService] ğŸ“‹ æŸ¥è¯¢å¾…ä¸Šä¼ æ•°æ®ï¼ŒID: ${id}`);
      const response = await HttpUtil.get(`/agv/task/preupload/${id}`);
      const uploadData = response.data as AgvUploadInfoVO[];
      console.info('[TaskService] âœ… å¾…ä¸Šä¼ æ•°æ®æŸ¥è¯¢æˆåŠŸï¼Œæ•°é‡:', uploadData?.length || 0);
      return uploadData || [];
    } catch (error) {
      console.error(`[TaskService] âŒ æŸ¥è¯¢å¾…ä¸Šä¼ æ•°æ®å¤±è´¥ï¼ŒID: ${id}`, error);
      throw new Error(`æŸ¥è¯¢å¾…ä¸Šä¼ æ•°æ®å¤±è´¥ï¼ŒID: ${id}`);
    }
  }
  
  /**
   * ä¸Šä¼ ä»»åŠ¡æ•°æ®
   * @param id ä»»åŠ¡ID
   * @returns ä¸Šä¼ ç»“æœ
   */
  static async uploadTask(id: number): Promise<Object> {
    try {
      console.info(`[TaskService] ğŸ“¤ ä¸Šä¼ ä»»åŠ¡æ•°æ®ï¼ŒID: ${id}`);
      const response = await HttpUtil.post(`/agv/task/upload/${id}`);
      console.info('[TaskService] âœ… ä»»åŠ¡æ•°æ®ä¸Šä¼ æˆåŠŸ');
      return response;
    } catch (error) {
      console.error(`[TaskService] âŒ ä¸Šä¼ ä»»åŠ¡æ•°æ®å¤±è´¥ï¼ŒID: ${id}`, error);
      throw new Error(`ä¸Šä¼ ä»»åŠ¡æ•°æ®å¤±è´¥ï¼ŒID: ${id}`);
    }
  }
}

// æ·»åŠ æ°´å°æ ‡è¯†
console.info('ğŸ·ï¸ [TaskService] æ™ºèƒ½å·¡çº¿è½¦æ‰‹æŒç»ˆç«¯ - ä»»åŠ¡ç®¡ç†æœåŠ¡å·²åŠ è½½');