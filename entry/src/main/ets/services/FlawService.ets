import { HttpUtil } from '../utils/HttpUtil';
import { AppConstants } from '../constants/AppConstants';

// æ•…éšœç¼ºé™·æ¥å£å®šä¹‰
export interface AgvFlaw {
  id: number;
  taskId: number;
  round: number;
  flawType: string;
  flawName: string;
  flawDesc: string;
  flawDistance: number;
  flawImage: string;
  flawImageUrl: string;
  flawRtsp: string;
  shown: boolean;
  confirmed: boolean;
  uploaded: boolean;
  createTime: Date;
  remark?: string;
  flawLength?: number;
  flawArea?: number;
  level?: string;
  countNum?: number;
  deleteFlag?: boolean;
  status?: string; // æ•…éšœçŠ¶æ€ï¼špending, confirmedç­‰
}

// åˆ†é¡µå‚æ•°æ¥å£
export interface FlawPageParam {
  pageNum: number;
  pageSize: number;
  taskId?: number;
  flawType?: string;
  confirmed?: boolean;
}

// åˆ†é¡µè¿”å›ç»“æœæ¥å£
export interface TableDataInfo<T> {
  total: number;
  rows: T[];
  code: number;
  msg: string;
}

// é€šç”¨å“åº”æ¥å£
export interface ApiResponse<T = object> {
  code: number;
  msg: string;
  data?: T;
}

/**
 * æ•…éšœç®¡ç†æœåŠ¡ç±»
 * æä¾›æ•…éšœçš„å¢åˆ æ”¹æŸ¥ã€ç¡®è®¤ç­‰åŠŸèƒ½
 */
export class FlawService {
  
  /**
   * è·å–æ•…éšœåˆ—è¡¨
   * @param params åˆ†é¡µå’Œç­›é€‰å‚æ•°
   * @returns æ•…éšœåˆ—è¡¨æ•°æ®
   */
  static async listFlaw(params: FlawPageParam): Promise<TableDataInfo<AgvFlaw>> {
    try {
      console.info('[FlawService] ğŸ” è·å–æ•…éšœåˆ—è¡¨ï¼Œå‚æ•°:', JSON.stringify(params));
      
      let queryString = `pageNum=${params.pageNum}&pageSize=${params.pageSize}`;
      
      if (params.taskId) queryString += `&taskId=${params.taskId}`;
      if (params.flawType) queryString += `&flawType=${encodeURIComponent(params.flawType)}`;
      if (params.confirmed !== undefined) queryString += `&confirmed=${params.confirmed}`;
      
      const response = await HttpUtil.get(`/agv/flaw/list?${queryString}`);
      const responseData = response.data as TableDataInfo<AgvFlaw>;
      console.info('[FlawService] âœ… æ•…éšœåˆ—è¡¨è·å–æˆåŠŸï¼Œæ•°é‡:', responseData?.total || 0);
      
      const result: TableDataInfo<AgvFlaw> = {
        total: responseData?.total || 0,
        rows: responseData?.rows || [],
        code: response.code,
        msg: response.msg
      };
      return result;
    } catch (error) {
      console.error('[FlawService] âŒ è·å–æ•…éšœåˆ—è¡¨å¤±è´¥:', error);
      throw new Error('è·å–æ•…éšœåˆ—è¡¨å¤±è´¥');
    }
  }
  
  /**
   * è·å–æ•…éšœè¯¦æƒ…
   * @param id æ•…éšœID
   * @returns æ•…éšœè¯¦æƒ…
   */
  static async getFlaw(id: number): Promise<AgvFlaw> {
    try {
      console.info(`[FlawService] ğŸ” è·å–æ•…éšœè¯¦æƒ…ï¼ŒID: ${id}`);
      const response = await HttpUtil.get(`/agv/flaw/${id}`);
      const flawData = response.data as AgvFlaw;
      console.info('[FlawService] âœ… æ•…éšœè¯¦æƒ…è·å–æˆåŠŸ:', flawData?.flawName || 'æœªçŸ¥æ•…éšœ');
      return response.data as AgvFlaw;
    } catch (error) {
      console.error(`[FlawService] âŒ è·å–æ•…éšœè¯¦æƒ…å¤±è´¥ï¼ŒID: ${id}`, error);
      throw new Error(`è·å–æ•…éšœè¯¦æƒ…å¤±è´¥ï¼ŒID: ${id}`);
    }
  }
  
  /**
   * æ–°å¢æ•…éšœ
   * @param flaw æ•…éšœæ•°æ®
   * @returns åˆ›å»ºç»“æœ
   */
  static async addFlaw(flaw: Partial<AgvFlaw>): Promise<ApiResponse<AgvFlaw>> {
    try {
      console.info('[FlawService] ğŸ“ åˆ›å»ºæ–°æ•…éšœ:', flaw.flawName);
      const response = await HttpUtil.post('/agv/flaw', flaw);
      const createdFlaw = response.data as AgvFlaw;
      console.info('[FlawService] âœ… æ•…éšœåˆ›å»ºæˆåŠŸï¼ŒID:', createdFlaw?.id);
      const result: ApiResponse<AgvFlaw> = {
        code: response.code,
        msg: response.msg,
        data: createdFlaw
      };
      return result;
    } catch (error) {
      console.error('[FlawService] âŒ åˆ›å»ºæ•…éšœå¤±è´¥:', error);
      throw new Error('åˆ›å»ºæ•…éšœå¤±è´¥');
    }
  }
  
  /**
   * æ›´æ–°æ•…éšœ
   * @param flaw æ•…éšœæ•°æ®
   * @returns æ›´æ–°ç»“æœ
   */
  static async updateFlaw(flaw: Partial<AgvFlaw>): Promise<ApiResponse<object>> {
    try {
      console.info(`[FlawService] ğŸ“ æ›´æ–°æ•…éšœï¼ŒID: ${flaw.id}`);
      const response = await HttpUtil.put('/agv/flaw', flaw);
      console.info('[FlawService] âœ… æ•…éšœæ›´æ–°æˆåŠŸ');
      const result: ApiResponse<object> = {
        code: response.code,
        msg: response.msg,
        data: response.data
      };
      return result;
    } catch (error) {
      console.error(`[FlawService] âŒ æ›´æ–°æ•…éšœå¤±è´¥ï¼ŒID: ${flaw.id}`, error);
      throw new Error(`æ›´æ–°æ•…éšœå¤±è´¥ï¼ŒID: ${flaw.id}`);
    }
  }
  
  /**
   * åˆ é™¤æ•…éšœ
   * @param id æ•…éšœID
   * @returns åˆ é™¤ç»“æœ
   */
  static async delFlaw(id: number): Promise<ApiResponse<object>> {
    try {
      console.info(`[FlawService] ğŸ—‘ï¸ åˆ é™¤æ•…éšœï¼ŒID: ${id}`);
      const response = await HttpUtil.delete(`/agv/flaw/${id}`);
      console.info('[FlawService] âœ… æ•…éšœåˆ é™¤æˆåŠŸ');
      const result: ApiResponse<object> = {
        code: response.code,
        msg: response.msg,
        data: response.data
      };
      return result;
    } catch (error) {
      console.error(`[FlawService] âŒ åˆ é™¤æ•…éšœå¤±è´¥ï¼ŒID: ${id}`, error);
      throw new Error(`åˆ é™¤æ•…éšœå¤±è´¥ï¼ŒID: ${id}`);
    }
  }
  
  /**
   * è½®è¯¢è·å–ä»»åŠ¡å®æ—¶æ•…éšœä¿¡æ¯
   * @param taskId ä»»åŠ¡ID
   * @returns å®æ—¶æ•…éšœä¿¡æ¯
   */
  static async liveInfo(taskId: number): Promise<AgvFlaw[]> {
    try {
      const requestUrl = `/agv/flaw/live/${taskId}`;
      console.info(`[FlawService] ğŸ”„ è½®è¯¢è·å–å®æ—¶æ•…éšœä¿¡æ¯`);
      console.info(`[FlawService] ğŸ“Š è¯·æ±‚å‚æ•°: taskId=${taskId}`);
      console.info(`[FlawService] ğŸ“Š è¯·æ±‚URL: ${requestUrl}`);
      
      const response = await HttpUtil.get(requestUrl);
      
      console.info(`[FlawService] ğŸ“Š å“åº”çŠ¶æ€ç : ${response.code}`);
      console.info(`[FlawService] ğŸ“Š å“åº”æ¶ˆæ¯: ${response.msg}`);
      console.info(`[FlawService] ğŸ“Š å“åº”æ•°æ®ç±»å‹: ${typeof response.data}`);
      console.info(`[FlawService] ğŸ“Š å“åº”æ•°æ®å†…å®¹: ${JSON.stringify(response.data)}`);
      
      if (response.code !== 200) {
        console.warn(`[FlawService] âš ï¸ æœåŠ¡å™¨è¿”å›é200çŠ¶æ€ç : ${response.code}, æ¶ˆæ¯: ${response.msg}`);
        return [];
      }
      
      const responseData = response.data as AgvFlaw[];
      
      if (!Array.isArray(responseData)) {
        console.warn(`[FlawService] âš ï¸ å“åº”æ•°æ®ä¸æ˜¯æ•°ç»„ç±»å‹: ${typeof responseData}`);
        return [];
      }
      
      console.info(`[FlawService] âœ… å®æ—¶æ•…éšœä¿¡æ¯è·å–æˆåŠŸï¼Œæ•°é‡: ${responseData.length}`);
      
      if (responseData.length > 0) {
         console.info(`[FlawService] ğŸ“Š æ•…éšœè¯¦æƒ…:`);
         responseData.forEach((flaw, index) => {
           const status = flaw.confirmed ? 'confirmed' : 'pending';
           console.info(`[FlawService] ğŸ“Š æ•…éšœ${index + 1}: ID=${flaw.id}, åç§°=${flaw.flawName}, ç±»å‹=${flaw.flawType}, çŠ¶æ€=${status}`);
         });
       } else {
         console.info(`[FlawService] ğŸ“Š å½“å‰ä»»åŠ¡æ— æ•…éšœæ•°æ®`);
       }
      
      return responseData;
    } catch (error) {
      console.error(`[FlawService] âŒ è·å–å®æ—¶æ•…éšœä¿¡æ¯å¤±è´¥ï¼Œä»»åŠ¡ID: ${taskId}`);
      console.error(`[FlawService] ğŸ“Š é”™è¯¯ç±»å‹: ${typeof error}`);
      console.error(`[FlawService] ğŸ“Š é”™è¯¯å†…å®¹: ${JSON.stringify(error)}`);
      console.error(`[FlawService] ğŸ“Š é”™è¯¯å †æ ˆ: ${error instanceof Error ? error.stack : 'æ— å †æ ˆä¿¡æ¯'}`);
      
      // è¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…ä¸­æ–­è½®è¯¢
      return [];
    }
  }
  
  /**
   * æ£€æŸ¥ä»»åŠ¡ç¼ºé™·æ˜¯å¦å·²å…¨éƒ¨ç¡®è®¤
   * @param taskId ä»»åŠ¡ID
   * @returns æ£€æŸ¥ç»“æœ
   */
  static async checkAllConfirmed(taskId: number): Promise<boolean> {
    try {
      console.info(`[FlawService] ğŸ” æ£€æŸ¥ä»»åŠ¡ç¼ºé™·æ˜¯å¦å·²å…¨éƒ¨ç¡®è®¤ï¼Œä»»åŠ¡ID: ${taskId}`);
      const response = await HttpUtil.get(`/agv/flaw/check/${taskId}`);
      console.info('[FlawService] âœ… æ£€æŸ¥å®Œæˆï¼Œå…¨éƒ¨ç¡®è®¤:', response.data);
      return response.data === true;
    } catch (error) {
      console.error(`[FlawService] âŒ æ£€æŸ¥ä»»åŠ¡ç¼ºé™·ç¡®è®¤çŠ¶æ€å¤±è´¥ï¼Œä»»åŠ¡ID: ${taskId}`, error);
      throw new Error(`æ£€æŸ¥ä»»åŠ¡ç¼ºé™·ç¡®è®¤çŠ¶æ€å¤±è´¥ï¼Œä»»åŠ¡ID: ${taskId}`);
    }
  }
  
  /**
   * ç¡®è®¤æ•…éšœ
   * @param id æ•…éšœID
   * @param confirmed æ˜¯å¦ç¡®è®¤ (å¯é€‰ï¼Œé»˜è®¤ä¸ºtrue)
   * @param remark å¤‡æ³¨ä¿¡æ¯
   * @returns ç¡®è®¤ç»“æœ
   */
  static async confirmFlaw(id: number, confirmed: boolean = true, remark?: string): Promise<ApiResponse<object>> {
    try {
      console.info(`[FlawService] âœ… ç¡®è®¤æ•…éšœï¼ŒID: ${id}, ç¡®è®¤: ${confirmed}`);
      const data: Partial<AgvFlaw> = {
        id: id,
        confirmed: confirmed,
        remark: remark
      };
      const response = await HttpUtil.put('/agv/flaw', data);
      console.info('[FlawService] âœ… æ•…éšœç¡®è®¤çŠ¶æ€æ›´æ–°æˆåŠŸ');
      const result: ApiResponse<object> = {
        code: response.code,
        msg: response.msg,
        data: response.data
      };
      return result;
    } catch (error) {
      console.error(`[FlawService] âŒ æ›´æ–°æ•…éšœç¡®è®¤çŠ¶æ€å¤±è´¥ï¼ŒID: ${id}`, error);
      throw new Error(`æ›´æ–°æ•…éšœç¡®è®¤çŠ¶æ€å¤±è´¥ï¼ŒID: ${id}`);
    }
  }
}

// æ·»åŠ æ°´å°æ ‡è¯†
console.info('ğŸ·ï¸ [FlawService] æ™ºèƒ½å·¡çº¿è½¦æ‰‹æŒç»ˆç«¯ - æ•…éšœç®¡ç†æœåŠ¡å·²åŠ è½½');