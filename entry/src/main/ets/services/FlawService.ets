import { HttpUtil } from '../utils/HttpUtil';
import { AppConstants } from '../constants/AppConstants';

// æ•…éšœç¼ºé™·æ¥å£å®šä¹‰
export interface AgvFlaw {
  id: number;
  taskId: number;
  round: number;
  flawType: string;
  flawName: string;
  flawDesc: string;
  flawDistance: number;
  flawImage: string;
  flawImageUrl: string;
  flawRtsp: string;
  shown: boolean;
  confirmed: boolean;
  uploaded: boolean;
  createTime: Date;
  remark?: string;
  flawLength?: number;
  flawArea?: number;
  level?: string;
  countNum?: number;
  deleteFlag?: boolean;
}

// åˆ†é¡µå‚æ•°æ¥å£
export interface FlawPageParam {
  pageNum: number;
  pageSize: number;
  taskId?: number;
  flawType?: string;
  confirmed?: boolean;
}

// åˆ†é¡µè¿”å›ç»“æœæ¥å£
export interface TableDataInfo<T> {
  total: number;
  rows: T[];
  code: number;
  msg: string;
}

/**
 * æ•…éšœç®¡ç†æœåŠ¡ç±»
 * æä¾›æ•…éšœçš„å¢åˆ æ”¹æŸ¥ã€ç¡®è®¤ç­‰åŠŸèƒ½
 */
export class FlawService {
  
  /**
   * è·å–æ•…éšœåˆ—è¡¨
   * @param params åˆ†é¡µå’Œç­›é€‰å‚æ•°
   * @returns æ•…éšœåˆ—è¡¨æ•°æ®
   */
  static async listFlaw(params: FlawPageParam): Promise<TableDataInfo<AgvFlaw>> {
    try {
      console.info('[FlawService] ğŸ” è·å–æ•…éšœåˆ—è¡¨ï¼Œå‚æ•°:', JSON.stringify(params));
      
      const queryParams = new URLSearchParams();
      queryParams.append('pageNum', params.pageNum.toString());
      queryParams.append('pageSize', params.pageSize.toString());
      
      if (params.taskId) queryParams.append('taskId', params.taskId.toString());
      if (params.flawType) queryParams.append('flawType', params.flawType);
      if (params.confirmed !== undefined) queryParams.append('confirmed', params.confirmed.toString());
      
      const response = await HttpUtil.get(`/agv/flaw/list?${queryParams.toString()}`);
      console.info('[FlawService] âœ… æ•…éšœåˆ—è¡¨è·å–æˆåŠŸï¼Œæ•°é‡:', response.data?.total || 0);
      
      return {
        total: response.data?.total || 0,
        rows: response.data?.rows || [],
        code: response.code,
        msg: response.msg
      };
    } catch (error) {
      console.error('[FlawService] âŒ è·å–æ•…éšœåˆ—è¡¨å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * è·å–æ•…éšœè¯¦æƒ…
   * @param id æ•…éšœID
   * @returns æ•…éšœè¯¦æƒ…
   */
  static async getFlaw(id: number): Promise<AgvFlaw> {
    try {
      console.info(`[FlawService] ğŸ” è·å–æ•…éšœè¯¦æƒ…ï¼ŒID: ${id}`);
      const response = await HttpUtil.get(`/agv/flaw/${id}`);
      console.info('[FlawService] âœ… æ•…éšœè¯¦æƒ…è·å–æˆåŠŸ:', response.data?.flawName || 'æœªçŸ¥æ•…éšœ');
      return response.data as AgvFlaw;
    } catch (error) {
      console.error(`[FlawService] âŒ è·å–æ•…éšœè¯¦æƒ…å¤±è´¥ï¼ŒID: ${id}`, error);
      throw error;
    }
  }
  
  /**
   * æ–°å¢æ•…éšœ
   * @param flaw æ•…éšœæ•°æ®
   * @returns åˆ›å»ºç»“æœ
   */
  static async addFlaw(flaw: Partial<AgvFlaw>): Promise<any> {
    try {
      console.info('[FlawService] ğŸ“ åˆ›å»ºæ–°æ•…éšœ:', flaw.flawName);
      const response = await HttpUtil.post('/agv/flaw', flaw);
      console.info('[FlawService] âœ… æ•…éšœåˆ›å»ºæˆåŠŸï¼ŒID:', response.data?.id);
      return response;
    } catch (error) {
      console.error('[FlawService] âŒ åˆ›å»ºæ•…éšœå¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * æ›´æ–°æ•…éšœ
   * @param flaw æ•…éšœæ•°æ®
   * @returns æ›´æ–°ç»“æœ
   */
  static async updateFlaw(flaw: Partial<AgvFlaw>): Promise<any> {
    try {
      console.info(`[FlawService] ğŸ“ æ›´æ–°æ•…éšœï¼ŒID: ${flaw.id}`);
      const response = await HttpUtil.put('/agv/flaw', flaw);
      console.info('[FlawService] âœ… æ•…éšœæ›´æ–°æˆåŠŸ');
      return response;
    } catch (error) {
      console.error(`[FlawService] âŒ æ›´æ–°æ•…éšœå¤±è´¥ï¼ŒID: ${flaw.id}`, error);
      throw error;
    }
  }
  
  /**
   * åˆ é™¤æ•…éšœ
   * @param id æ•…éšœID
   * @returns åˆ é™¤ç»“æœ
   */
  static async delFlaw(id: number): Promise<any> {
    try {
      console.info(`[FlawService] ğŸ—‘ï¸ åˆ é™¤æ•…éšœï¼ŒID: ${id}`);
      const response = await HttpUtil.delete(`/agv/flaw/${id}`);
      console.info('[FlawService] âœ… æ•…éšœåˆ é™¤æˆåŠŸ');
      return response;
    } catch (error) {
      console.error(`[FlawService] âŒ åˆ é™¤æ•…éšœå¤±è´¥ï¼ŒID: ${id}`, error);
      throw error;
    }
  }
  
  /**
   * è½®è¯¢è·å–ä»»åŠ¡å®æ—¶æ•…éšœä¿¡æ¯
   * @param taskId ä»»åŠ¡ID
   * @returns å®æ—¶æ•…éšœä¿¡æ¯
   */
  static async liveInfo(taskId: number): Promise<AgvFlaw[]> {
    try {
      console.info(`[FlawService] ğŸ”„ è½®è¯¢è·å–å®æ—¶æ•…éšœä¿¡æ¯ï¼Œä»»åŠ¡ID: ${taskId}`);
      const response = await HttpUtil.get(`/agv/flaw/live/${taskId}`);
      console.info('[FlawService] âœ… å®æ—¶æ•…éšœä¿¡æ¯è·å–æˆåŠŸï¼Œæ•°é‡:', response.data?.length || 0);
      return response.data || [];
    } catch (error) {
      console.error(`[FlawService] âŒ è·å–å®æ—¶æ•…éšœä¿¡æ¯å¤±è´¥ï¼Œä»»åŠ¡ID: ${taskId}`, error);
      throw error;
    }
  }
  
  /**
   * æ£€æŸ¥ä»»åŠ¡ç¼ºé™·æ˜¯å¦å·²å…¨éƒ¨ç¡®è®¤
   * @param taskId ä»»åŠ¡ID
   * @returns æ£€æŸ¥ç»“æœ
   */
  static async checkAllConfirmed(taskId: number): Promise<boolean> {
    try {
      console.info(`[FlawService] ğŸ” æ£€æŸ¥ä»»åŠ¡ç¼ºé™·æ˜¯å¦å·²å…¨éƒ¨ç¡®è®¤ï¼Œä»»åŠ¡ID: ${taskId}`);
      const response = await HttpUtil.get(`/agv/flaw/check/${taskId}`);
      console.info('[FlawService] âœ… æ£€æŸ¥å®Œæˆï¼Œå…¨éƒ¨ç¡®è®¤:', response.data);
      return response.data === true;
    } catch (error) {
      console.error(`[FlawService] âŒ æ£€æŸ¥ä»»åŠ¡ç¼ºé™·ç¡®è®¤çŠ¶æ€å¤±è´¥ï¼Œä»»åŠ¡ID: ${taskId}`, error);
      throw error;
    }
  }
  
  /**
   * ç¡®è®¤æ•…éšœ
   * @param id æ•…éšœID
   * @param confirmed æ˜¯å¦ç¡®è®¤
   * @param remark å¤‡æ³¨ä¿¡æ¯
   * @returns ç¡®è®¤ç»“æœ
   */
  static async confirmFlaw(id: number, confirmed: boolean, remark?: string): Promise<any> {
    try {
      console.info(`[FlawService] âœ… ç¡®è®¤æ•…éšœï¼ŒID: ${id}, ç¡®è®¤: ${confirmed}`);
      const data = {
        id: id,
        confirmed: confirmed,
        remark: remark
      };
      const response = await HttpUtil.put('/agv/flaw', data);
      console.info('[FlawService] âœ… æ•…éšœç¡®è®¤çŠ¶æ€æ›´æ–°æˆåŠŸ');
      return response;
    } catch (error) {
      console.error(`[FlawService] âŒ æ›´æ–°æ•…éšœç¡®è®¤çŠ¶æ€å¤±è´¥ï¼ŒID: ${id}`, error);
      throw error;
    }
  }
}

// æ·»åŠ æ°´å°æ ‡è¯†
console.info('ğŸ·ï¸ [FlawService] æ™ºèƒ½å·¡çº¿è½¦æ‰‹æŒç»ˆç«¯ - æ•…éšœç®¡ç†æœåŠ¡å·²åŠ è½½');