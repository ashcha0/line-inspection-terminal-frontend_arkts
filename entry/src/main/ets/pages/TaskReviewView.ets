import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import http from '@ohos.net.http';
import { AppConstants } from '../constants/AppConstants';

// ä»»åŠ¡è¯¦æƒ…æ¥å£
interface TaskDetail {
  id: number;
  taskCode: string;
  taskName: string;
  startPos: string;
  taskTrip: string;
  creator: string;
  executor: string;
  execTime: string;
  endTime: string;
  createTime: string;
  taskStatus: string;
  round: number;
  uploaded: boolean;
  remark: string;
  cloudTaskId: number;
}

// æ•…éšœä¿¡æ¯æ¥å£
interface FlawInfo {
  id: number;
  taskId: number;
  round: number;
  flawType: string;
  flawName: string;
  flawDesc: string;
  flawDistance: number;
  flawImage: string;
  flawImageUrl: string;
  flawRtsp: string;
  shown: boolean;
  confirmed: boolean;
  uploaded: boolean;
  createTime: string;
  remark: string;
  flawLength: number;
  flawArea: number;
  level: string;
  countNum: number;
}

// ä¸Šä¼ ä¿¡æ¯æ¥å£
interface UploadInfo {
  info: string;
  type: string;
  status: string;
}

// ä¸Šä¼ è¿›åº¦æ¥å£
interface UploadProgress {
  percentage: number;
  completed: number;
  total: number;
  current: string;
}

@Entry
@Component
struct TaskReviewView {
  @State taskId: number = 0;
  @State taskDetail: TaskDetail | null = null;
  @State flaws: FlawInfo[] = [];
  @State loading: boolean = true;
  @State uploading: boolean = false;
  @State uploadProgress: UploadProgress = {
    percentage: 0,
    completed: 0,
    total: 0,
    current: ''
  };
  @State showFlawDetail: boolean = false;
  @State selectedFlaw: FlawInfo | null = null;
  @State showRemarkDialog: boolean = false;
  @State editingRemark: string = '';
  @State uploadInfoList: UploadInfo[] = [];
  
  // æ•…éšœè¯¦æƒ…å¯¹è¯æ¡†æ§åˆ¶å™¨
  flawDetailDialogController: CustomDialogController = new CustomDialogController({
    builder: FlawDetailDialog({
      selectedFlaw: $selectedFlaw,
      getFlawLevelColor: (level: string) => this.getFlawLevelColor(level)
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: true
  });
  
  // ç¼ºé™·æè¿°ç¼–è¾‘å¯¹è¯æ¡†æ§åˆ¶å™¨
  remarkDialogController: CustomDialogController = new CustomDialogController({
    builder: RemarkEditDialog({
      editingRemark: $editingRemark,
      onSave: () => {
        this.saveRemark();
      },
      onCancel: () => {
        this.closeRemarkDialog();
      }
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: true
  });

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params && params['taskId']) {
      this.taskId = params['taskId'] as number;
      this.loadData();
    }
  }

  // åŠ è½½æ•°æ®
  async loadData() {
    try {
      this.loading = true;
      console.log('[TaskReviewView] å¼€å§‹åŠ è½½æ•°æ®ï¼Œä»»åŠ¡ID:', this.taskId);
      
      await Promise.all([
        this.loadTaskDetail(),
        this.loadFlaws()
      ]);
    } catch (error) {
      console.error('[TaskReviewView] åŠ è½½æ•°æ®å¤±è´¥:', error);
      promptAction.showToast({
        message: 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 3000
      });
    } finally {
      this.loading = false;
    }
  }

  // åŠ è½½ä»»åŠ¡è¯¦æƒ…
  async loadTaskDetail() {
    try {
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(`${AppConstants.API_BASE_URL}/agv/task/${this.taskId}`);
      
      if (response.responseCode === 200) {
        const data: Record<string, Object> = JSON.parse(response.result as string);
        if (data.code === 200) {
          this.taskDetail = data.data as TaskDetail;
          console.log('[TaskReviewView] ä»»åŠ¡è¯¦æƒ…åŠ è½½æˆåŠŸ:', this.taskDetail);
        } else {
          throw new Error((data.msg as string) || 'è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥');
        }
      } else {
        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
      }
    } catch (error) {
      console.error('[TaskReviewView] åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
      throw new Error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥');
    }
  }

  // åŠ è½½æ•…éšœåˆ—è¡¨
  async loadFlaws() {
    try {
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(`${AppConstants.API_BASE_URL}/agv/flaw/list?taskId=${this.taskId}`);
      
      if (response.responseCode === 200) {
        const data: Record<string, Object> = JSON.parse(response.result as string);
        if (data.code === 200) {
          this.flaws = (data.rows as FlawInfo[]) || [];
          console.log('[TaskReviewView] æ•…éšœåˆ—è¡¨åŠ è½½æˆåŠŸï¼Œæ•°é‡:', this.flaws.length);
        } else {
          throw new Error((data.msg as string) || 'è·å–æ•…éšœåˆ—è¡¨å¤±è´¥');
        }
      } else {
        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
      }
    } catch (error) {
      console.error('[TaskReviewView] åŠ è½½æ•…éšœåˆ—è¡¨å¤±è´¥:', error);
      throw new Error('åŠ è½½æ•…éšœåˆ—è¡¨å¤±è´¥');
    }
  }

  // æ‰“å¼€æ•…éšœè¯¦æƒ…
  async openFlawDetail(flaw: FlawInfo) {
    try {
      console.log('[TaskReviewView] ğŸ” å¼€å§‹è·å–æ•…éšœè¯¦æƒ…ï¼ŒID:', flaw.id, 'æ•…éšœåç§°:', flaw.flawName);
      
      // è°ƒç”¨æ¥å£è·å–å®Œæ•´çš„æ•…éšœè¯¦æƒ…
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(
        `${AppConstants.API_BASE_URL}/agv/flaw/${flaw.id}`,
        {
          method: http.RequestMethod.GET,
          header: {
            'Content-Type': 'application/json'
          }
        }
      );

      console.log('[TaskReviewView] ğŸ“¡ æ•…éšœè¯¦æƒ…è¯·æ±‚å“åº”ç :', response.responseCode);
      console.log('[TaskReviewView] ğŸ“¡ æ•…éšœè¯¦æƒ…è¯·æ±‚å“åº”å†…å®¹:', response.result);

      if (response.responseCode === 200) {
        const data: Record<string, Object> = JSON.parse(response.result as string);
        console.log('[TaskReviewView] ğŸ“Š è§£æåçš„å“åº”æ•°æ®:', JSON.stringify(data));
        
        if (data.code === 200) {
          // ä½¿ç”¨æ¥å£è¿”å›çš„å®Œæ•´æ•…éšœä¿¡æ¯
          this.selectedFlaw = data.data as FlawInfo;
          console.log('[TaskReviewView] ğŸ“‹ è·å–åˆ°çš„å®Œæ•´æ•…éšœè¯¦æƒ…:', JSON.stringify({
            id: this.selectedFlaw.id,
            flawName: this.selectedFlaw.flawName,
            flawType: this.selectedFlaw.flawType,
            level: this.selectedFlaw.level,
            flawDesc: this.selectedFlaw.flawDesc,
            remark: this.selectedFlaw.remark,
            flawImageUrl: this.selectedFlaw.flawImageUrl,
            confirmed: this.selectedFlaw.confirmed,
            createTime: this.selectedFlaw.createTime,
            flawDistance: this.selectedFlaw.flawDistance
          }));
          
          // é˜²æ­¢é‡å¤å¼¹çª—ï¼šæ£€æŸ¥å¼¹çª—æ˜¯å¦å·²ç»æ‰“å¼€
          if (!this.flawDetailDialogController) {
            console.warn('[TaskReviewView] âš ï¸ æ•…éšœè¯¦æƒ…å¼¹çª—æ§åˆ¶å™¨æœªåˆå§‹åŒ–');
            return;
          }
          
          this.flawDetailDialogController.open();
          console.log('[TaskReviewView] âœ… æ•…éšœè¯¦æƒ…å¼¹çª—å·²æ‰“å¼€ï¼ŒID:', flaw.id);
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          promptAction.showToast({
            message: 'æ•…éšœè¯¦æƒ…åŠ è½½æˆåŠŸ',
            duration: 1500
          });
        } else {
          console.error('[TaskReviewView] âŒ æ¥å£è¿”å›é”™è¯¯:', data.msg);
          throw new Error((data.msg as string) || 'è·å–æ•…éšœè¯¦æƒ…å¤±è´¥');
        }
      } else {
        console.error('[TaskReviewView] âŒ HTTPè¯·æ±‚å¤±è´¥ï¼Œå“åº”ç :', response.responseCode);
        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
      }
    } catch (error) {
      console.error('[TaskReviewView] âŒ è·å–æ•…éšœè¯¦æƒ…å¤±è´¥:', error);
      // é™çº§å¤„ç†ï¼šä½¿ç”¨ä¼ å…¥çš„æ•…éšœä¿¡æ¯ï¼Œä½†ä¸é‡å¤æ‰“å¼€å¼¹çª—
      this.selectedFlaw = flaw;
      console.log('[TaskReviewView] ğŸ”„ ä½¿ç”¨åŸºæœ¬æ•…éšœä¿¡æ¯æ˜¾ç¤ºè¯¦æƒ…:', JSON.stringify({
        id: flaw.id,
        flawName: flaw.flawName,
        flawType: flaw.flawType,
        level: flaw.level
      }));
      
      // åªæœ‰åœ¨æˆåŠŸè·å–æ•°æ®æ—¶æ‰æ‰“å¼€å¼¹çª—ï¼Œé¿å…é‡å¤æ˜¾ç¤º
      // this.flawDetailDialogController.open();
      // console.log('[TaskReviewView] ğŸ”„ åŸºæœ¬æ•…éšœä¿¡æ¯å¼¹çª—å·²æ‰“å¼€');
      
      promptAction.showToast({
        message: 'è·å–è¯¦ç»†ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  // å…³é—­æ•…éšœè¯¦æƒ…
  closeFlawDetail() {
    this.flawDetailDialogController.close();
    this.selectedFlaw = null;
  }

  // æ‰“å¼€ç¼ºé™·æè¿°ç¼–è¾‘å¯¹è¯æ¡†
  openRemarkDialog(flaw: FlawInfo) {
    console.log('[TaskReviewView] ğŸ“ æ‰“å¼€ç¼ºé™·æè¿°ç¼–è¾‘å¯¹è¯æ¡†ï¼ŒID:', flaw.id);
    
    this.selectedFlaw = flaw;
    this.editingRemark = flaw.flawDesc || ''; // å›æ˜¾å½“å‰çš„ç¼ºé™·æè¿°
    this.remarkDialogController.open();
    console.log('[TaskReviewView] ğŸ“ ç¼ºé™·æè¿°ç¼–è¾‘å¯¹è¯æ¡†å·²æ‰“å¼€ï¼Œå½“å‰æè¿°:', this.editingRemark);
  }

  // å…³é—­å¤‡æ³¨ç¼–è¾‘å¯¹è¯æ¡†
  closeRemarkDialog() {
    this.remarkDialogController.close();
    this.selectedFlaw = null;
    this.editingRemark = '';
  }

  // ä¿å­˜ç¼ºé™·æè¿°
  async saveRemark() {
    if (!this.selectedFlaw) return;

    try {
      console.log('[TaskReviewView] ğŸ“ å¼€å§‹ä¿å­˜ç¼ºé™·æè¿°ï¼ŒID:', this.selectedFlaw.id);
      
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(
        `${AppConstants.API_BASE_URL}/agv/flaw`,
        {
          method: http.RequestMethod.PUT,
          header: {
            'Content-Type': 'application/json'
          },
          extraData: JSON.stringify({
            id: this.selectedFlaw!.id,
            flawName: this.selectedFlaw!.flawName,
            flawType: this.selectedFlaw!.flawType,
            level: this.selectedFlaw!.level,
            flawDesc: this.editingRemark, // æ›´æ–°ç¼ºé™·æè¿°
            flawImageUrl: this.selectedFlaw!.flawImageUrl,
            confirmed: this.selectedFlaw!.confirmed,
            remark: this.selectedFlaw!.remark // ä¿æŒåŸæœ‰å¤‡æ³¨ä¸å˜
          })
        }
      );

      if (response.responseCode === 200) {
        const data: Record<string, Object> = JSON.parse(response.result as string);
        if (data.code === 200) {
          // åœ¨UIçº¿ç¨‹ä¸­æ›´æ–°æœ¬åœ°æ•°æ®
          setTimeout(() => {
            try {
              const index = this.flaws.findIndex(f => f.id === this.selectedFlaw!.id);
              if (index !== -1) {
                this.flaws[index].flawDesc = this.editingRemark;
              }
              this.selectedFlaw!.flawDesc = this.editingRemark;
              
              // é‡æ–°åŠ è½½æ•…éšœåˆ—è¡¨ä»¥ç¡®ä¿æ•°æ®åŒæ­¥
              this.loadFlaws();
              this.closeRemarkDialog();
              promptAction.showToast({
                message: 'ç¼ºé™·æè¿°ä¿å­˜æˆåŠŸ',
                duration: 2000
              });
              console.log('[TaskReviewView] âœ… ç¼ºé™·æè¿°ä¿å­˜æˆåŠŸï¼ŒID:', this.selectedFlaw!.id);
            } catch (uiError) {
              console.error('[TaskReviewView] âŒ UIæ›´æ–°å¤±è´¥:', uiError);
            }
          }, 0);
        } else {
          throw new Error((data.msg as string) || 'ä¿å­˜ç¼ºé™·æè¿°å¤±è´¥');
        }
      } else {
        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
      }
    } catch (error) {
      console.error('[TaskReviewView] âŒ ä¿å­˜ç¼ºé™·æè¿°å¤±è´¥:', error);
      // åœ¨UIçº¿ç¨‹ä¸­æ˜¾ç¤ºé”™è¯¯æç¤º
      setTimeout(() => {
        try {
          promptAction.showToast({
            message: 'ä¿å­˜ç¼ºé™·æè¿°å¤±è´¥ï¼Œè¯·é‡è¯•',
            duration: 3000
          });
        } catch (uiError) {
          console.error('[TaskReviewView] âŒ æ˜¾ç¤ºé”™è¯¯æç¤ºå¤±è´¥:', uiError);
        }
      }, 0);
    }
  }

  // ç¡®è®¤æ•…éšœ
  async confirmFlaw(flaw: FlawInfo) {
    try {
      console.log('[TaskReviewView] ğŸ”§ å¼€å§‹ç¡®è®¤æ•…éšœï¼ŒID:', flaw.id);
      
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(
        `${AppConstants.API_BASE_URL}/agv/flaw`,
        {
          method: http.RequestMethod.PUT,
          header: {
            'Content-Type': 'application/json'
          },
          extraData: JSON.stringify({
            id: flaw.id,
            flawName: flaw.flawName,
            flawType: flaw.flawType,
            level: flaw.level,
            flawDesc: flaw.flawDesc,
            flawImageUrl: flaw.flawImageUrl,
            remark: flaw.remark,
            confirmed: true
          })
        }
      );

      if (response.responseCode === 200) {
        const data: Record<string, Object> = JSON.parse(response.result as string);
        if (data.code === 200) {
          console.log('[TaskReviewView] âœ… æ•…éšœç¡®è®¤APIè°ƒç”¨æˆåŠŸï¼ŒID:', flaw.id);
          
          // ä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿç¡®ä¿åœ¨UIçº¿ç¨‹ä¸­æ‰§è¡Œ
          setTimeout(async () => {
            try {
              // å…ˆæ›´æ–°æœ¬åœ°æ•°æ®
              const index = this.flaws.findIndex(f => f.id === flaw.id);
              if (index !== -1) {
                this.flaws[index].confirmed = true;
              }
              
              // é‡æ–°åŠ è½½æ•…éšœåˆ—è¡¨ä»¥ç¡®ä¿æ•°æ®åŒæ­¥
              await this.loadFlaws();
              
              // æ˜¾ç¤ºæˆåŠŸæç¤º
              promptAction.showToast({
                message: 'æ•…éšœç¡®è®¤æˆåŠŸ',
                duration: 2000
              });
              
              console.log('[TaskReviewView] âœ… æ•…éšœç¡®è®¤å®Œæˆï¼Œåˆ—è¡¨å·²åˆ·æ–°ï¼ŒID:', flaw.id);
            } catch (uiError) {
              console.error('[TaskReviewView] âŒ UIæ›´æ–°å¤±è´¥:', uiError);
              // å¦‚æœUIæ›´æ–°å¤±è´¥ï¼Œè‡³å°‘æ˜¾ç¤ºæˆåŠŸæç¤º
              try {
                promptAction.showToast({
                  message: 'æ•…éšœç¡®è®¤æˆåŠŸï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢',
                  duration: 3000
                });
              } catch (toastError) {
                console.error('[TaskReviewView] âŒ æ˜¾ç¤ºæç¤ºå¤±è´¥:', toastError);
              }
            }
          }, 100); // å¢åŠ å»¶è¿Ÿæ—¶é—´
        } else {
          throw new Error((data.msg as string) || 'ç¡®è®¤æ•…éšœå¤±è´¥');
        }
      } else {
        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
      }
    } catch (error) {
      console.error('[TaskReviewView] âŒ ç¡®è®¤æ•…éšœå¤±è´¥:', error);
      // åœ¨UIçº¿ç¨‹ä¸­æ˜¾ç¤ºé”™è¯¯æç¤º
      setTimeout(() => {
        try {
          promptAction.showToast({
            message: 'ç¡®è®¤æ•…éšœå¤±è´¥ï¼Œè¯·é‡è¯•',
            duration: 3000
          });
        } catch (uiError) {
          console.error('[TaskReviewView] âŒ æ˜¾ç¤ºé”™è¯¯æç¤ºå¤±è´¥:', uiError);
        }
      }, 0);
    }
  }

  // è·å–ä¸Šä¼ æ•°æ®ä¿¡æ¯
  async getUploadInfo() {
    try {
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(`${AppConstants.API_BASE_URL}/agv/task/preupload/${this.taskId}`);
      
      if (response.responseCode === 200) {
        const data: Record<string, Object> = JSON.parse(response.result as string);
        if (data.code === 200) {
          this.uploadInfoList = (data.data as UploadInfo[]) || [];
          console.log('[TaskReviewView] è·å–ä¸Šä¼ ä¿¡æ¯æˆåŠŸï¼Œæ•°é‡:', this.uploadInfoList.length);
          return this.uploadInfoList;
        } else {
          throw new Error((data.msg as string) || 'è·å–ä¸Šä¼ ä¿¡æ¯å¤±è´¥');
        }
      } else {
        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
      }
    } catch (error) {
      console.error('[TaskReviewView] è·å–ä¸Šä¼ ä¿¡æ¯å¤±è´¥:', error);
      throw new Error('è·å–ä¸Šä¼ ä¿¡æ¯å¤±è´¥');
    }
  }

  // ä¸Šä¼ å·¡æ£€è®°å½•
  async uploadInspectionRecord() {
    try {
      this.uploading = true;
      this.uploadProgress = {
        percentage: 0,
        completed: 0,
        total: 100,
        current: 'å‡†å¤‡ä¸Šä¼ ...'
      };

      // è·å–ä¸Šä¼ ä¿¡æ¯
      const uploadList = await this.getUploadInfo();
      if (uploadList.length === 0) {
        promptAction.showToast({
          message: 'æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„æ•°æ®',
          duration: 2000
        });
        this.uploading = false;
        return;
      }

      this.uploadProgress.total = uploadList.length;
      console.log('[TaskReviewView] å¼€å§‹ä¸Šä¼ ï¼Œæ€»æ•°:', uploadList.length);

      // æ‰§è¡Œä¸Šä¼ 
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(
        `${AppConstants.API_BASE_URL}/agv/task/upload/${this.taskId}`,
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json'
          }
        }
      );

      if (response.responseCode === 200) {
        const data: Record<string, Object> = JSON.parse(response.result as string);
        if (data.code === 200) {
          // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
          for (let i = 0; i < uploadList.length; i++) {
            this.uploadProgress.completed = i + 1;
            this.uploadProgress.percentage = Math.round((i + 1) / uploadList.length * 100);
            this.uploadProgress.current = `æ­£åœ¨ä¸Šä¼ : ${uploadList[i].info}`;
            
            // æ¨¡æ‹Ÿä¸Šä¼ å»¶è¿Ÿ
            await new Promise<void>(resolve => setTimeout(resolve, 500));
          }

          // æ›´æ–°ä»»åŠ¡çŠ¶æ€
          if (this.taskDetail) {
            this.taskDetail.uploaded = true;
            this.taskDetail.taskStatus = 'å·²å®Œæˆ';
          }

          console.log('[TaskReviewView] âœ… ä¸Šä¼ å®Œæˆ');
          
          // æ˜¾ç¤ºæˆåŠŸå¯¹è¯æ¡†å¹¶è·³è½¬
          setTimeout(() => {
            try {
              promptAction.showDialog({
                title: 'ä¸Šä¼ æˆåŠŸ',
                message: 'å·¡æ£€è®°å½•å·²æˆåŠŸä¸Šä¼ ï¼Œä»»åŠ¡å·²å®Œæˆï¼',
                buttons: [
                  {
                    text: 'ç¡®å®š',
                    color: AppConstants.COLORS.PRIMARY
                  }
                ]
              }).then(() => {
                // è·³è½¬å›ä»»åŠ¡åˆ—è¡¨é¡µé¢
                router.replaceUrl({
                  url: 'pages/TaskView'
                }).catch((error: Error) => {
                  console.error('[TaskReviewView] âŒ è·³è½¬ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                  // å¦‚æœè·³è½¬å¤±è´¥ï¼Œå°è¯•è¿”å›ä¸Šä¸€é¡µ
                  router.back();
                });
              }).catch((error: Error) => {
                console.error('[TaskReviewView] âŒ æ˜¾ç¤ºæˆåŠŸå¯¹è¯æ¡†å¤±è´¥:', error);
                // å¦‚æœå¯¹è¯æ¡†å¤±è´¥ï¼Œç›´æ¥è·³è½¬
                router.replaceUrl({ url: 'pages/TaskView' }).catch(() => {
                  router.back();
                });
              });
            } catch (error) {
              console.error('[TaskReviewView] âŒ å¤„ç†ä¸Šä¼ æˆåŠŸé€»è¾‘å¤±è´¥:', error);
              // é™çº§å¤„ç†ï¼šæ˜¾ç¤ºToastå¹¶è·³è½¬
              promptAction.showToast({
                message: 'ä¸Šä¼ å®Œæˆï¼Œæ­£åœ¨è¿”å›ä»»åŠ¡åˆ—è¡¨...',
                duration: 2000
              });
              setTimeout(() => {
                router.replaceUrl({ url: 'pages/TaskView' }).catch(() => {
                  router.back();
                });
              }, 2000);
            }
          }, 100);
        } else {
          throw new Error((data.msg as string) || 'ä¸Šä¼ å¤±è´¥');
        }
      } else {
        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
      }
    } catch (error) {
      console.error('[TaskReviewView] ä¸Šä¼ å¤±è´¥:', error);
      promptAction.showToast({
        message: 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 3000
      });
    } finally {
      this.uploading = false;
    }
  }

  // è·å–æ•…éšœçŠ¶æ€é¢œè‰²
  getFlawStatusColor(confirmed: boolean): string {
    return confirmed ? AppConstants.COLORS.SUCCESS : AppConstants.COLORS.WARNING;
  }

  // è·å–æ•…éšœçŠ¶æ€æ–‡æœ¬
  getFlawStatusText(confirmed: boolean): string {
    return confirmed ? 'å·²ç¡®è®¤' : 'å¾…ç¡®è®¤';
  }

  // è·å–æ•…éšœç­‰çº§é¢œè‰²
  getFlawLevelColor(level: string): string {
    switch (level) {
      case 'ä¸¥é‡':
        return AppConstants.COLORS.DANGER;
      case 'ä¸€èˆ¬':
        return AppConstants.COLORS.WARNING;
      case 'è½»å¾®':
        return AppConstants.COLORS.INFO;
      default:
        return AppConstants.COLORS.TEXT_REGULAR;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#ffffff')
        }
        .backgroundColor('transparent')
        .onClick(() => {
          router.back();
        })
        
        Text('ä»»åŠ¡å¤ç›˜')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#ffffff')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Button() {
          Text('è®¾ç½®')
            .fontSize(14)
            .fontColor('#ffffff')
        }
        .backgroundColor('transparent')
        .onClick(() => {
          router.pushUrl({ url: 'pages/SettingsView' });
        })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(AppConstants.COLORS.PRIMARY)
      
      if (this.loading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(48)
            .height(48)
            .color(AppConstants.COLORS.PRIMARY)
            .margin({ bottom: 16 })
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor(AppConstants.COLORS.BACKGROUND_BASE)
        
      } else {
        // ä¸»è¦å†…å®¹
        Scroll() {
          Column() {
            // ä»»åŠ¡ä¿¡æ¯å¡ç‰‡
            if (this.taskDetail) {
              Column() {
                Row() {
                  Text('ä»»åŠ¡ä¿¡æ¯')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  
                  Blank()
                  
                  Text(this.taskDetail.taskStatus)
                    .fontSize(12)
                    .fontColor('#ffffff')
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .backgroundColor(this.taskDetail.uploaded ? AppConstants.COLORS.SUCCESS : AppConstants.COLORS.WARNING)
                    .borderRadius(4)
                }
                .width('100%')
                .margin({ bottom: 16 })
                
                Column() {
                  Row() {
                    Text('ä»»åŠ¡åç§°:')
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                      .width(80)
                    
                    Text(this.taskDetail.taskName)
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                      .layoutWeight(1)
                  }
                  .width('100%')
                  .margin({ bottom: 8 })
                  
                  Row() {
                    Text('ä»»åŠ¡ç¼–å·:')
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                      .width(80)
                    
                    Text(this.taskDetail.taskCode)
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                      .layoutWeight(1)
                  }
                  .width('100%')
                  .margin({ bottom: 8 })
                  
                  Row() {
                    Text('æ‰§è¡Œäºº:')
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                      .width(80)
                    
                    Text(this.taskDetail.executor)
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                      .layoutWeight(1)
                  }
                  .width('100%')
                  .margin({ bottom: 8 })
                  
                  Row() {
                    Text('å®Œæˆæ—¶é—´:')
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                      .width(80)
                    
                    Text(this.taskDetail.endTime)
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                      .layoutWeight(1)
                  }
                  .width('100%')
                }
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#ffffff')
              .borderRadius(8)
              .margin({ bottom: 16 })
            }
            
            // æ•…éšœåˆ—è¡¨
            Column() {
              Row() {
                Text(`å‘ç°æ•…éšœ (${this.flaws.length})`)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                
                Blank()
                
                Text('è¯·ç¡®è®¤æ•…éšœä¿¡æ¯')
                  .fontSize(12)
                  .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
              }
              .width('100%')
              .margin({ bottom: 12 })
              
              if (this.flaws.length === 0) {
                Column() {
                  Text('ğŸ‰')
                    .fontSize(32)
                    .margin({ bottom: 8 })
                  
                  Text('æœ¬æ¬¡å·¡æ£€æœªå‘ç°æ•…éšœ')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                }
                .width('100%')
                .height(120)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
                .backgroundColor('#f8f9fa')
                .borderRadius(8)
              } else {
                ForEach(this.flaws, (flaw: FlawInfo) => {
                  Column() {
                    Row() {
                      Column() {
                        Text(flaw.flawName)
                          .fontSize(14)
                          .fontWeight(FontWeight.Medium)
                          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                          .margin({ bottom: 4 })
                        
                        Row() {
                          Text(flaw.flawType)
                            .fontSize(12)
                            .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
                          
                          Text('|')
                            .fontSize(12)
                            .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
                            .margin({ left: 8, right: 8 })
                          
                          Text(flaw.level)
                            .fontSize(12)
                            .fontColor(this.getFlawLevelColor(flaw.level))
                        }
                      }
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)
                      
                      Column() {
                        Text(this.getFlawStatusText(flaw.confirmed))
                          .fontSize(12)
                          .fontColor(this.getFlawStatusColor(flaw.confirmed))
                          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                          .backgroundColor(this.getFlawStatusColor(flaw.confirmed) + '20')
                          .borderRadius(4)
                      }
                    }
                    .width('100%')
                    .margin({ bottom: 12 })
                    
                    // æ“ä½œæŒ‰é’®
                    Row() {
                      Button('æŸ¥çœ‹è¯¦æƒ…')
                        .fontSize(12)
                        .fontColor(AppConstants.COLORS.PRIMARY)
                        .backgroundColor('transparent')
                        .border({ width: 1, color: AppConstants.COLORS.PRIMARY })
                        .borderRadius(4)
                        .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                        .onClick(() => {
                          this.openFlawDetail(flaw);
                        })
                      
                      Button('ç¼–è¾‘æè¿°')
                        .fontSize(12)
                        .fontColor(AppConstants.COLORS.WARNING)
                        .backgroundColor('transparent')
                        .border({ width: 1, color: AppConstants.COLORS.WARNING })
                        .borderRadius(4)
                        .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                        .margin({ left: 8 })
                        .onClick(() => {
                          this.openRemarkDialog(flaw);
                        })
                      
                      if (!flaw.confirmed) {
                        Button('ç¡®è®¤æ•…éšœ')
                          .fontSize(12)
                          .fontColor('#ffffff')
                          .backgroundColor(AppConstants.COLORS.SUCCESS)
                          .borderRadius(4)
                          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                          .margin({ left: 8 })
                          .onClick(() => {
                            this.confirmFlaw(flaw);
                          })
                      }
                    }
                    .width('100%')
                    .justifyContent(FlexAlign.Start)
                  }
                  .width('100%')
                  .padding(16)
                  .backgroundColor('#ffffff')
                  .borderRadius(8)
                  .margin({ bottom: 12 })
                }, (flaw: FlawInfo) => flaw.id.toString())
              }
            }
            .width('100%')
            .margin({ bottom: 24 })
            
            // ä¸Šä¼ æŒ‰é’®
            if (!this.uploading) {
              Button('ä¸Šä¼ å·¡æ£€è®°å½•')
                .fontSize(16)
                .fontColor('#ffffff')
                .backgroundColor(AppConstants.COLORS.PRIMARY)
                .width('100%')
                .height(48)
                .borderRadius(8)
                .onClick(() => {
                  this.uploadInspectionRecord();
                })
            } else {
              // ä¸Šä¼ è¿›åº¦
              Column() {
                Row() {
                  Text('ä¸Šä¼ è¿›åº¦')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  
                  Blank()
                  
                  Text(`${this.uploadProgress.percentage}%`)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.PRIMARY)
                }
                .width('100%')
                .margin({ bottom: 8 })
                
                Progress({
                  value: this.uploadProgress.completed,
                  total: this.uploadProgress.total,
                  type: ProgressType.Linear
                })
                .width('100%')
                .height(6)
                .color(AppConstants.COLORS.PRIMARY)
                .margin({ bottom: 8 })
                
                Text(`æ­£åœ¨ä¸Šä¼ : ${this.uploadProgress.current}`)
                  .fontSize(12)
                  .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
                  .width('100%')
                  .textAlign(TextAlign.Start)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#ffffff')
              .borderRadius(8)
            }
          }
          .width('100%')
          .padding(16)
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor(AppConstants.COLORS.BACKGROUND_BASE)
      }
    }
    .width('100%')
    .height('100%')
  }

}

// æ•…éšœè¯¦æƒ…å¯¹è¯æ¡†ç»„ä»¶
@CustomDialog
struct FlawDetailDialog {
  @Link selectedFlaw: FlawInfo | null;
  getFlawLevelColor: (level: string) => string = () => AppConstants.COLORS.TEXT_PRIMARY;
  controller: CustomDialogController = new CustomDialogController({builder: FlawDetailDialog()});

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('æ•…éšœè¯¦æƒ…')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .layoutWeight(1)
        
        Button('Ã—')
          .fontSize(20)
          .fontColor(AppConstants.COLORS.TEXT_REGULAR)
          .backgroundColor('transparent')
          .width(32)
          .height(32)
          .onClick(() => {
            this.controller.close();
          })
      }
      .width('100%')
      .margin({ bottom: 20 })
      
      if (this.selectedFlaw) {
        Scroll() {
          Column() {
            // æ•…éšœåŸºæœ¬ä¿¡æ¯
            Column() {
              Row() {
                Text('æ•…éšœåç§°:')
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                  .width(80)
                
                Text(this.selectedFlaw.flawName)
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 8 })
              
              Row() {
                Text('æ•…éšœç±»å‹:')
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                  .width(80)
                
                Text(this.selectedFlaw.flawType)
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 8 })
              
              Row() {
                Text('æ•…éšœç­‰çº§:')
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                  .width(80)
                
                Text(this.selectedFlaw.level)
                  .fontSize(14)
                  .fontColor(this.getFlawLevelColor(this.selectedFlaw.level))
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 8 })
              
              Row() {
                Text('æ•…éšœæè¿°:')
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                  .width(80)
                
                Text(this.selectedFlaw.flawDesc || 'æš‚æ— æè¿°')
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 8 })
              
              if (this.selectedFlaw.flawDistance !== undefined) {
                Row() {
                  Text('æ•…éšœè·ç¦»:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  
                  Text(`${this.selectedFlaw.flawDistance}m`)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                    .layoutWeight(1)
                }
                .width('100%')
                .margin({ bottom: 8 })
              }
              
              if (this.selectedFlaw.flawLength !== undefined) {
                Row() {
                  Text('æ•…éšœé•¿åº¦:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  
                  Text(`${this.selectedFlaw.flawLength}m`)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                    .layoutWeight(1)
                }
                .width('100%')
                .margin({ bottom: 8 })
              }
              
              if (this.selectedFlaw.flawArea !== undefined) {
                Row() {
                  Text('æ•…éšœé¢ç§¯:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  
                  Text(`${this.selectedFlaw.flawArea}ã¡`)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                    .layoutWeight(1)
                }
                .width('100%')
                .margin({ bottom: 8 })
              }
              
              if (this.selectedFlaw.countNum !== undefined) {
                Row() {
                  Text('æ•…éšœæ•°é‡:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  
                  Text(`${this.selectedFlaw.countNum}ä¸ª`)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                    .layoutWeight(1)
                }
                .width('100%')
                .margin({ bottom: 8 })
              }
              
              if (this.selectedFlaw.createTime) {
                Row() {
                  Text('å‘ç°æ—¶é—´:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  
                  Text(this.selectedFlaw.createTime)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                    .layoutWeight(1)
                }
                .width('100%')
                .margin({ bottom: 8 })
              }
              
              Row() {
                Text('ç¡®è®¤çŠ¶æ€:')
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                  .width(80)
                
                Text(this.selectedFlaw.confirmed ? 'å·²ç¡®è®¤' : 'å¾…ç¡®è®¤')
                  .fontSize(14)
                  .fontColor(this.selectedFlaw.confirmed ? AppConstants.COLORS.SUCCESS : AppConstants.COLORS.WARNING)
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 8 })
              
              if (this.selectedFlaw.remark) {
                Row() {
                  Text('å¤‡æ³¨ä¿¡æ¯:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  
                  Text(this.selectedFlaw.remark)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                    .layoutWeight(1)
                }
                .width('100%')
                .margin({ bottom: 16 })
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#ffffff')
            .borderRadius(8)
            .margin({ bottom: 16 })
            
            // æ•…éšœå›¾ç‰‡
            if (this.selectedFlaw.flawImageUrl) {
              Column() {
                Text('æ•…éšœå›¾ç‰‡')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .margin({ bottom: 12 })
                
                Image(this.selectedFlaw.flawImageUrl)
                  .width('100%')
                  .height(200)
                  .objectFit(ImageFit.Contain)
                  .borderRadius(8)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#ffffff')
              .borderRadius(8)
            }
          }
        }
        .layoutWeight(1)
      }
    }
    .width('90%')
    .height('80%')
    .padding(20)
    .backgroundColor(AppConstants.COLORS.BACKGROUND_BASE)
    .borderRadius(12)
  }
}

// ç¼ºé™·æè¿°ç¼–è¾‘å¯¹è¯æ¡†ç»„ä»¶
@CustomDialog
struct RemarkEditDialog {
  @Link editingRemark: string;
  onSave: () => void = () => {};
  onCancel: () => void = () => {};
  controller: CustomDialogController = new CustomDialogController({builder: RemarkEditDialog()});

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ç¼–è¾‘ç¼ºé™·æè¿°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .layoutWeight(1)
        
        Button('Ã—')
          .fontSize(20)
          .fontColor(AppConstants.COLORS.TEXT_REGULAR)
          .backgroundColor('transparent')
          .width(32)
          .height(32)
          .onClick(() => {
            this.onCancel();
          })
      }
      .width('100%')
      .margin({ bottom: 20 })
      
      TextArea({ placeholder: 'è¯·è¾“å…¥ç¼ºé™·æè¿°...', text: this.editingRemark })
        .width('100%')
        .height(120)
        .fontSize(14)
        .borderRadius(8)
        .backgroundColor('#ffffff')
        .onChange((value: string) => {
          this.editingRemark = value;
        })
        .margin({ bottom: 20 })
      
      Row() {
        Button('å–æ¶ˆ')
          .fontSize(16)
          .fontColor(AppConstants.COLORS.TEXT_REGULAR)
          .backgroundColor('transparent')
          .border({ width: 1, color: AppConstants.COLORS.BORDER_BASE })
          .borderRadius(8)
          .width('48%')
          .height(44)
          .onClick(() => {
            this.onCancel();
          })
        
        Button('ä¿å­˜')
          .fontSize(16)
          .fontColor('#ffffff')
          .backgroundColor(AppConstants.COLORS.PRIMARY)
          .borderRadius(8)
          .width('48%')
          .height(44)
          .onClick(() => {
            this.onSave();
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('90%')
    .padding(20)
    .backgroundColor(AppConstants.COLORS.BACKGROUND_BASE)
    .borderRadius(12)
  }
}