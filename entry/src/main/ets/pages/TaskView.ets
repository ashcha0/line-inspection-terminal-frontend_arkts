import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { TaskService, AgvTask, PageParam } from '../services/TaskService';
import { AppConstants } from '../constants/AppConstants';

// ä½¿ç”¨TaskServiceä¸­å®šä¹‰çš„æ¥å£
interface SearchParams {
  taskCode?: string;
  creator?: string;
  executor?: string;
  taskStatus?: string;
}

@Entry
@Component
struct TaskView {
  @State tasks: AgvTask[] = [];
  @State loading: boolean = true;
  @State showAddTask: boolean = false;
  @State searchParams: SearchParams = {};
  @State newTask: Partial<AgvTask> = {};
  
  // æœç´¢è¡¨å•çŠ¶æ€
  @State searchTaskCode: string = '';
  @State searchCreator: string = '';
  @State searchExecutor: string = '';
  @State searchTaskStatus: string = '';
  @State selectedStatusIndex: number = 0; // çŠ¶æ€é€‰æ‹©å™¨çš„é€‰ä¸­ç´¢å¼•
  
  // æ–°å¢/ç¼–è¾‘ä»»åŠ¡è¡¨å•çŠ¶æ€
  @State taskName: string = '';
  @State taskCode: string = '';
  @State startPos: string = '';
  @State taskTrip: string = '';
  @State creator: string = '';
  @State executor: string = '';
  @State remark: string = '';
  
  // ç¼–è¾‘ä»»åŠ¡ç›¸å…³çŠ¶æ€
  @State isEditMode: boolean = false;
  @State editingTaskId: number = 0;
  
  // ä¸Šä¼ ä»»åŠ¡ç›¸å…³çŠ¶æ€
  @State uploadingTasks: Set<number> = new Set();
  @State showUploadProgress: boolean = false;
  @State uploadProgress: number = 0;
  @State currentUploadTaskId: number = 0;

  aboutToAppear() {
    this.loadTasks();
  }

  async loadTasks(): Promise<void> {
    try {
      this.loading = true;
      const params: PageParam = {
        pageNum: 1,
        pageSize: 100,
        taskCode: this.searchParams.taskCode,
        creator: this.searchParams.creator,
        executor: this.searchParams.executor,
        taskStatus: this.searchParams.taskStatus
      };
      
      console.info('[TaskView] ğŸ” å¼€å§‹åŠ è½½ä»»åŠ¡åˆ—è¡¨ï¼Œå‚æ•°:', JSON.stringify(params));
      const response = await TaskService.listTask(params);
      console.info('[TaskView] ğŸ“‹ ä»»åŠ¡åˆ—è¡¨å“åº”:', JSON.stringify(response));
      
      if (response.code === 200) {
        this.tasks = response.rows || [];
        console.info('[TaskView] âœ… ä»»åŠ¡åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œæ•°é‡:', this.tasks.length);
      } else {
        console.error('[TaskView] âŒ ä»»åŠ¡åˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œé”™è¯¯ç :', response.code, 'é”™è¯¯ä¿¡æ¯:', response.msg);
        promptAction.showToast({
          message: response.msg || 'åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥',
          duration: 2000
        });
      }
    } catch (error) {
      console.error('[TaskView] âŒ åŠ è½½ä»»åŠ¡åˆ—è¡¨å¼‚å¸¸:', error);
      promptAction.showToast({
        message: 'åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥',
        duration: 2000
      });
    } finally {
      this.loading = false;
    }
  }

  searchTasks() {
    this.searchParams = {
      taskCode: this.searchTaskCode || undefined,
      creator: this.searchCreator || undefined,
      executor: this.searchExecutor || undefined,
      taskStatus: this.searchTaskStatus || undefined
    };
    this.loadTasks();
  }

  resetSearch() {
    console.info('[TaskView] ğŸ”„ é‡ç½®æœç´¢æ¡ä»¶');
    this.searchTaskCode = '';
    this.searchCreator = '';
    this.searchExecutor = '';
    this.searchTaskStatus = '';
    this.selectedStatusIndex = 0; // é‡ç½®çŠ¶æ€é€‰æ‹©å™¨åˆ°"å…¨éƒ¨"
    this.searchParams = {};
    this.loadTasks();
  }

  openAddTask() {
    this.isEditMode = false;
    this.editingTaskId = 0;
    this.clearTaskForm();
    this.showAddTask = true;
  }

  openEditTask(task: AgvTask) {
    console.info('[TaskView] âœï¸ æ‰“å¼€ç¼–è¾‘ä»»åŠ¡ï¼Œä»»åŠ¡ID:', task.id);
    console.info('[TaskView] ğŸ“‹ ä»»åŠ¡è¯¦ç»†æ•°æ®:', JSON.stringify(task));
    
    this.isEditMode = true;
    this.editingTaskId = task.id;
    
    // å¡«å……è¡¨å•æ•°æ®
    this.taskName = task.taskName || '';
    this.taskCode = task.taskCode || '';
    this.startPos = task.startPos || '';
    this.taskTrip = task.taskTrip || '';
    this.creator = task.creator || '';
    this.executor = task.executor || '';
    this.remark = task.remark || '';
    
    console.info('[TaskView] ğŸ“ è¡¨å•æ•°æ®å¡«å……å®Œæˆ:');
    console.info('[TaskView] - ä»»åŠ¡åç§°:', this.taskName);
    console.info('[TaskView] - ä»»åŠ¡ç¼–å·:', this.taskCode);
    console.info('[TaskView] - èµ·å§‹ä½ç½®:', this.startPos);
    console.info('[TaskView] - å·¡è§†è·¯çº¿:', this.taskTrip);
    console.info('[TaskView] - åˆ›å»ºäºº:', this.creator);
    console.info('[TaskView] - æ‰§è¡Œäºº:', this.executor);
    console.info('[TaskView] - å¤‡æ³¨:', this.remark);
    
    this.showAddTask = true;
    console.info('[TaskView] âœ… ç¼–è¾‘æ¨¡æ€æ¡†å·²æ‰“å¼€');
  }

  closeAddTask() {
    this.showAddTask = false;
    this.isEditMode = false;
    this.editingTaskId = 0;
    this.clearTaskForm();
  }

  clearTaskForm() {
    this.taskName = '';
    this.taskCode = '';
    this.startPos = '';
    this.taskTrip = '';
    this.creator = '';
    this.executor = '';
    this.remark = '';
  }

  async addTask() {
    if (this.isEditMode) {
      await this.updateTask();
    } else {
      await this.createTask();
    }
  }

  async createTask() {
    // è¡¨å•éªŒè¯
    if (!this.taskName || !this.startPos || !this.taskTrip || !this.creator || !this.executor) {
      promptAction.showToast({
        message: 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ',
        duration: 2000
      });
      return;
    }

    try {
      // è‡ªåŠ¨ç”Ÿæˆä»»åŠ¡ç¼–å·ï¼šTASK-å¹´æœˆæ—¥æ—¶åˆ†ç§’
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hour = String(now.getHours()).padStart(2, '0');
      const minute = String(now.getMinutes()).padStart(2, '0');
      const second = String(now.getSeconds()).padStart(2, '0');
      const autoTaskCode = `TASK-${year}${month}${day}${hour}${minute}${second}`;
      
      const taskData: Partial<AgvTask> = {
        taskName: this.taskName,
        taskCode: this.taskCode || autoTaskCode,
        startPos: this.startPos,
        taskTrip: this.taskTrip,
        creator: this.creator,
        executor: this.executor,
        remark: this.remark || undefined
      };
      
      console.info('[TaskView] ğŸ”¢ è‡ªåŠ¨ç”Ÿæˆä»»åŠ¡ç¼–å·:', autoTaskCode);

      console.info('[TaskView] ğŸ“ å¼€å§‹åˆ›å»ºä»»åŠ¡:', JSON.stringify(taskData));
      const response = await TaskService.addTask(taskData);
      
      console.info('[TaskView] ğŸ“‹ ä»»åŠ¡åˆ›å»ºå“åº”:', JSON.stringify(response));
      
      // æ£€æŸ¥å“åº”çŠ¶æ€
       interface ResponseWithCode {
         code: number;
         msg?: string;
         data?: Object;
       }
      
      const responseData = response as ResponseWithCode;
      
      if (responseData.code === 200) {
        console.info('[TaskView] âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œå‡†å¤‡æ›´æ–°UI');
        
        // ç›´æ¥åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒUIæ“ä½œ
        try {
          console.info('[TaskView] ğŸ”„ å¼€å§‹æ‰§è¡ŒUIæ›´æ–°æ“ä½œ');
          
          // å…ˆå…³é—­æ¨¡æ€æ¡†
          this.closeAddTask();
          console.info('[TaskView] ğŸ”„ æ¨¡æ€æ¡†å·²å…³é—­');
          
          // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
          this.loadTasks();
          console.info('[TaskView] ğŸ”„ ä»»åŠ¡åˆ—è¡¨åˆ·æ–°å®Œæˆ');
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          promptAction.showToast({
            message: 'ä»»åŠ¡åˆ›å»ºæˆåŠŸ',
            duration: 2000
          });
          
          console.info('[TaskView] âœ… UIæ›´æ–°å®Œæˆ');
        } catch (uiError) {
          console.error('[TaskView] âŒ UIæ›´æ–°å¤±è´¥:', uiError);
          // å¦‚æœUIæ›´æ–°å¤±è´¥ï¼Œè‡³å°‘å°è¯•å…³é—­å¼¹çª—
          try {
            this.closeAddTask();
          } catch (closeError) {
            console.error('[TaskView] âŒ å…³é—­å¼¹çª—å¤±è´¥:', closeError);
          }
        }
      } else {
        console.error('[TaskView] âŒ ä»»åŠ¡åˆ›å»ºå¤±è´¥ï¼Œé”™è¯¯ç :', responseData.code, 'é”™è¯¯ä¿¡æ¯:', responseData.msg);
        promptAction.showToast({
          message: responseData.msg || 'åˆ›å»ºä»»åŠ¡å¤±è´¥',
          duration: 2000
        });
      }
      
    } catch (error) {
      console.error('[TaskView] âŒ åˆ›å»ºä»»åŠ¡å¼‚å¸¸:', error);
      promptAction.showToast({
        message: 'åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  async updateTask() {
    // è¡¨å•éªŒè¯
    if (!this.taskName || !this.startPos || !this.taskTrip || !this.creator || !this.executor) {
      promptAction.showToast({
        message: 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ',
        duration: 2000
      });
      return;
    }

    try {
      // å…ˆè·å–åŸæœ‰ä»»åŠ¡æ•°æ®ï¼Œä¿ç•™å®Œæ•´çš„æ•°æ®ç»“æ„
      const originalTask = await TaskService.getTask(this.editingTaskId);
      console.info('[TaskView] ğŸ“‹ è·å–åŸæœ‰ä»»åŠ¡æ•°æ®:', JSON.stringify(originalTask));
      
      // åªæ›´æ–°ç”¨æˆ·ä¿®æ”¹çš„å­—æ®µï¼Œä¿ç•™å…¶ä»–åŸæœ‰æ•°æ®
      const taskData: AgvTask = {
        id: originalTask.id,
        taskName: this.taskName,
        taskCode: this.taskCode,
        startPos: this.startPos,
        taskTrip: this.taskTrip,
        creator: this.creator,
        executor: this.executor,
        remark: this.remark || '',
        taskStatus: originalTask.taskStatus,
        round: originalTask.round,
        uploaded: originalTask.uploaded,
        execTime: originalTask.execTime,
        endTime: originalTask.endTime,
        createTime: originalTask.createTime,
        cloudTaskId: originalTask.cloudTaskId
      };
      
      console.info('[TaskView] âœï¸ å¼€å§‹æ›´æ–°ä»»åŠ¡:', JSON.stringify(taskData));
      const response = await TaskService.updateTask(taskData);
      
      console.info('[TaskView] ğŸ“‹ ä»»åŠ¡æ›´æ–°å“åº”:', JSON.stringify(response));
      
      // æ£€æŸ¥å“åº”çŠ¶æ€
       interface ResponseWithCode {
         code: number;
         msg?: string;
         data?: Object;
       }
      
      const responseData = response as ResponseWithCode;
      
      if (responseData.code === 200) {
        console.info('[TaskView] âœ… ä»»åŠ¡æ›´æ–°æˆåŠŸï¼Œå‡†å¤‡æ›´æ–°UI');
        
        // ç›´æ¥åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒUIæ“ä½œ
        try {
          console.info('[TaskView] ğŸ”„ å¼€å§‹æ‰§è¡ŒUIæ›´æ–°æ“ä½œ');
          
          // å…ˆå…³é—­æ¨¡æ€æ¡†
          this.closeAddTask();
          console.info('[TaskView] ğŸ”„ æ¨¡æ€æ¡†å·²å…³é—­');
          
          // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
          this.loadTasks();
          console.info('[TaskView] ğŸ”„ ä»»åŠ¡åˆ—è¡¨åˆ·æ–°å®Œæˆ');
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          promptAction.showToast({
            message: 'ä»»åŠ¡æ›´æ–°æˆåŠŸ',
            duration: 2000
          });
          
          console.info('[TaskView] âœ… UIæ›´æ–°å®Œæˆ');
        } catch (uiError) {
          console.error('[TaskView] âŒ UIæ›´æ–°å¤±è´¥:', uiError);
          // å¦‚æœUIæ›´æ–°å¤±è´¥ï¼Œè‡³å°‘å°è¯•å…³é—­å¼¹çª—
          try {
            this.closeAddTask();
          } catch (closeError) {
            console.error('[TaskView] âŒ å…³é—­å¼¹çª—å¤±è´¥:', closeError);
          }
        }
      } else {
        console.error('[TaskView] âŒ ä»»åŠ¡æ›´æ–°å¤±è´¥ï¼Œé”™è¯¯ç :', responseData.code, 'é”™è¯¯ä¿¡æ¯:', responseData.msg);
        promptAction.showToast({
          message: responseData.msg || 'æ›´æ–°ä»»åŠ¡å¤±è´¥',
          duration: 2000
        });
      }
      
    } catch (error) {
      console.error('[TaskView] âŒ æ›´æ–°ä»»åŠ¡å¼‚å¸¸:', error);
      promptAction.showToast({
        message: 'æ›´æ–°ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  deleteTask(taskId: number) {
    console.info('[TaskView] ğŸ—‘ï¸ å¼€å§‹åˆ é™¤ä»»åŠ¡ï¼ŒID:', taskId);
    console.info('[TaskView] ğŸ” å½“å‰UIä¸Šä¸‹æ–‡çŠ¶æ€æ£€æŸ¥ - å¼€å§‹åˆ é™¤å‰');
    
    // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
    this.loading = true;
    console.info('[TaskView] â³ è®¾ç½®åŠ è½½çŠ¶æ€ä¸ºtrue');
    
    // ä½¿ç”¨Promiseé“¾å¼è°ƒç”¨ï¼Œé¿å…async/awaitå¯¼è‡´çš„ä¸Šä¸‹æ–‡ä¸¢å¤±
    TaskService.delTask(taskId)
      .then((response) => {
        console.info('[TaskView] ğŸ“‹ åˆ é™¤ä»»åŠ¡å“åº”:', JSON.stringify(response));
        console.info('[TaskView] ğŸ” Promise thenå›è°ƒä¸­çš„UIä¸Šä¸‹æ–‡æ£€æŸ¥');
        
        interface ResponseWithCode {
          code: number;
          msg?: string;
        }
        const responseWithCode = response as ResponseWithCode;
        
        if (responseWithCode.code === 200) {
          console.info('[TaskView] âœ… ä»»åŠ¡åˆ é™¤æˆåŠŸï¼Œå¼€å§‹UIæ›´æ–°');
          console.info('[TaskView] ğŸ” å‡†å¤‡æ›´æ–°UIçŠ¶æ€ - loadingè®¾ä¸ºfalseå‰');
          
          // åœ¨ä¸»çº¿ç¨‹ä¸­ç›´æ¥æ›´æ–°UIçŠ¶æ€
          try {
            this.loading = false;
            console.info('[TaskView] âœ… æˆåŠŸè®¾ç½®loadingçŠ¶æ€ä¸ºfalse');
          } catch (error) {
            console.error('[TaskView] âŒ è®¾ç½®loadingçŠ¶æ€å¤±è´¥:', error);
          }
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          try {
            promptAction.showToast({
              message: 'ä»»åŠ¡åˆ é™¤æˆåŠŸ',
              duration: 2000
            });
            console.info('[TaskView] âœ… æˆåŠŸæ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º');
          } catch (error) {
            console.error('[TaskView] âŒ æ˜¾ç¤ºæç¤ºå¤±è´¥:', error);
          }
          
          // å»¶è¿Ÿåˆ·æ–°ä»»åŠ¡åˆ—è¡¨ï¼Œç¡®ä¿åœ¨æ­£ç¡®çš„UIä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
          console.info('[TaskView] â° å‡†å¤‡å»¶è¿Ÿåˆ·æ–°ä»»åŠ¡åˆ—è¡¨');
          setTimeout(() => {
            console.info('[TaskView] ğŸ”„ å¼€å§‹æ‰§è¡Œå»¶è¿Ÿåˆ·æ–°ä»»åŠ¡åˆ—è¡¨');
            console.info('[TaskView] ğŸ” setTimeoutå›è°ƒä¸­çš„UIä¸Šä¸‹æ–‡æ£€æŸ¥');
            try {
              console.info('[TaskView] ğŸ“ è°ƒç”¨loadTaskså‰çš„çŠ¶æ€æ£€æŸ¥');
              this.loadTasks();
              console.info('[TaskView] ğŸ”„ ä»»åŠ¡åˆ—è¡¨åˆ·æ–°å®Œæˆ');
            } catch (error) {
              console.error('[TaskView] âŒ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
              console.error('[TaskView] ğŸ” é”™è¯¯è¯¦æƒ…:', JSON.stringify(error));
              // å¤‡ç”¨æ–¹æ¡ˆï¼šé‡ç½®æœç´¢å‚æ•°å¹¶é‡æ–°åŠ è½½
               try {
                 console.info('[TaskView] ğŸ”„ å°è¯•å¤‡ç”¨åˆ·æ–°æ–¹æ¡ˆ');
                 // é‡ç½®æœç´¢å‚æ•°
                 this.searchParams = {};
                 this.loadTasks();
               } catch (backupError) {
                 console.error('[TaskView] âŒ å¤‡ç”¨åˆ·æ–°æ–¹æ¡ˆä¹Ÿå¤±è´¥:', backupError);
               }
            }
          }, 200); // å¢åŠ å»¶è¿Ÿæ—¶é—´åˆ°200ms
          
        } else {
          console.error('[TaskView] âŒ ä»»åŠ¡åˆ é™¤å¤±è´¥ï¼Œé”™è¯¯ç :', responseWithCode.code);
          this.loading = false;
          
          promptAction.showToast({
            message: responseWithCode.msg || 'åˆ é™¤ä»»åŠ¡å¤±è´¥',
            duration: 2000
          });
        }
      })
      .catch((error: Error) => {
        console.error('[TaskView] âŒ åˆ é™¤ä»»åŠ¡å¼‚å¸¸:', error);
        console.error('[TaskView] ğŸ” catchå›è°ƒä¸­çš„é”™è¯¯è¯¦æƒ…:', JSON.stringify(error));
        this.loading = false;
        
        promptAction.showToast({
          message: 'åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•',
          duration: 2000
        });
      });
  }

  async startTask(taskId: number) {
    try {
      console.info('[TaskView] ğŸš€ å¼€å§‹å¯åŠ¨ä»»åŠ¡ï¼ŒID:', taskId);
      const response = await TaskService.startTask(taskId);
      
      interface ResponseWithCode {
        code: number;
        msg?: string;
      }
      const responseWithCode = response as ResponseWithCode;
      if (responseWithCode.code === 200) {
        console.info('[TaskView] âœ… ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼Œå‡†å¤‡åˆ·æ–°åˆ—è¡¨');
        
        // å…ˆåˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥è·å–æœ€æ–°çŠ¶æ€
        try {
          await this.loadTasks();
          console.info('[TaskView] ğŸ”„ ä»»åŠ¡åˆ—è¡¨åˆ·æ–°å®Œæˆ');
        } catch (refreshError) {
          console.error('[TaskView] âŒ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', refreshError);
        }
        
        // ä½¿ç”¨try-catchåŒ…è£…UIæ“ä½œï¼Œé¿å…UIä¸Šä¸‹æ–‡é”™è¯¯
        try {
          promptAction.showToast({
            message: 'ä»»åŠ¡å¯åŠ¨æˆåŠŸ',
            duration: 2000
          });
          
          // è·³è½¬åˆ°ä»»åŠ¡æ‰§è¡Œé¡µé¢
          router.pushUrl({
            url: 'pages/TaskExecuteView',
            params: {
              taskId: taskId
            }
          });
        } catch (uiError) {
          console.error('[TaskView] âŒ UIæ“ä½œå¤±è´¥:', uiError);
        }
      } else {
        console.error('[TaskView] âŒ ä»»åŠ¡å¯åŠ¨å¤±è´¥ï¼Œé”™è¯¯ç :', responseWithCode.code, 'é”™è¯¯ä¿¡æ¯:', responseWithCode.msg);
        
        // ä»»åŠ¡å¯åŠ¨å¤±è´¥æ—¶ï¼Œä¹Ÿéœ€è¦åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥ç¡®ä¿çŠ¶æ€åŒæ­¥
        try {
          await this.loadTasks();
          console.info('[TaskView] ğŸ”„ ä»»åŠ¡åˆ—è¡¨åˆ·æ–°å®Œæˆï¼ˆå¯åŠ¨å¤±è´¥åï¼‰');
        } catch (refreshError) {
          console.error('[TaskView] âŒ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥ï¼ˆå¯åŠ¨å¤±è´¥åï¼‰:', refreshError);
        }
        
        // ä»»åŠ¡å¯åŠ¨å¤±è´¥æ—¶ï¼Œé¿å…æ‰§è¡Œå¯èƒ½å¯¼è‡´UIä¸Šä¸‹æ–‡é”™è¯¯çš„æ“ä½œ
        try {
          promptAction.showToast({
            message: responseWithCode.msg || 'å¯åŠ¨ä»»åŠ¡å¤±è´¥',
            duration: 2000
          });
        } catch (uiError) {
          console.error('[TaskView] âŒ æ˜¾ç¤ºé”™è¯¯æç¤ºå¤±è´¥:', uiError);
        }
      }
    } catch (error) {
      console.error('[TaskView] âŒ å¯åŠ¨ä»»åŠ¡å¼‚å¸¸:', error);
      
      // å¼‚å¸¸æƒ…å†µä¸‹ï¼Œä¹Ÿéœ€è¦åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥ç¡®ä¿çŠ¶æ€åŒæ­¥
      try {
        await this.loadTasks();
        console.info('[TaskView] ğŸ”„ ä»»åŠ¡åˆ—è¡¨åˆ·æ–°å®Œæˆï¼ˆå¼‚å¸¸åï¼‰');
      } catch (refreshError) {
        console.error('[TaskView] âŒ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥ï¼ˆå¼‚å¸¸åï¼‰:', refreshError);
      }
      
      // å¼‚å¸¸æƒ…å†µä¸‹ï¼Œé¿å…æ‰§è¡Œå¯èƒ½å¯¼è‡´UIä¸Šä¸‹æ–‡é”™è¯¯çš„æ“ä½œ
      try {
        promptAction.showToast({
          message: 'å¯åŠ¨ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•',
          duration: 2000
        });
      } catch (uiError) {
        console.error('[TaskView] âŒ æ˜¾ç¤ºå¼‚å¸¸æç¤ºå¤±è´¥:', uiError);
      }
    }
  }

  goToTaskExecute(taskId: number) {
    try {
      console.info('[TaskView] ğŸš€ è·³è½¬åˆ°ä»»åŠ¡æ‰§è¡Œé¡µé¢ï¼Œä»»åŠ¡ID:', taskId);
      router.pushUrl({
        url: 'pages/TaskExecuteView',
        params: {
          taskId: taskId
        }
      });
    } catch (error) {
      console.error('[TaskView] âŒ è·³è½¬åˆ°ä»»åŠ¡æ‰§è¡Œé¡µé¢å¤±è´¥:', error);
      promptAction.showToast({
        message: 'è·³è½¬å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  async endTask(taskId: number) {
    try {
      console.info('[TaskView] ğŸ›‘ å¼€å§‹ç»“æŸä»»åŠ¡ï¼ŒID:', taskId);
      const response = await TaskService.endTask(taskId, false); // falseè¡¨ç¤ºæ­£å¸¸å®Œæˆï¼Œä¸æ˜¯ä¸­æ­¢
      
      interface ResponseWithCode {
        code: number;
        msg?: string;
      }
      const responseWithCode = response as ResponseWithCode;
      if (responseWithCode.code === 200) {
        console.info('[TaskView] âœ… ä»»åŠ¡ç»“æŸæˆåŠŸï¼Œå‡†å¤‡åˆ·æ–°åˆ—è¡¨');
        
        // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥è·å–æœ€æ–°çŠ¶æ€
        try {
          await this.loadTasks();
          console.info('[TaskView] ğŸ”„ ä»»åŠ¡åˆ—è¡¨åˆ·æ–°å®Œæˆ');
        } catch (refreshError) {
          console.error('[TaskView] âŒ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', refreshError);
        }
        
        // ä½¿ç”¨try-catchåŒ…è£…UIæ“ä½œï¼Œé¿å…UIä¸Šä¸‹æ–‡é”™è¯¯
        try {
          promptAction.showToast({
            message: 'ä»»åŠ¡ç»“æŸæˆåŠŸ',
            duration: 2000
          });
        } catch (uiError) {
          console.error('[TaskView] âŒ UIæ“ä½œå¤±è´¥:', uiError);
        }
      } else {
        console.error('[TaskView] âŒ ä»»åŠ¡ç»“æŸå¤±è´¥ï¼Œé”™è¯¯ç :', responseWithCode.code, 'é”™è¯¯ä¿¡æ¯:', responseWithCode.msg);
        
        // ä»»åŠ¡ç»“æŸå¤±è´¥æ—¶ï¼Œä¹Ÿéœ€è¦åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥ç¡®ä¿çŠ¶æ€åŒæ­¥
        try {
          await this.loadTasks();
          console.info('[TaskView] ğŸ”„ ä»»åŠ¡åˆ—è¡¨åˆ·æ–°å®Œæˆï¼ˆç»“æŸå¤±è´¥åï¼‰');
        } catch (refreshError) {
          console.error('[TaskView] âŒ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥ï¼ˆç»“æŸå¤±è´¥åï¼‰:', refreshError);
        }
        
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        try {
          promptAction.showToast({
            message: responseWithCode.msg || 'ç»“æŸä»»åŠ¡å¤±è´¥',
            duration: 2000
          });
        } catch (uiError) {
          console.error('[TaskView] âŒ æ˜¾ç¤ºé”™è¯¯æç¤ºå¤±è´¥:', uiError);
        }
      }
    } catch (error) {
      console.error('[TaskView] âŒ ç»“æŸä»»åŠ¡å¼‚å¸¸:', error);
      
      // å¼‚å¸¸æƒ…å†µä¸‹ï¼Œä¹Ÿéœ€è¦åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥ç¡®ä¿çŠ¶æ€åŒæ­¥
      try {
        await this.loadTasks();
        console.info('[TaskView] ğŸ”„ ä»»åŠ¡åˆ—è¡¨åˆ·æ–°å®Œæˆï¼ˆå¼‚å¸¸åï¼‰');
      } catch (refreshError) {
        console.error('[TaskView] âŒ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥ï¼ˆå¼‚å¸¸åï¼‰:', refreshError);
      }
      
      // å¼‚å¸¸æƒ…å†µä¸‹ï¼Œé¿å…æ‰§è¡Œå¯èƒ½å¯¼è‡´UIä¸Šä¸‹æ–‡é”™è¯¯çš„æ“ä½œ
      try {
        promptAction.showToast({
          message: 'ç»“æŸä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•',
          duration: 2000
        });
      } catch (uiError) {
        console.error('[TaskView] âŒ æ˜¾ç¤ºå¼‚å¸¸æç¤ºå¤±è´¥:', uiError);
      }
    }
  }

  // ç§»é™¤uploadTaskæ–¹æ³•ï¼Œä¸Šä¼ åŠŸèƒ½å·²æ”¹ä¸ºè·³è½¬åˆ°TaskReviewViewé¡µé¢

  // ç§»é™¤TaskDetailViewé¡µé¢è·³è½¬åŠŸèƒ½
  viewTaskDetail(taskId: number) {
    // TaskDetailViewé¡µé¢å·²åˆ é™¤ï¼Œæ­¤åŠŸèƒ½ä¸å†å¯ç”¨
    promptAction.showToast({
      message: 'è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½å·²ç§»é™¤',
      duration: 2000
    });
  }

  getStatusColor(taskStatus: string): string {
    switch (taskStatus) {
      case AppConstants.TASK_STATUS.PENDING:
        return '#e6a23c';
      case AppConstants.TASK_STATUS.RUNNING:
        return '#409eff';
      case AppConstants.TASK_STATUS.UPLOADING:
        return '#909399';
      case AppConstants.TASK_STATUS.COMPLETED:
        return '#67c23a';
      default:
        return '#909399';
    }
  }

  getStatusText(taskStatus: string): string {
    switch (taskStatus) {
      case AppConstants.TASK_STATUS.PENDING:
        return 'å¾…å·¡è§†';
      case AppConstants.TASK_STATUS.RUNNING:
        return 'å·¡è§†ä¸­';
      case AppConstants.TASK_STATUS.UPLOADING:
        return 'å¾…ä¸Šä¼ ';
      case AppConstants.TASK_STATUS.COMPLETED:
        return 'å·²å®Œæˆ';
      default:
        return taskStatus;
    }
  }

  build() {
    Stack() {
      Column() {
      // é¡µé¢æ ‡é¢˜
      Row() {
        Button('â† è¿”å›')
          .fontSize(14)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .backgroundColor('transparent')
          .onClick(() => {
            router.back();
          })
        
        Text('ä»»åŠ¡ç®¡ç†')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Row() {
          Button('ğŸ”„')
            .fontSize(16)
            .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
            .backgroundColor('transparent')
            .onClick(() => {
              console.info('[TaskView] ğŸ”„ æ‰‹åŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨');
              this.loadTasks();
            })
            .margin({ right: 10 })
          
          Button('ğŸ“¹')
            .fontSize(16)
            .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
            .backgroundColor('transparent')
            .onClick(() => {
              console.info('[TaskView] ğŸ“¹ è·³è½¬åˆ°æ‘„åƒå¤´æµ‹è¯•é¡µé¢');
              router.pushUrl({
                url: 'pages/CameraTestView'
              });
            })
            .margin({ right: 10 })
          
          Button('âš™ï¸')
            .fontSize(16)
            .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
            .backgroundColor('transparent')
            .onClick(() => {
              router.pushUrl({
                url: 'pages/SettingsView'
              });
            })
        }
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')
      .border({ width: { bottom: 1 }, color: '#eeeeee' })

      // æœç´¢è¡¨å•
      Column() {
        Row() {
          Column() {
            Text('ä»»åŠ¡ç¼–å·')
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .margin({ bottom: 5 })
            TextInput({ placeholder: 'è¯·è¾“å…¥ä»»åŠ¡ç¼–å·' })
              .fontSize(14)
              .onChange((value: string) => {
                this.searchTaskCode = value;
              })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
          .margin({ right: 15 })

          Column() {
            Text('åˆ›å»ºäºº')
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .margin({ bottom: 5 })
            TextInput({ placeholder: 'è¯·è¾“å…¥åˆ›å»ºäºº' })
              .fontSize(14)
              .onChange((value: string) => {
                this.searchCreator = value;
              })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
          .margin({ right: 15 })

          Column() {
            Text('æ‰§è¡Œäºº')
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .margin({ bottom: 5 })
            TextInput({ placeholder: 'è¯·è¾“å…¥æ‰§è¡Œäºº' })
              .fontSize(14)
              .onChange((value: string) => {
                this.searchExecutor = value;
              })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
          .margin({ right: 15 })

          Column() {
            Text('çŠ¶æ€')
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .margin({ bottom: 5 })
            Select([{ value: 'å…¨éƒ¨' }, { value: 'å¾…å·¡è§†' }, { value: 'å·¡è§†ä¸­' }, { value: 'å¾…ä¸Šä¼ ' }, { value: 'å·²å®Œæˆ' }])
               .selected(this.selectedStatusIndex)
               .value(this.selectedStatusIndex === 0 ? 'å…¨éƒ¨' : 
                      this.selectedStatusIndex === 1 ? 'å¾…å·¡è§†' :
                      this.selectedStatusIndex === 2 ? 'å·¡è§†ä¸­' :
                      this.selectedStatusIndex === 3 ? 'å¾…ä¸Šä¼ ' : 'å·²å®Œæˆ')
               .onSelect((index: number, value: string) => {
                 console.info('[TaskView] ğŸ¯ é€‰æ‹©çŠ¶æ€ç­›é€‰:', index, value);
                 this.selectedStatusIndex = index;
                 switch (index) {
                   case 0:
                     this.searchTaskStatus = '';
                     break;
                   case 1:
                     this.searchTaskStatus = AppConstants.TASK_STATUS.PENDING;
                     break;
                   case 2:
                     this.searchTaskStatus = AppConstants.TASK_STATUS.RUNNING;
                     break;
                   case 3:
                     this.searchTaskStatus = AppConstants.TASK_STATUS.UPLOADING;
                     break;
                   case 4:
                     this.searchTaskStatus = AppConstants.TASK_STATUS.COMPLETED;
                     break;
                 }
               })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
          .margin({ right: 15 })

          Column() {
            Text(' ')
              .fontSize(14)
              .margin({ bottom: 5 })
            Row() {
              Button('æœç´¢')
                .fontSize(14)
                .fontColor('#ffffff')
                .backgroundColor(AppConstants.COLORS.PRIMARY)
                .border({ width: 1, color: AppConstants.COLORS.PRIMARY })
                .onClick(() => this.searchTasks())

              Button('é‡ç½®')
                .fontSize(14)
                .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                .backgroundColor('#ffffff')
                .border({ width: 1, color: '#dddddd' })
                .margin({ left: 10 })
                .onClick(() => this.resetSearch())
            }
          }
        }
        .width('100%')
        .alignItems(VerticalAlign.Bottom)
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#fafafa')
      .border({ width: { bottom: 1 }, color: '#eeeeee' })

      // å·¥å…·æ 
      Row() {
        Button('ğŸ“¹ æ–°å¢ä»»åŠ¡')
          .fontSize(14)
          .fontColor('#ffffff')
          .backgroundColor(AppConstants.COLORS.PRIMARY)
          .border({ width: 1, color: AppConstants.COLORS.PRIMARY })
          .onClick(() => this.openAddTask())
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 15, bottom: 15 })
      .justifyContent(FlexAlign.Start)

      // ä»»åŠ¡åˆ—è¡¨
      if (this.loading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color(AppConstants.COLORS.PRIMARY)
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor(AppConstants.COLORS.TEXT_REGULAR)
            .margin({ top: 10 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        List() {
          // è¡¨å¤´
          ListItem() {
            Row() {
              Text('ä»»åŠ¡ç¼–å·')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                .width(120)
                .textAlign(TextAlign.Center)
              
              Text('ä»»åŠ¡åç§°')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                .layoutWeight(1)
                .textAlign(TextAlign.Center)
              
              Text('èµ·å§‹åœ°ç‚¹')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                .width(100)
                .textAlign(TextAlign.Center)
              
              Text('è·ç¦»')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                .width(120)
                .textAlign(TextAlign.Center)
              
              Text('åˆ›å»ºäºº')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                .width(80)
                .textAlign(TextAlign.Center)
              
              Text('æ‰§è¡Œäºº')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                .width(80)
                .textAlign(TextAlign.Center)
              
              Text('çŠ¶æ€')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                .width(80)
                .textAlign(TextAlign.Center)
              
              Text('æ“ä½œ')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                .width(150)
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .height(50)
            .padding({ left: 15, right: 15 })
            .backgroundColor('#f8f9fa')
            .border({ width: { bottom: 1 }, color: '#eeeeee' })
          }

          // æ•°æ®è¡Œ
          ForEach(this.tasks, (task: AgvTask, index: number) => {
            ListItem() {
              Row() {
                Text(task.taskCode)
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.PRIMARY)
                  .width(120)
                  .textAlign(TextAlign.Center)
                  .decoration({ type: TextDecorationType.Underline })
                  .onClick(() => {
                    // ç§»é™¤TaskDetailViewè·³è½¬ï¼Œæ”¹ä¸ºæç¤º
                    promptAction.showToast({
                      message: 'è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½å·²ç§»é™¤',
                      duration: 2000
                    });
                  })
                
                Text(task.taskName)
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .layoutWeight(1)
                  .textAlign(TextAlign.Center)
                
                Text(task.startPos)
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .width(100)
                  .textAlign(TextAlign.Center)
                
                Text(task.taskTrip)
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .width(120)
                  .textAlign(TextAlign.Center)
                
                Text(task.creator)
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .width(80)
                  .textAlign(TextAlign.Center)
                
                Text(task.executor)
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .width(80)
                  .textAlign(TextAlign.Center)
                
                Text(this.getStatusText(task.taskStatus))
                  .fontSize(12)
                  .fontColor('#ffffff')
                  .backgroundColor(this.getStatusColor(task.taskStatus))
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .borderRadius(12)
                  .width(80)
                  .textAlign(TextAlign.Center)
                
                Row() {
                  if (task.taskStatus === AppConstants.TASK_STATUS.PENDING) {
                    Button('å¯åŠ¨')
                      .fontSize(12)
                      .fontColor('#ffffff')
                      .backgroundColor(AppConstants.COLORS.SUCCESS)
                      .border({ width: 1, color: AppConstants.COLORS.SUCCESS })
                      .onClick(() => this.startTask(task.id))
                    
                    Button('ç¼–è¾‘')
                      .fontSize(12)
                      .fontColor('#ffffff')
                      .backgroundColor(AppConstants.COLORS.PRIMARY)
                      .border({ width: 1, color: AppConstants.COLORS.PRIMARY })
                      .margin({ left: 5 })
                      .onClick(() => this.openEditTask(task))
                    
                    Button('åˆ é™¤')
                      .fontSize(12)
                      .fontColor('#ffffff')
                      .backgroundColor('#f56c6c')
                      .border({ width: 1, color: '#f56c6c' })
                      .margin({ left: 5 })
                      .onClick(() => this.deleteTask(task.id))
                  } else if (task.taskStatus === AppConstants.TASK_STATUS.RUNNING) {
                    Button('å·¡è§†')
                      .fontSize(12)
                      .fontColor('#ffffff')
                      .backgroundColor(AppConstants.COLORS.PRIMARY)
                      .border({ width: 1, color: AppConstants.COLORS.PRIMARY })
                      .onClick(() => this.goToTaskExecute(task.id))
                    
                    Button('ç»“æŸ')
                      .fontSize(12)
                      .fontColor('#ffffff')
                      .backgroundColor('#f56c6c')
                      .border({ width: 1, color: '#f56c6c' })
                      .margin({ left: 5 })
                      .onClick(() => this.endTask(task.id))
                    
                    Button('æŸ¥çœ‹')
                      .fontSize(12)
                      .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                      .backgroundColor('#ffffff')
                      .border({ width: 1, color: '#dddddd' })
                      .margin({ left: 5 })
                      .onClick(() => {
                        // ç§»é™¤TaskDetailViewè·³è½¬
                        promptAction.showToast({
                          message: 'è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½å·²ç§»é™¤',
                          duration: 2000
                        });
                      })
                  } else if (task.taskStatus === AppConstants.TASK_STATUS.UPLOADING) {
                    if (this.uploadingTasks.has(task.id)) {
                      Button('ä¸Šä¼ ä¸­...')
                        .fontSize(12)
                        .fontColor('#ffffff')
                        .backgroundColor('#909399')
                        .border({ width: 1, color: '#909399' })
                        .enabled(false)
                    } else {
                      Button('ä¸Šä¼ ')
                        .fontSize(12)
                        .fontColor('#ffffff')
                        .backgroundColor(AppConstants.COLORS.PRIMARY)
                        .border({ width: 1, color: AppConstants.COLORS.PRIMARY })
                        .onClick(() => {
                          // è·³è½¬åˆ°TaskReviewViewé¡µé¢è¿›è¡Œå¤ç›˜åä¸Šä¼ 
                          router.pushUrl({
                            url: 'pages/TaskReviewView',
                            params: {
                              taskId: task.id
                            }
                          });
                        })
                      
                      Button('åˆ é™¤')
                        .fontSize(12)
                        .fontColor('#ffffff')
                        .backgroundColor('#f56c6c')
                        .border({ width: 1, color: '#f56c6c' })
                        .margin({ left: 5 })
                        .onClick(() => this.deleteTask(task.id))
                    }
                    
                    Button('æŸ¥çœ‹')
                      .fontSize(12)
                      .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                      .backgroundColor('#ffffff')
                      .border({ width: 1, color: '#dddddd' })
                      .margin({ left: 5 })
                      .onClick(() => {
                        // ç§»é™¤TaskDetailViewè·³è½¬
                        promptAction.showToast({
                          message: 'è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½å·²ç§»é™¤',
                          duration: 2000
                        });
                      })
                  } else {
                    Button('æŸ¥çœ‹')
                      .fontSize(12)
                      .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                      .backgroundColor('#ffffff')
                      .border({ width: 1, color: '#dddddd' })
                      .onClick(() => {
                        // ç§»é™¤TaskDetailViewè·³è½¬
                        promptAction.showToast({
                          message: 'è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½å·²ç§»é™¤',
                          duration: 2000
                        });
                      })
                    
                    Button('åˆ é™¤')
                      .fontSize(12)
                      .fontColor('#ffffff')
                      .backgroundColor('#f56c6c')
                      .border({ width: 1, color: '#f56c6c' })
                      .margin({ left: 5 })
                      .onClick(() => this.deleteTask(task.id))
                  }
                }
                .width(200)
                .justifyContent(FlexAlign.Center)
              }
              .width('100%')
              .height(60)
              .padding({ left: 15, right: 15 })
              .backgroundColor(index % 2 === 0 ? '#ffffff' : '#f8f9fa')
              .border({ width: { bottom: 1 }, color: '#eeeeee' })
            }
          }, (task: AgvTask) => task.id.toString())
        }
        .width('100%')
        .layoutWeight(1)
        .border({ width: 1, color: '#eeeeee' })
        .borderRadius(8)
        .margin({ left: 20, right: 20, bottom: 20 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppConstants.COLORS.BACKGROUND_BASE)

    // æ–°å¢ä»»åŠ¡æ¨¡æ€æ¡†
    if (this.showAddTask) {
        Stack() {
          Column() {
            // æ¨¡æ€æ¡†æ ‡é¢˜
            Row() {
              Text(this.isEditMode ? 'ç¼–è¾‘ä»»åŠ¡' : 'æ–°å¢ä»»åŠ¡')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .layoutWeight(1)
              
              Button('âœ•')
                .fontSize(16)
                .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                .backgroundColor('transparent')
                .onClick(() => this.closeAddTask())
            }
            .width('100%')
            .padding(20)
            .border({ width: { bottom: 1 }, color: '#eeeeee' })

            // è¡¨å•å†…å®¹
            Scroll() {
              Column() {
                Row() {
                  Column() {
                    Text('ä»»åŠ¡åç§° *')
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                      .margin({ bottom: 5 })
                    TextInput({ placeholder: 'è¯·è¾“å…¥ä»»åŠ¡åç§°', text: this.taskName })
                      .fontSize(14)
                      .onChange((value: string) => {
                        this.taskName = value;
                      })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                  .margin({ right: 15 })

                  Column() {
                    Text('ä»»åŠ¡ç¼–å·')
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                      .margin({ bottom: 5 })
                    TextInput({ placeholder: 'ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ', text: this.taskCode })
                      .fontSize(14)
                      .onChange((value: string) => {
                        this.taskCode = value;
                      })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .margin({ bottom: 20 })

                Row() {
                  Column() {
                    Text('èµ·å§‹åœ°ç‚¹ *')
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                      .margin({ bottom: 5 })
                    TextInput({ placeholder: 'è¯·è¾“å…¥èµ·å§‹åœ°ç‚¹', text: this.startPos })
                      .fontSize(14)
                      .onChange((value: string) => {
                        this.startPos = value;
                      })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                  .margin({ right: 15 })

                  Column() {
                    Text('è·ç¦» *')
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                      .margin({ bottom: 5 })
                    TextInput({ placeholder: 'è¯·è¾“å…¥è·ç¦»ï¼ˆå…¬é‡Œï¼‰', text: this.taskTrip })
                      .fontSize(14)
                      .onChange((value: string) => {
                        this.taskTrip = value;
                      })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .margin({ bottom: 20 })

                Row() {
                  Column() {
                    Text('åˆ›å»ºäºº *')
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                      .margin({ bottom: 5 })
                    TextInput({ placeholder: 'è¯·è¾“å…¥åˆ›å»ºäºº', text: this.creator })
                      .fontSize(14)
                      .onChange((value: string) => {
                        this.creator = value;
                      })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                  .margin({ right: 15 })

                  Column() {
                    Text('æ‰§è¡Œäºº *')
                      .fontSize(14)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                      .margin({ bottom: 5 })
                    TextInput({ placeholder: 'è¯·è¾“å…¥æ‰§è¡Œäºº', text: this.executor })
                      .fontSize(14)
                      .onChange((value: string) => {
                        this.executor = value;
                      })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .margin({ bottom: 20 })



                Column() {
                  Text('å¤‡æ³¨')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .margin({ bottom: 5 })
                  TextArea({ placeholder: 'è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯', text: this.remark })
                    .fontSize(14)
                    .height(80)
                    .onChange((value: string) => {
                      this.remark = value;
                    })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
              }
              .width('100%')
              .padding(20)
            }
            .layoutWeight(1)

            // æŒ‰é’®åŒºåŸŸ
            Row() {
              Button('å–æ¶ˆ')
                .fontSize(14)
                .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                .backgroundColor('#ffffff')
                .border({ width: 1, color: '#dddddd' })
                .onClick(() => this.closeAddTask())

              Button(this.isEditMode ? 'ä¿å­˜' : 'æ–°å¢')
                .fontSize(14)
                .fontColor('#ffffff')
                .backgroundColor(AppConstants.COLORS.PRIMARY)
                .border({ width: 1, color: AppConstants.COLORS.PRIMARY })
                .margin({ left: 15 })
                .onClick(() => this.addTask())
            }
            .justifyContent(FlexAlign.End)
            .width('100%')
            .padding(20)
          }
          .width(800)
          .height(600)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .shadow({ radius: 12, color: 'rgba(0,0,0,0.2)', offsetX: 0, offsetY: 4 })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .alignContent(Alignment.Center)
         .position({ x: 0, y: 0 })
         .zIndex(1000)
         .onClick(() => this.closeAddTask())
      }
      
      // ä¸Šä¼ è¿›åº¦å¼¹çª—
      if (this.showUploadProgress) {
        Stack() {
          Column() {
            Text('ä¸Šä¼ ä»»åŠ¡æ•°æ®')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 20 })
            
            Text(`ä»»åŠ¡ID: ${this.currentUploadTaskId}`)
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .margin({ bottom: 15 })
            
            Progress({
              value: this.uploadProgress,
              total: 100,
              type: ProgressType.Linear
            })
              .width('100%')
              .height(8)
              .color(AppConstants.COLORS.PRIMARY)
              .margin({ bottom: 10 })
            
            Text(`${this.uploadProgress}%`)
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
              .textAlign(TextAlign.Center)
            
            if (this.uploadProgress === 100) {
              Text('ä¸Šä¼ å®Œæˆï¼')
                .fontSize(14)
                .fontColor(AppConstants.COLORS.SUCCESS)
                .margin({ top: 10 })
            }
          }
          .width(300)
          .padding(30)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .shadow({ radius: 12, color: 'rgba(0,0,0,0.2)', offsetX: 0, offsetY: 4 })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .alignContent(Alignment.Center)
        .position({ x: 0, y: 0 })
        .zIndex(1000)
      }
    }
    .width('100%')
    .height('100%')
  }
}