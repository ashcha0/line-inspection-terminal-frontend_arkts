import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { ConfigService, AgvConfig } from '../services/ConfigService';
import { SystemCheckService } from '../services/SystemCheckService';
import { AppConstants } from '../constants/AppConstants';

@Entry
@Component
struct SettingsView {
  @State config: AgvConfig = ConfigService.getDefaultConfig();
  @State loading: boolean = true;
  @State saving: boolean = false;
  @State testing: boolean = false;
  @State showPasswords: boolean[] = [false, false, false, false];
  @State expandedSections: boolean[] = [true, true, true]; // AGVé…ç½®ã€æ‘„åƒå¤´é…ç½®ã€äº‘ç«¯é…ç½®
  @State validationErrors: string[] = [];
  
  aboutToAppear() {
    console.info('ğŸ·ï¸ [SettingsView] æ™ºèƒ½å·¡çº¿è½¦æ‰‹æŒç»ˆç«¯ - ç³»ç»Ÿè®¾ç½®é¡µé¢å·²åŠ è½½');
    this.loadConfig();
  }
  
  async loadConfig() {
    try {
      console.info('[SettingsView] ğŸ“¥ åŠ è½½ç³»ç»Ÿé…ç½®');
      this.config = await ConfigService.getConfig();
      console.info('[SettingsView] âœ… ç³»ç»Ÿé…ç½®åŠ è½½æˆåŠŸ');
    } catch (error) {
      console.error('[SettingsView] âŒ åŠ è½½ç³»ç»Ÿé…ç½®å¤±è´¥:', error);
      promptAction.showToast({
        message: 'åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®',
        duration: 2000
      });
    } finally {
      this.loading = false;
    }
  }
  
  async saveConfig() {
    try {
      // éªŒè¯é…ç½®
      const validation = ConfigService.validateConfig(this.config);
      if (!validation.valid) {
        this.validationErrors = validation.errors;
        promptAction.showToast({
          message: 'é…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥',
          duration: 3000
        });
        return;
      }
      
      this.saving = true;
      console.info('[SettingsView] ğŸ’¾ ä¿å­˜ç³»ç»Ÿé…ç½®');
      
      await ConfigService.updateConfig(this.config);
      
      promptAction.showToast({
        message: 'é…ç½®ä¿å­˜æˆåŠŸï¼Œè¯·é‡æ–°æ‰§è¡Œç³»ç»Ÿè‡ªæ£€',
        duration: 3000
      });
      
      console.info('[SettingsView] âœ… ç³»ç»Ÿé…ç½®ä¿å­˜æˆåŠŸ');
      
      // ä¿å­˜æˆåŠŸåè¿”å›åˆå§‹åŒ–é¡µé¢é‡æ–°è‡ªæ£€
      setTimeout(() => {
        router.replaceUrl({
          url: AppConstants.ROUTES.INIT
        });
      }, 1000);
      
    } catch (error) {
      console.error('[SettingsView] âŒ ä¿å­˜ç³»ç»Ÿé…ç½®å¤±è´¥:', error);
      promptAction.showToast({
        message: 'ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    } finally {
      this.saving = false;
    }
  }
  
  async testConnection() {
    try {
      this.testing = true;
      console.info('[SettingsView] ğŸ”— æµ‹è¯•è¿æ¥');
      
      // æµ‹è¯•AGVè¿æ¥
      const agvConnected = await ConfigService.testAgvConnection(this.config.host, this.config.drivePort);
      
      // æµ‹è¯•æ‘„åƒå¤´è¿æ¥ï¼ˆæµ‹è¯•ç¬¬ä¸€ä¸ªé…ç½®çš„æ‘„åƒå¤´ï¼‰
      let cameraConnected = false;
      if (this.config.cam1 && this.config.username1 && this.config.password1) {
        cameraConnected = await ConfigService.testCameraConnection(
          this.config.cam1, 
          this.config.username1, 
          this.config.password1
        );
      }
      
      const message = `AGVè¿æ¥: ${agvConnected ? 'æˆåŠŸ' : 'å¤±è´¥'}\næ‘„åƒå¤´è¿æ¥: ${cameraConnected ? 'æˆåŠŸ' : 'å¤±è´¥'}`;
      
      promptAction.showToast({
        message: message,
        duration: 3000
      });
      
      console.info(`[SettingsView] ğŸ”— è¿æ¥æµ‹è¯•å®Œæˆ - AGV: ${agvConnected}, æ‘„åƒå¤´: ${cameraConnected}`);
      
    } catch (error) {
      console.error('[SettingsView] âŒ æµ‹è¯•è¿æ¥å¤±è´¥:', error);
      promptAction.showToast({
        message: 'è¿æ¥æµ‹è¯•å¤±è´¥',
        duration: 2000
      });
    } finally {
      this.testing = false;
    }
  }
  
  togglePasswordVisibility(index: number) {
    this.showPasswords[index] = !this.showPasswords[index];
  }
  
  toggleSection(index: number) {
    this.expandedSections[index] = !this.expandedSections[index];
  }
  
  resetToDefault() {
    promptAction.showDialog({
      title: 'ç¡®è®¤é‡ç½®',
      message: 'ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
      buttons: [
        {
          text: 'å–æ¶ˆ',
          color: AppConstants.COLORS.TEXT_SECONDARY
        },
        {
          text: 'ç¡®å®š',
          color: AppConstants.COLORS.DANGER
        }
      ]
    }).then((result) => {
      if (result.index === 1) {
        this.config = ConfigService.getDefaultConfig();
        this.validationErrors = [];
        console.info('[SettingsView] ğŸ”„ é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼');
        promptAction.showToast({
          message: 'å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®',
          duration: 2000
        });
      }
    });
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('â† è¿”å›')
          .fontSize(14)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .backgroundColor('transparent')
          .onClick(() => {
            router.back();
          })
        
        Text('ç³»ç»Ÿè®¾ç½®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Button('é‡ç½®')
          .fontSize(14)
          .fontColor(AppConstants.COLORS.DANGER)
          .backgroundColor('transparent')
          .onClick(() => {
            this.resetToDefault();
          })
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')
      .border({ width: { bottom: 1 }, color: AppConstants.COLORS.BORDER_LIGHT })
      
      if (this.loading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color(AppConstants.COLORS.PRIMARY)
          
          Text('åŠ è½½é…ç½®ä¸­...')
            .fontSize(14)
            .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        
      } else {
        // é…ç½®è¡¨å•
        Scroll() {
          Column() {
            // éªŒè¯é”™è¯¯æç¤º
            if (this.validationErrors.length > 0) {
              Column() {
                ForEach(this.validationErrors, (error: string) => {
                  Text(`â€¢ ${error}`)
                    .fontSize(12)
                    .fontColor(AppConstants.COLORS.DANGER)
                    .width('100%')
                    .margin({ bottom: 4 })
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#fef0f0')
              .borderRadius(8)
              .margin({ bottom: 16 })
            }
            
            // AGVé…ç½®åŒºåŸŸ
            this.buildAgvConfigSection()
            
            // æ‘„åƒå¤´é…ç½®åŒºåŸŸ
            this.buildCameraConfigSection()
            
            
            // äº‘ç«¯é…ç½®åŒºåŸŸ
            this.buildCloudConfigSection()
            
            // æ“ä½œæŒ‰é’®
            Row() {
              Button('æµ‹è¯•è¿æ¥')
                .fontSize(16)
                .fontColor('#ffffff')
                .backgroundColor(AppConstants.COLORS.INFO)
                .borderRadius(8)
                .width('48%')
                .height(44)
                .enabled(!this.testing && !this.saving)
                .onClick(() => {
                  this.testConnection();
                })
              
              Button(this.saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜é…ç½®')
                .fontSize(16)
                .fontColor('#ffffff')
                .backgroundColor(AppConstants.COLORS.PRIMARY)
                .borderRadius(8)
                .width('48%')
                .height(44)
                .enabled(!this.testing && !this.saving)
                .onClick(() => {
                  this.saveConfig();
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ top: 24, bottom: 24 })
          }
          .width('100%')
          .padding(16)
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor(AppConstants.COLORS.BACKGROUND_BASE)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppConstants.COLORS.BACKGROUND_BASE)
  }
  
  @Builder
  buildAgvConfigSection() {
    Column() {
      // åŒºåŸŸæ ‡é¢˜
      Row() {
        Text('ğŸš— AGVé…ç½®')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .layoutWeight(1)
        
        Text(this.expandedSections[0] ? 'â–¼' : 'â–¶')
          .fontSize(14)
          .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')
      .borderRadius({ topLeft: 8, topRight: 8 })
      .onClick(() => {
        this.toggleSection(0);
      })
      
      // åŒºåŸŸå†…å®¹
      if (this.expandedSections[0]) {
        Column() {
          this.buildAgvConfig()
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#ffffff')
        .borderRadius({ bottomLeft: 8, bottomRight: 8 })
      }
    }
    .width('100%')
    .margin({ bottom: 16 })
    .border({ width: 1, color: AppConstants.COLORS.BORDER_LIGHT })
    .borderRadius(8)
  }
  
  @Builder
  buildCameraConfigSection() {
    Column() {
      // åŒºåŸŸæ ‡é¢˜
      Row() {
        Text('ğŸ“¹ æ‘„åƒå¤´é…ç½®')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .layoutWeight(1)
        
        Text(this.expandedSections[1] ? 'â–¼' : 'â–¶')
          .fontSize(14)
          .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')
      .borderRadius({ topLeft: 8, topRight: 8 })
      .onClick(() => {
        this.toggleSection(1);
      })
      
      // åŒºåŸŸå†…å®¹
      if (this.expandedSections[1]) {
        Column() {
          this.buildCameraConfig()
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#ffffff')
        .borderRadius({ bottomLeft: 8, bottomRight: 8 })
      }
    }
    .width('100%')
    .margin({ bottom: 16 })
    .border({ width: 1, color: AppConstants.COLORS.BORDER_LIGHT })
    .borderRadius(8)
  }
  
  @Builder
  buildCloudConfigSection() {
    Column() {
      // åŒºåŸŸæ ‡é¢˜
      Row() {
        Text('â˜ï¸ äº‘ç«¯é…ç½®')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .layoutWeight(1)
        
        Text(this.expandedSections[2] ? 'â–¼' : 'â–¶')
          .fontSize(14)
          .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')
      .borderRadius({ topLeft: 8, topRight: 8 })
      .onClick(() => {
        this.toggleSection(2);
      })
      
      // åŒºåŸŸå†…å®¹
      if (this.expandedSections[2]) {
        Column() {
          this.buildCloudConfig()
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#ffffff')
        .borderRadius({ bottomLeft: 8, bottomRight: 8 })
      }
    }
    .width('100%')
    .margin({ bottom: 16 })
    .border({ width: 1, color: AppConstants.COLORS.BORDER_LIGHT })
    .borderRadius(8)
  }
  
  @Builder
  buildAgvConfig() {
    Column() {
      // AGVä¸»æœºåœ°å€
      this.buildInputField('ä¸»æœºåœ°å€', this.config.host, (value: string) => {
        this.config.host = value;
      }, 'è¯·è¾“å…¥AGVä¸»æœºIPåœ°å€')
      
      // é©±åŠ¨ç«¯å£
      this.buildInputField('é©±åŠ¨ç«¯å£', this.config.drivePort.toString(), (value: string) => {
        this.config.drivePort = parseInt(value) || 0;
      }, 'è¯·è¾“å…¥é©±åŠ¨ç«¯å£', 'number')
      
      // åˆ†æç«¯å£
      this.buildInputField('åˆ†æç«¯å£', this.config.analysisPort.toString(), (value: string) => {
        this.config.analysisPort = parseInt(value) || 0;
      }, 'è¯·è¾“å…¥åˆ†æç«¯å£', 'number')
    }
  }
  
  @Builder
  buildCameraConfig() {
    Column() {
      // æ‘„åƒå¤´1
      this.buildCameraItem(1, this.config.cam1, this.config.username1, this.config.password1,
        (url: string) => { this.config.cam1 = url; },
        (username: string) => { this.config.username1 = username; },
        (password: string) => { this.config.password1 = password; }
      )
      
      // æ‘„åƒå¤´2
      this.buildCameraItem(2, this.config.cam2, this.config.username2, this.config.password2,
        (url: string) => { this.config.cam2 = url; },
        (username: string) => { this.config.username2 = username; },
        (password: string) => { this.config.password2 = password; }
      )
      
      // æ‘„åƒå¤´3
      this.buildCameraItem(3, this.config.cam3, this.config.username3, this.config.password3,
        (url: string) => { this.config.cam3 = url; },
        (username: string) => { this.config.username3 = username; },
        (password: string) => { this.config.password3 = password; }
      )
      
      // æ‘„åƒå¤´4
      this.buildCameraItem(4, this.config.cam4, this.config.username4, this.config.password4,
        (url: string) => { this.config.cam4 = url; },
        (username: string) => { this.config.username4 = username; },
        (password: string) => { this.config.password4 = password; }
      )
    }
  }
  
  @Builder
  buildCloudConfig() {
    Column() {
      this.buildInputField('äº‘ç«¯åœ°å€', this.config.cloudUrl, (value: string) => {
        this.config.cloudUrl = value;
      }, 'è¯·è¾“å…¥äº‘ç«¯æœåŠ¡åœ°å€')
    }
  }
  
  @Builder
  buildCameraItem(
    index: number, 
    url: string, 
    username: string, 
    password: string,
    onUrlChange: (value: string) => void,
    onUsernameChange: (value: string) => void,
    onPasswordChange: (value: string) => void
  ) {
    Column() {
      Text(`æ‘„åƒå¤´${index}`)
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
        .width('100%')
        .margin({ bottom: 8 })
      
      this.buildInputField('åœ°å€', url, onUrlChange, 'è¯·è¾“å…¥æ‘„åƒå¤´åœ°å€')
      this.buildInputField('ç”¨æˆ·å', username, onUsernameChange, 'è¯·è¾“å…¥ç”¨æˆ·å')
      this.buildPasswordField(`å¯†ç `, password, onPasswordChange, 'è¯·è¾“å…¥å¯†ç ', index - 1)
    }
    .width('100%')
    .margin({ bottom: 16 })
    .padding(12)
    .backgroundColor(AppConstants.COLORS.BACKGROUND_BASE)
    .borderRadius(6)
  }
  
  @Builder
  buildInputField(
    label: string, 
    value: string, 
    onChange: (value: string) => void, 
    placeholder: string = '',
    inputType: string = 'text'
  ) {
    Column() {
      Text(label)
        .fontSize(12)
        .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
        .width('100%')
        .margin({ bottom: 4 })
      
      TextInput({ text: value, placeholder: placeholder })
        .fontSize(14)
        .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
        .backgroundColor('#ffffff')
        .borderRadius(4)
        .border({ width: 1, color: AppConstants.COLORS.BORDER_BASE })
        .padding({ left: 12, right: 12 })
        .height(40)
        .width('100%')
        .type(inputType === 'number' ? InputType.Number : InputType.Normal)
        .onChange((value: string) => {
          onChange(value);
        })
    }
    .width('100%')
    .margin({ bottom: 12 })
  }
  
  @Builder
  buildPasswordField(
    label: string, 
    value: string, 
    onChange: (value: string) => void, 
    placeholder: string = '',
    index: number
  ) {
    Column() {
      Text(label)
        .fontSize(12)
        .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
        .width('100%')
        .margin({ bottom: 4 })
      
      Row() {
        TextInput({ text: value, placeholder: placeholder })
          .fontSize(14)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .backgroundColor('#ffffff')
          .borderRadius(4)
          .border({ width: 1, color: AppConstants.COLORS.BORDER_BASE })
          .padding({ left: 12, right: 12 })
          .height(40)
          .layoutWeight(1)
          .type(this.showPasswords[index] ? InputType.Normal : InputType.Password)
          .onChange((value: string) => {
            onChange(value);
          })
        
        Button(this.showPasswords[index] ? 'ğŸ‘ï¸' : 'ğŸ™ˆ')
          .fontSize(16)
          .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
          .backgroundColor('transparent')
          .width(40)
          .height(40)
          .onClick(() => {
            this.togglePasswordVisibility(index);
          })
      }
      .width('100%')
    }
    .width('100%')
    .margin({ bottom: 12 })
  }
}

// æ·»åŠ æ°´å°æ ‡è¯†
console.info('ğŸ·ï¸ [SettingsView] æ™ºèƒ½å·¡çº¿è½¦æ‰‹æŒç»ˆç«¯ - ç³»ç»Ÿè®¾ç½®é¡µé¢ç»„ä»¶å·²åŠ è½½');