import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { CameraService, CameraInfo } from '../services/CameraService';
import { AppConstants } from '../constants/AppConstants';

/**
 * æ‘„åƒå¤´æµ‹è¯•é¡µé¢
 * ç”¨äºŽæµ‹è¯•å®žæ—¶è§†é¢‘æµåŠŸèƒ½ï¼ŒåŒ…æ‹¬æ‘„åƒå¤´åˆ—è¡¨èŽ·å–ã€è§†é¢‘æ’­æ”¾ã€æ‘„åƒå¤´åˆ‡æ¢ç­‰
 */
@Entry
@Component
struct CameraTestView {
  @State cameras: CameraInfo[] = [];
  @State currentCameraIndex: number = 0;
  @State videoUrl: string = '';
  @State loading: boolean = true;
  @State isPlaying: boolean = false;
  @State isAudioEnabled: boolean = true;
  @State connectionStatus: string = 'è¿žæŽ¥ä¸­...';
  @State lastRefreshTime: string = '';

  aboutToAppear() {
    console.info('[CameraTestView] ðŸ“¹ æ‘„åƒå¤´æµ‹è¯•é¡µé¢åˆå§‹åŒ–');
    this.loadCameras();
    this.testConnection();
  }

  /**
   * æµ‹è¯•æ‘„åƒå¤´æœåŠ¡è¿žæŽ¥
   */
  async testConnection() {
    try {
      console.info('[CameraTestView] ðŸ” æµ‹è¯•æ‘„åƒå¤´æœåŠ¡è¿žæŽ¥');
      const isConnected = await CameraService.testConnection();
      this.connectionStatus = isConnected ? 'è¿žæŽ¥æ­£å¸¸' : 'è¿žæŽ¥å¤±è´¥';
      
      console.info('[CameraTestView] ðŸ“Š è¿žæŽ¥æµ‹è¯•ç»“æžœ:', this.connectionStatus);
    } catch (error) {
      console.error('[CameraTestView] âŒ è¿žæŽ¥æµ‹è¯•å¼‚å¸¸:', error);
      this.connectionStatus = 'è¿žæŽ¥å¼‚å¸¸';
    }
  }

  /**
   * åŠ è½½æ‘„åƒå¤´åˆ—è¡¨
   */
  async loadCameras() {
    try {
      console.info('[CameraTestView] ðŸ“¹ å¼€å§‹åŠ è½½æ‘„åƒå¤´åˆ—è¡¨');
      this.loading = true;
      
      // èŽ·å–æ‘„åƒå¤´ä¿¡æ¯åˆ—è¡¨
      this.cameras = await CameraService.getCameraInfoList();
      
      console.info('[CameraTestView] âœ… æ‘„åƒå¤´åˆ—è¡¨åŠ è½½æˆåŠŸ, æ‘„åƒå¤´æ•°é‡:', this.cameras.length.toString());
      
      // å¦‚æžœæœ‰æ‘„åƒå¤´ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
      if (this.cameras.length > 0) {
        this.switchCamera(0);
        console.info('[CameraTestView] ðŸŽ¥ é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ‘„åƒå¤´:', this.cameras[0].name);
      } else {
        console.warn('[CameraTestView] âš ï¸ æœªå‘çŽ°å¯ç”¨æ‘„åƒå¤´');
        this.showToast('æœªå‘çŽ°å¯ç”¨æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿žæŽ¥');
      }
    } catch (error) {
      console.error('[CameraTestView] âŒ åŠ è½½æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥:', error);
      this.showToast('æ‘„åƒå¤´è¿žæŽ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥');
    } finally {
      this.loading = false;
    }
  }

  /**
   * åˆ‡æ¢æ‘„åƒå¤´
   * @param index æ‘„åƒå¤´ç´¢å¼•
   */
  switchCamera(index: number) {
    if (index >= 0 && index < this.cameras.length) {
      this.currentCameraIndex = index;
      this.videoUrl = this.cameras[index].url;
      this.isPlaying = true;
      
      console.info('[CameraTestView] ðŸ”„ åˆ‡æ¢æ‘„åƒå¤´:', JSON.stringify({
        cameraIndex: index,
        cameraId: this.cameras[index].id,
        cameraName: this.cameras[index].name,
        videoUrl: this.videoUrl
      }));
      
      this.showToast(`å·²åˆ‡æ¢åˆ°${this.cameras[index].name}`);
    } else {
      console.warn('[CameraTestView] âš ï¸ æ— æ•ˆçš„æ‘„åƒå¤´ç´¢å¼•:', index);
    }
  }

  /**
   * åˆ·æ–°è§†é¢‘æµ
   */
  refreshVideo() {
    if (this.cameras.length > 0 && this.currentCameraIndex >= 0) {
      const currentCamera = this.cameras[this.currentCameraIndex];
      this.videoUrl = CameraService.generateRefreshStreamUrl(currentCamera.id);
      this.lastRefreshTime = new Date().toLocaleTimeString();
      
      console.info('[CameraTestView] ðŸ”„ åˆ·æ–°è§†é¢‘æµ:', JSON.stringify({
        cameraId: currentCamera.id,
        cameraName: currentCamera.name,
        refreshUrl: this.videoUrl,
        refreshTime: this.lastRefreshTime
      }));
      
      this.showToast(`æ­£åœ¨åˆ·æ–°${currentCamera.name}è§†é¢‘æµ`);
    } else {
      console.warn('[CameraTestView] âš ï¸ æ— å¯ç”¨æ‘„åƒå¤´è¿›è¡Œåˆ·æ–°');
      this.showToast('æ— å¯ç”¨æ‘„åƒå¤´');
    }
  }

  /**
   * é‡æ–°åŠ è½½æ‘„åƒå¤´åˆ—è¡¨
   */
  reloadCameras() {
    console.info('[CameraTestView] ðŸ”„ é‡æ–°åŠ è½½æ‘„åƒå¤´åˆ—è¡¨');
    this.loadCameras();
    this.testConnection();
  }

  /**
   * æ˜¾ç¤ºToastæç¤º
   * @param message æç¤ºæ¶ˆæ¯
   */
  showToast(message: string) {
    setTimeout(() => {
      try {
        promptAction.showToast({
          message: message,
          duration: 2000
        });
      } catch (error) {
        console.warn('[CameraTestView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', error);
      }
    }, 0);
  }

  /**
   * èŽ·å–æ‘„åƒå¤´çŠ¶æ€é¢œè‰²
   * @param status æ‘„åƒå¤´çŠ¶æ€
   * @returns çŠ¶æ€å¯¹åº”çš„é¢œè‰²
   */
  getStatusColor(status: string): string {
    switch (status) {
      case 'online':
        return AppConstants.COLORS.SUCCESS;
      case 'offline':
        return AppConstants.COLORS.DANGER;
      default:
        return AppConstants.COLORS.WARNING;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â† è¿”å›ž')
          .fontSize(14)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .backgroundColor('transparent')
          .onClick(() => {
            router.back();
          })
        
        Text('æ‘„åƒå¤´æµ‹è¯•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Button('ðŸ”„ é‡è½½')
          .fontSize(14)
          .fontColor(AppConstants.COLORS.PRIMARY)
          .backgroundColor('transparent')
          .onClick(() => this.reloadCameras())
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')
      .border({ width: { bottom: 1 }, color: '#eeeeee' })

      if (this.loading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color(AppConstants.COLORS.PRIMARY)
          
          Text('æ­£åœ¨è¿žæŽ¥æ‘„åƒå¤´æœåŠ¡...')
            .fontSize(14)
            .fontColor(AppConstants.COLORS.TEXT_REGULAR)
            .margin({ top: 10 })
          
          Text(`è¿žæŽ¥çŠ¶æ€: ${this.connectionStatus}`)
            .fontSize(12)
            .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
            .margin({ top: 5 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // ä¸»è¦å†…å®¹
        Column() {
          // è¿žæŽ¥çŠ¶æ€ä¿¡æ¯
          Row() {
            Text('æœåŠ¡çŠ¶æ€:')
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
            
            Text(this.connectionStatus)
              .fontSize(14)
              .fontColor(this.connectionStatus === 'è¿žæŽ¥æ­£å¸¸' ? AppConstants.COLORS.SUCCESS : AppConstants.COLORS.DANGER)
              .margin({ left: 8 })
            
            Text(`æ‘„åƒå¤´æ•°é‡: ${this.cameras.length}`)
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .margin({ left: 20 })
            
            if (this.lastRefreshTime) {
              Text(`æœ€åŽåˆ·æ–°: ${this.lastRefreshTime}`)
                .fontSize(12)
                .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
                .margin({ left: 20 })
            }
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#f8f9fa')
          .border({ width: { bottom: 1 }, color: '#eeeeee' })

          // è§†é¢‘æ’­æ”¾åŒºåŸŸ
          Column() {
            Stack() {
              if (this.videoUrl && this.cameras.length > 0) {
                Video({
                  src: this.videoUrl
                })
                  .width('100%')
                  .height(400)
                  .autoPlay(true)
                  .controls(false)
                  .objectFit(ImageFit.Contain)
                  .backgroundColor('#000000')
                  .onStart(() => {
                    this.isPlaying = true;
                    console.info('[CameraTestView] â–¶ï¸ è§†é¢‘å¼€å§‹æ’­æ”¾');
                  })
                  .onPause(() => {
                    this.isPlaying = false;
                    console.info('[CameraTestView] â¸ï¸ è§†é¢‘æš‚åœ');
                  })
                  .onError(() => {
                    console.error('[CameraTestView] âŒ è§†é¢‘æ’­æ”¾é”™è¯¯');
                    this.showToast('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥');
                  })
              } else {
                Column() {
                  Text('ðŸ“¹')
                    .fontSize(48)
                    .fontColor('#cccccc')
                  Text(this.cameras.length === 0 ? 'æ— å¯ç”¨æ‘„åƒå¤´' : 'è§†é¢‘åŠ è½½ä¸­...')
                    .fontSize(16)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .margin({ top: 10 })
                }
                .width('100%')
                .height(400)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
                .backgroundColor('#f5f5f5')
              }

              // è§†é¢‘æŽ§åˆ¶æŒ‰é’®
              Row() {
                Button('ðŸ”„ åˆ·æ–°')
                  .fontSize(12)
                  .fontColor('#ffffff')
                  .backgroundColor('rgba(0,0,0,0.6)')
                  .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
                  .borderRadius(4)
                  .onClick(() => this.refreshVideo())

                Button(this.isAudioEnabled ? 'ðŸ”Š' : 'ðŸ”‡')
                  .fontSize(12)
                  .fontColor('#ffffff')
                  .backgroundColor('rgba(0,0,0,0.6)')
                  .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
                  .borderRadius(4)
                  .margin({ left: 10 })
                  .onClick(() => {
                    this.isAudioEnabled = !this.isAudioEnabled;
                    this.showToast(this.isAudioEnabled ? 'éŸ³é¢‘å·²å¼€å¯' : 'éŸ³é¢‘å·²å…³é—­');
                  })
                
                Text(this.isPlaying ? 'â–¶ï¸ æ’­æ”¾ä¸­' : 'â¸ï¸ å·²æš‚åœ')
                  .fontSize(12)
                  .fontColor('#ffffff')
                  .backgroundColor('rgba(0,0,0,0.6)')
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .borderRadius(4)
                  .margin({ left: 10 })
              }
              .position({ x: 10, y: 10 })
            }
            .width('100%')
            .borderRadius(8)
            .border({ width: 1, color: '#dddddd' })

            // å½“å‰æ‘„åƒå¤´ä¿¡æ¯
            if (this.cameras.length > 0 && this.currentCameraIndex >= 0) {
              Row() {
                Text('å½“å‰æ‘„åƒå¤´:')
                  .fontSize(14)
                  .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                
                Text(this.cameras[this.currentCameraIndex].name)
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .margin({ left: 8 })
                
                Text(`(${this.cameras[this.currentCameraIndex].id})`)
                  .fontSize(12)
                  .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
                  .margin({ left: 4 })
                
                Text(this.cameras[this.currentCameraIndex].status)
                  .fontSize(12)
                  .fontColor(this.getStatusColor(this.cameras[this.currentCameraIndex].status))
                  .margin({ left: 10 })
              }
              .width('100%')
              .padding(10)
              .backgroundColor('#f8f9fa')
              .margin({ top: 10 })
            }
          }
          .layoutWeight(1)
          .padding(20)

          // æ‘„åƒå¤´åˆ‡æ¢åŒºåŸŸ
          if (this.cameras.length > 0) {
            Column() {
              Text('æ‘„åƒå¤´åˆ—è¡¨')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 10 })
              
              // æ‘„åƒå¤´æŒ‰é’®åˆ—è¡¨
              Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
                ForEach(this.cameras, (camera: CameraInfo, index: number) => {
                  Button() {
                    Column() {
                      Text(camera.name)
                        .fontSize(14)
                        .fontColor(index === this.currentCameraIndex ? '#ffffff' : AppConstants.COLORS.TEXT_PRIMARY)
                      
                      Text(camera.status)
                        .fontSize(10)
                        .fontColor(index === this.currentCameraIndex ? 'rgba(255,255,255,0.8)' : this.getStatusColor(camera.status))
                        .margin({ top: 2 })
                    }
                  }
                  .backgroundColor(index === this.currentCameraIndex ? AppConstants.COLORS.PRIMARY : '#ffffff')
                  .border({ 
                    width: 1, 
                    color: index === this.currentCameraIndex ? AppConstants.COLORS.PRIMARY : '#dddddd' 
                  })
                  .borderRadius(6)
                  .margin({ right: 10, bottom: 10 })
                  .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                  .onClick(() => this.switchCamera(index))
                }, (camera: CameraInfo) => camera.id)
              }
              .width('100%')
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#ffffff')
            .border({ width: { top: 1 }, color: '#eeeeee' })
          }
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}