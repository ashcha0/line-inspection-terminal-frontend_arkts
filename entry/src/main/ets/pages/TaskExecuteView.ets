import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import http from '@ohos.net.http';
import { HttpUtil } from '../utils/HttpUtil';
import { AppConstants } from '../constants/AppConstants';
import { AgvMovementService } from '../services/AgvMovementService';
import { AgvTask } from '../services/TaskService';

// æ‘„åƒå¤´æ¥å£
interface Camera {
  id: string;
  name: string;
  url: string;
}

// è½¦è¾†çŠ¶æ€æ¥å£
interface VehicleStatus {
  taskId: number;
  systemTime: string;
  distance: number;
  flawCount: number;
  position: number;
  isRunning: boolean;
}

// æ•…éšœæ¥å£
interface LiveFlaw {
  id: number;
  taskId: number;
  flawName: string;
  flawType: string;
  position: number;
  status: string;
  createTime: string;
}

// ä½¿ç”¨AgvTaskæ¥å£æ›¿ä»£æœ¬åœ°Taskæ¥å£

@Entry
@Component
struct TaskExecuteView {
  @State task: AgvTask | null = null;
  @State vehicleStatus: VehicleStatus | null = null;
  @State liveFlaws: LiveFlaw[] = [];
  @State cameras: Camera[] = [];
  @State currentCameraIndex: number = 0;
  @State videoUrl: string = '';
  @State showFlawDetail: boolean = false;
  @State selectedFlaw: LiveFlaw | null = null;
  @State isAudioEnabled: boolean = true;
  @State loading: boolean = true;
  @State isTaskRunning: boolean = false;
  
  private taskId: number = 0;
  private statusTimer: number = -1;
  private flawTimer: number = -1;

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params && params['taskId']) {
      this.taskId = params['taskId'] as number;
      this.loadTaskDetail();
      this.loadCameras();
      this.startStatusPolling();
      this.startFlawPolling();
    }
  }

  aboutToDisappear() {
    this.stopPolling();
  }

  async loadTaskDetail() {
    try {
      const response = await HttpUtil.get(`/agv/task/${this.taskId}`);
      if (response.code === 200) {
        this.task = response.data as AgvTask;
        this.isTaskRunning = this.task.taskStatus === AppConstants.TASK_STATUS.RUNNING;
        console.info('[TaskExecuteView] ğŸ“‹ ä»»åŠ¡è¯¦æƒ…åŠ è½½æˆåŠŸ:', JSON.stringify({
          taskId: this.taskId,
          taskStatus: this.task.taskStatus,
          isTaskRunning: this.isTaskRunning,
          expectedRunningStatus: AppConstants.TASK_STATUS.RUNNING
        }));
      }
    } catch (error) {
      console.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
    }
  }

  async loadCameras() {
    try {
      // ä½¿ç”¨å®Œæ•´çš„æ‘„åƒå¤´æœåŠ¡URL
      const cameraUrl = `${AppConstants.CAMERA_BASE_URL}/devices?page=1&size=999`;
      console.info('[TaskExecuteView] ğŸ“¹ è¯·æ±‚æ‘„åƒå¤´è®¾å¤‡åˆ—è¡¨:', cameraUrl);
      
      const response = await HttpUtil.request(cameraUrl, {
        method: http.RequestMethod.GET,
        headers: {
          'Authorization': 'Basic YWRtaW4xMjM6QWRtaW5AMTIz',
          'Content-Type': 'application/json'
        },
        timeout: 10000
      });
      
      if (response.code === 200) {
        interface DeviceItem {
          id: string;
        }
        interface DeviceData {
          rows?: DeviceItem[];
        }
        const deviceData = response.data as DeviceData;
        const devices = deviceData?.rows || [];
        interface CameraInfo {
          id: string;
          name: string;
          url: string;
        }
        this.cameras = devices.map((device: DeviceItem, index: number) => {
          const camera: CameraInfo = {
            id: device.id,
            name: `æ‘„åƒå¤´${index + 1}`,
            url: `${AppConstants.WEBRTC_BASE_URL}/live/${device.id}_01.flv`
          };
          return camera;
        });
        
        if (this.cameras.length > 0) {
          this.switchCamera(0);
        }
      }
    } catch (error) {
      console.error('åŠ è½½æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥:', error);
    } finally {
      this.loading = false;
    }
  }

  switchCamera(index: number) {
    if (index >= 0 && index < this.cameras.length) {
      this.currentCameraIndex = index;
      this.videoUrl = this.cameras[index].url;
    }
  }

  startStatusPolling() {
    this.statusTimer = setInterval(() => {
      this.updateVehicleStatus();
    }, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
  }

  startFlawPolling() {
    this.flawTimer = setInterval(() => {
      this.updateLiveFlaws();
    }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æ•…éšœ
  }

  stopPolling() {
    if (this.statusTimer !== -1) {
      clearInterval(this.statusTimer);
      this.statusTimer = -1;
    }
    if (this.flawTimer !== -1) {
      clearInterval(this.flawTimer);
      this.flawTimer = -1;
    }
  }

  async updateVehicleStatus() {
    try {
      console.info('[TaskExecuteView] ğŸ“Š æ›´æ–°è½¦è¾†çŠ¶æ€');
      
      // è·å–AGVå®æ—¶çŠ¶æ€
      const agvStatusResult = await AgvMovementService.getAgvStatus();
      
      // å®šä¹‰AGVçŠ¶æ€æ•°æ®æ¥å£
      interface AgvStatusData {
        sysTime?: string;
        currentPosition?: number;
        isRunning?: boolean;
      }
      
      const agvStatus = agvStatusResult as AgvStatusData;
      
      // æ„å»ºè½¦è¾†çŠ¶æ€æ•°æ®
      const vehicleStatus: VehicleStatus = {
        taskId: this.taskId,
        systemTime: agvStatus.sysTime || new Date().toLocaleTimeString(),
        distance: agvStatus.currentPosition || 0,
        flawCount: this.liveFlaws.length,
        position: agvStatus.currentPosition || 0,
        isRunning: agvStatus.isRunning || false
      };
      
      this.vehicleStatus = vehicleStatus;
      // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œè¦†ç›–ä»»åŠ¡è¿è¡ŒçŠ¶æ€ï¼Œä»»åŠ¡çŠ¶æ€åº”è¯¥åŸºäºä»»åŠ¡æœ¬èº«è€Œä¸æ˜¯AGVçŠ¶æ€
      // this.isTaskRunning åº”è¯¥åªåœ¨ loadTaskDetail ä¸­è®¾ç½®
      
      console.info('[TaskExecuteView] âœ… è½¦è¾†çŠ¶æ€æ›´æ–°æˆåŠŸ:', JSON.stringify({
        vehicleStatus: vehicleStatus,
        taskRunning: this.isTaskRunning,
        agvRunning: agvStatus.isRunning
      }));
    } catch (error) {
      console.error('[TaskExecuteView] âŒ æ›´æ–°è½¦è¾†çŠ¶æ€å¤±è´¥:', error);
      
      // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€
      const fallbackStatus: VehicleStatus = {
        taskId: this.taskId,
        systemTime: new Date().toLocaleTimeString(),
        distance: 0,
        flawCount: this.liveFlaws.length,
        position: 0,
        isRunning: false
      };
      this.vehicleStatus = fallbackStatus;
    }
  }

  async updateLiveFlaws() {
    try {
      const response = await HttpUtil.get(`/agv/flaw/live/${this.taskId}`);
      if (response.code === 200) {
        interface FlawData {
          flaws?: LiveFlaw[];
        }
        const flawData = response.data as FlawData;
        const newFlaws = flawData?.flaws || [];
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•…éšœ
        if (newFlaws.length > this.liveFlaws.length) {
          promptAction.showToast({
            message: 'å‘ç°æ–°æ•…éšœï¼Œè¯·åŠæ—¶å¤„ç†',
            duration: 3000
          });
        }
        
        this.liveFlaws = newFlaws;
      }
    } catch (error) {
      console.error('æ›´æ–°å®æ—¶æ•…éšœå¤±è´¥:', error);
    }
  }

  async controlVehicle(action: string) {
    try {
      console.info(`[TaskExecuteView] ğŸš— æ§åˆ¶è½¦è¾†: ${action}`);
      
      interface ControlResponse {
        code?: number;
        msg?: string;
      }
      
      let response: ControlResponse;
      switch (action) {
        case 'forward':
          response = await AgvMovementService.agvForward() as ControlResponse;
          break;
        case 'stop':
          response = await AgvMovementService.agvStop() as ControlResponse;
          break;
        case 'backward':
          response = await AgvMovementService.agvBackward() as ControlResponse;
          break;
        default:
          console.warn(`[TaskExecuteView] âš ï¸ æœªçŸ¥çš„æ§åˆ¶æŒ‡ä»¤: ${action}`);
          return;
      }
      
      if (response.code === 200) {
        const actionText = action === 'forward' ? 'å‰è¿›' : action === 'stop' ? 'åœæ­¢' : 'åé€€';
        console.info(`[TaskExecuteView] âœ… è½¦è¾†${actionText}æŒ‡ä»¤å‘é€æˆåŠŸ`);
        
        // ä½¿ç”¨setTimeoutç¡®ä¿åœ¨UIä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒToast
        setTimeout(() => {
          try {
            promptAction.showToast({
              message: `è½¦è¾†${actionText}æŒ‡ä»¤å·²å‘é€`,
              duration: 2000
            });
          } catch (toastError) {
            console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
          }
        }, 0);
      } else {
        throw new Error(`æ§åˆ¶æŒ‡ä»¤è¿”å›é”™è¯¯: ${response.msg || 'æœªçŸ¥é”™è¯¯'}`);
      }
    } catch (error) {
      console.error('[TaskExecuteView] âŒ æ§åˆ¶è½¦è¾†å¤±è´¥:', error);
      
      // ä½¿ç”¨setTimeoutç¡®ä¿åœ¨UIä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒToast
      setTimeout(() => {
        try {
          promptAction.showToast({
            message: 'æ§åˆ¶æŒ‡ä»¤å‘é€å¤±è´¥',
            duration: 2000
          });
        } catch (toastError) {
          console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
        }
      }, 0);
    }
  }

  async finishTask() {
    try {
      console.info('[TaskExecuteView] ğŸ å®Œæˆä»»åŠ¡');
      
      // å…ˆåœæ­¢AGVç¡®ä¿å®‰å…¨
      await AgvMovementService.agvStop();
      console.info('[TaskExecuteView] âœ… AGVå·²åœæ­¢');
      
      const response = await HttpUtil.post(`/agv/task/end/${this.taskId}?isAbort=false`);
      if (response.code === 200) {
        promptAction.showToast({
          message: 'ä»»åŠ¡å·²å®Œæˆ',
          duration: 2000
        });
        
        this.stopPolling();
        this.isTaskRunning = false;
        
        console.info('[TaskExecuteView] âœ… ä»»åŠ¡å®ŒæˆæˆåŠŸ');
        
        // è·³è½¬åˆ°ä»»åŠ¡è¯¦æƒ…é¡µé¢
        router.replaceUrl({
          url: 'pages/TaskDetailView',
          params: {
            taskId: this.taskId
          }
        });
      }
    } catch (error) {
      console.error('[TaskExecuteView] âŒ å®Œæˆä»»åŠ¡å¤±è´¥:', error);
      promptAction.showToast({
        message: 'å®Œæˆä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  async abortTask() {
    try {
      console.info('[TaskExecuteView] ğŸ›‘ ç»ˆæ­¢ä»»åŠ¡');
      
      // ç´§æ€¥åœæ­¢AGV
      await AgvMovementService.emergencyStop();
      console.info('[TaskExecuteView] âœ… AGVç´§æ€¥åœæ­¢æˆåŠŸ');
      
      const response = await HttpUtil.post(`/agv/task/end/${this.taskId}?isAbort=true`);
      if (response.code === 200) {
        promptAction.showToast({
          message: 'ä»»åŠ¡å·²ç»ˆæ­¢',
          duration: 2000
        });
        
        this.stopPolling();
        this.isTaskRunning = false;
        
        console.info('[TaskExecuteView] âœ… ä»»åŠ¡ç»ˆæ­¢æˆåŠŸ');
        
        router.back();
      }
    } catch (error) {
      console.error('[TaskExecuteView] âŒ ç»ˆæ­¢ä»»åŠ¡å¤±è´¥:', error);
      promptAction.showToast({
        message: 'ç»ˆæ­¢ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  refreshVideo() {
    if (this.cameras.length > 0) {
      this.videoUrl = this.cameras[this.currentCameraIndex].url + '?t=' + Date.now();
    }
  }

  openFlawDetail(flaw: LiveFlaw) {
    this.selectedFlaw = flaw;
    this.showFlawDetail = true;
  }

  closeFlawDetail() {
    this.showFlawDetail = false;
    this.selectedFlaw = null;
  }

  getFlawStatusColor(status: string): string {
    switch (status) {
      case 'confirmed':
        return '#f56c6c';
      case 'suspected':
        return '#e6a23c';
      default:
        return '#909399';
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('â† è¿”å›')
          .fontSize(14)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .backgroundColor('transparent')
          .onClick(() => {
            this.stopPolling();
            router.back();
          })
        
        Text('ä»»åŠ¡æ‰§è¡Œ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')
      .border({ width: { bottom: 1 }, color: '#eeeeee' })

      if (this.loading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color(AppConstants.COLORS.PRIMARY)
          
          Text('æ­£åœ¨è¿æ¥è®¾å¤‡...')
            .fontSize(14)
            .fontColor(AppConstants.COLORS.TEXT_REGULAR)
            .margin({ top: 10 })
        }
        .width('100%')
        .height('100%')

        .alignItems(HorizontalAlign.Center)
      } else {
        // ä¸»è¦å†…å®¹
        Row() {
          // å·¦ä¾§è§†é¢‘åŒºåŸŸ
          Column() {
            // è§†é¢‘æ’­æ”¾å™¨
            Stack() {
              if (this.videoUrl) {
                Video({
                  src: this.videoUrl
                })
                  .width('100%')
                  .height(450)
                  .autoPlay(true)
                  .controls(false)
                  .objectFit(ImageFit.Contain)
                  .backgroundColor('#000000')
              } else {
                Column() {
                  Text('ğŸ“¹')
                    .fontSize(48)
                    .fontColor('#cccccc')
                  Text('è§†é¢‘åŠ è½½ä¸­...')
                    .fontSize(16)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .margin({ top: 10 })
                }
                .width('100%')
                .height(450)
          
                .alignItems(HorizontalAlign.Center)
                .backgroundColor('#f5f5f5')
              }

              // è§†é¢‘æ§åˆ¶æŒ‰é’®
              Row() {
                Button('ğŸ”„ åˆ·æ–°')
                  .fontSize(12)
                  .fontColor('#ffffff')
                  .backgroundColor('rgba(0,0,0,0.6)')
                  .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
                  .borderRadius(4)
                  .onClick(() => this.refreshVideo())

                Button(this.isAudioEnabled ? 'ğŸ”Š' : 'ğŸ”‡')
                  .fontSize(12)
                  .fontColor('#ffffff')
                  .backgroundColor('rgba(0,0,0,0.6)')
                  .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
                  .borderRadius(4)
                  .margin({ left: 10 })
                  .onClick(() => {
                    this.isAudioEnabled = !this.isAudioEnabled;
                  })
              }
              .position({ x: 10, y: 10 })
            }
            .width('100%')
            .borderRadius(8)
            .border({ width: 1, color: '#dddddd' })

            // æ‘„åƒå¤´åˆ‡æ¢
            Row() {
              ForEach(this.cameras, (camera: Camera, index: number) => {
                Button(camera.name)
                  .fontSize(14)
                  .fontColor(index === this.currentCameraIndex ? '#ffffff' : AppConstants.COLORS.TEXT_PRIMARY)
                  .backgroundColor(index === this.currentCameraIndex ? AppConstants.COLORS.PRIMARY : '#ffffff')
                  .border({ width: 1, color: index === this.currentCameraIndex ? AppConstants.COLORS.PRIMARY : '#dddddd' })
                  .borderRadius(4)
                  .margin({ right: 10 })
                  .onClick(() => this.switchCamera(index))
              }, (camera: Camera) => camera.id)
            }
            .width('100%')
            .padding(15)
      

            // æ§åˆ¶æŒ‰é’®
            Row() {
              Button('â¬…ï¸ åé€€')
                .fontSize(14)
                .fontColor('#ffffff')
                .backgroundColor('#909399')
                .border({ width: 1, color: '#909399' })
                .enabled(this.isTaskRunning)
                .onClick(() => this.controlVehicle('backward'))

              Button('â¹ï¸ åœæ­¢')
                .fontSize(14)
                .fontColor('#ffffff')
                .backgroundColor('#f56c6c')
                .border({ width: 1, color: '#f56c6c' })
                .margin({ left: 15, right: 15 })
                .enabled(this.isTaskRunning)
                .onClick(() => this.controlVehicle('stop'))

              Button('â¡ï¸ å‰è¿›')
                .fontSize(14)
                .fontColor('#ffffff')
                .backgroundColor(AppConstants.COLORS.SUCCESS)
                .border({ width: 1, color: AppConstants.COLORS.SUCCESS })
                .enabled(this.isTaskRunning)
                .onClick(() => this.controlVehicle('forward'))
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ top: 20 })

            // ä»»åŠ¡æ§åˆ¶
            Row() {
              Button('âœ… å®Œæˆå·¡æ£€')
                .fontSize(16)
                .fontColor('#ffffff')
                .backgroundColor(AppConstants.COLORS.SUCCESS)
                .border({ width: 1, color: AppConstants.COLORS.SUCCESS })
                .layoutWeight(1)
                .enabled(this.isTaskRunning)
                .onClick(() => this.finishTask())

              Button('âŒ ç»ˆæ­¢å·¡æ£€')
                .fontSize(16)
                .fontColor('#ffffff')
                .backgroundColor('#f56c6c')
                .border({ width: 1, color: '#f56c6c' })
                .layoutWeight(1)
                .margin({ left: 15 })
                .enabled(this.isTaskRunning)
                .onClick(() => this.abortTask())
            }
            .width('100%')
            .margin({ top: 20 })
          }
          .layoutWeight(1)
          .padding(20)

          // å³ä¾§çŠ¶æ€åŒºåŸŸ
          Column() {
            // ä»»åŠ¡ä¿¡æ¯
            if (this.task) {
              Column() {
                Text('ä»»åŠ¡ä¿¡æ¯')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 15 })

                Row() {
                  Text('ä»»åŠ¡ç¼–å·:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  Text(this.task.taskCode)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                }
                .width('100%')
                .margin({ bottom: 8 })

                Row() {
                  Text('ä»»åŠ¡åç§°:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  Text(this.task.taskName)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                }
                .width('100%')
                .margin({ bottom: 8 })

                Row() {
                  Text('çŠ¶æ€:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  Text(this.isTaskRunning ? 'å·¡è§†ä¸­' : 'å·²åœæ­¢')
                    .fontSize(14)
                    .fontColor(this.isTaskRunning ? AppConstants.COLORS.SUCCESS : '#f56c6c')
                }
                .width('100%')
              }
              .width('100%')
              .padding(15)
              .backgroundColor('#ffffff')
              .borderRadius(8)
              .border({ width: 1, color: '#eeeeee' })
              .margin({ bottom: 20 })
            }

            // è½¦è¾†çŠ¶æ€
            if (this.vehicleStatus) {
              Column() {
                Text('è½¦è¾†çŠ¶æ€')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 15 })

                Row() {
                  Column() {
                    Text(this.vehicleStatus.systemTime)
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                    Text('ç³»ç»Ÿæ—¶é—´')
                      .fontSize(12)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                }
                .layoutWeight(1)

                Column() {
                  Text(`${this.vehicleStatus.distance}m`)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  Text('è¡Œé©¶è·ç¦»')
                    .fontSize(12)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                }
                .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 15 })

              Row() {
                Column() {
                  Text(this.vehicleStatus.flawCount.toString())
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#f56c6c')
                  Text('æ•…éšœæ•°é‡')
                    .fontSize(12)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                }
                .layoutWeight(1)

                Column() {
                  Text(`${Math.min(Math.max(Math.round(this.vehicleStatus.position / 10), 0), 100)}%`)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(AppConstants.COLORS.PRIMARY)
                  Text('å·¡æ£€è¿›åº¦')
                    .fontSize(12)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                }
                .layoutWeight(1)
              }
              .width('100%')
            }
            .width('100%')
            .padding(15)
            .backgroundColor('#ffffff')
            .borderRadius(8)
            .border({ width: 1, color: '#eeeeee' })
            .margin({ bottom: 20 })
          }

          // è¿›åº¦æ¡
          if (this.vehicleStatus) {
            Column() {
              Text('å·¡æ£€è¿›åº¦')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 15 })

              Stack() {
                // è¿›åº¦æ¡èƒŒæ™¯
                Row()
                  .width('100%')
                  .height(8)
                  .backgroundColor('#f0f0f0')
                  .borderRadius(4)

                // è¿›åº¦æ¡å¡«å……
                Row()
                  .width(`${Math.min(Math.max(Math.round(this.vehicleStatus.position / 10), 0), 100)}%`)
                  .height(8)
                  .backgroundColor(AppConstants.COLORS.PRIMARY)
                  .borderRadius(4)

                // è½¦è¾†ä½ç½®æ ‡è®°
                Text('ğŸš›')
                  .fontSize(20)
                  .position({ x: `${Math.min(Math.max(Math.round(this.vehicleStatus.position / 10), 0), 100)}%`, y: -6 })

                // æ•…éšœæ ‡è®°
                ForEach(this.liveFlaws, (flaw: LiveFlaw) => {
                  Button()
                    .width(12)
                    .height(12)
                    .borderRadius(6)
                    .backgroundColor(this.getFlawStatusColor(flaw.status))
                    .position({ x: `${flaw.position}%`, y: -2 })
                    .onClick(() => this.openFlawDetail(flaw))
                }, (flaw: LiveFlaw) => flaw.id.toString())
              }
              .width('100%')
              .height(20)
              .margin({ bottom: 20 })
            }
            .width('100%')
            .padding(15)
            .backgroundColor('#ffffff')
            .borderRadius(8)
            .border({ width: 1, color: '#eeeeee' })
            .margin({ bottom: 20 })
          }

          // å®æ—¶æ•…éšœåˆ—è¡¨
          Column() {
            Text('å®æ—¶æ•…éšœ')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 15 })

            if (this.liveFlaws.length === 0) {
              Text('æš‚æ— æ•…éšœ')
                .fontSize(14)
                .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                .textAlign(TextAlign.Center)
                .width('100%')
                .padding(20)
            } else {
              List() {
                ForEach(this.liveFlaws, (flaw: LiveFlaw) => {
                  ListItem() {
                    Row() {
                      Column() {
                        Text(flaw.flawName)
                          .fontSize(14)
                          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                          .fontWeight(FontWeight.Medium)
                        Text(flaw.flawType)
                          .fontSize(12)
                          .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                          .margin({ top: 4 })
                      }
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)

                      Text('ğŸ“')
                        .fontSize(16)
                        .fontColor(this.getFlawStatusColor(flaw.status))
                    }
                    .width('100%')
                    .padding(12)
                    .backgroundColor('#ffffff')
                    .border({ width: 1, color: '#eeeeee' })
                    .borderRadius(6)
                    .onClick(() => this.openFlawDetail(flaw))
                  }
                  .margin({ bottom: 8 })
                }, (flaw: LiveFlaw) => flaw.id.toString())
              }
              .width('100%')
              .height(200)
            }
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .border({ width: 1, color: '#eeeeee' })
        }
        .width(400)
        .padding(20)
      }
      .width('100%')
      .layoutWeight(1)
      .alignItems(VerticalAlign.Top)
    }

    // æ•…éšœè¯¦æƒ…æ¨¡æ€æ¡†
    if (this.showFlawDetail && this.selectedFlaw) {
      Stack() {
        Column() {
          // æ¨¡æ€æ¡†æ ‡é¢˜
          Row() {
            Text('å®æ—¶æ•…éšœè¯¦æƒ…')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .layoutWeight(1)
            
            Button('âœ•')
              .fontSize(16)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .backgroundColor('transparent')
              .onClick(() => this.closeFlawDetail())
          }
          .width('100%')
          .padding(20)
          .border({ width: { bottom: 1 }, color: '#eeeeee' })

          // æ¨¡æ€æ¡†å†…å®¹
          Column() {
            Text(`æ•…éšœåç§°: ${this.selectedFlaw.flawName}`)
              .fontSize(16)
              .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
              .margin({ bottom: 10 })

            Text(`æ•…éšœç±»å‹: ${this.selectedFlaw.flawType}`)
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .margin({ bottom: 10 })

            Text(`å‘ç°æ—¶é—´: ${this.selectedFlaw.createTime}`)
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .margin({ bottom: 20 })

            Text('è¯·åœ¨ä»»åŠ¡å®Œæˆåè¿›è¡Œè¯¦ç»†ç¡®è®¤')
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
              .textAlign(TextAlign.Center)
          }
          .width('100%')
          .padding(20)
          .alignItems(HorizontalAlign.Start)
        }
        .width(500)
        .height(300)
        .backgroundColor('#ffffff')
        .borderRadius(8)
        .shadow({ radius: 12, color: 'rgba(0,0,0,0.2)', offsetX: 0, offsetY: 4 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('rgba(0,0,0,0.5)')
      .onClick(() => this.closeFlawDetail())
    }
  }
  .width('100%')
  .height('100%')
  .backgroundColor(AppConstants.COLORS.BACKGROUND_BASE)
}
}