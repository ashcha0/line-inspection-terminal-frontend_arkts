import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import http from '@ohos.net.http';
import { HttpUtil } from '../utils/HttpUtil';
import { AppConstants } from '../constants/AppConstants';
import { AgvMovementService } from '../services/AgvMovementService';
import { AgvTask } from '../services/TaskService';
import { CameraService, CameraInfo } from '../services/CameraService';
import { FlawService, AgvFlaw } from '../services/FlawService';

// æ‘„åƒå¤´æ¥å£ï¼ˆä½¿ç”¨CameraServiceä¸­çš„CameraInfoï¼‰
type Camera = CameraInfo;

// æ‘„åƒå¤´ä¿¡æ¯é¡¹æ¥å£
interface CameraInfoItem {
  id: string;
  name: string;
}

// æ‘„åƒå¤´åŠ è½½æ—¥å¿—ä¿¡æ¯æ¥å£
interface CameraLoadLogInfo {
  cameraCount: number;
  cameras: CameraInfoItem[];
}

// è½¦è¾†çŠ¶æ€æ¥å£
interface VehicleStatus {
  taskId: number;
  systemTime: string;
  distance: number;
  flawCount: number;
  position: number;
  isRunning: boolean;
}

// æ•…éšœæ¥å£ - ä½¿ç”¨FlawServiceä¸­çš„AgvFlawæ¥å£
type LiveFlaw = AgvFlaw;

// æ–°æ•…éšœå¼¹çª—çŠ¶æ€æ¥å£
interface NewFlawAlert {
  show: boolean;
  flaw: LiveFlaw | null;
}

// è·¯ç”±å‚æ•°æ¥å£
interface RouterParamsData {
  taskId: number;
}

interface RouterParams {
  url: string;
  params: RouterParamsData;
}

// ä½¿ç”¨AgvTaskæ¥å£æ›¿ä»£æœ¬åœ°Taskæ¥å£

@Entry
@Component
struct TaskExecuteView {
  @State task: AgvTask | null = null;
  @State vehicleStatus: VehicleStatus | null = null;
  @State liveFlaws: LiveFlaw[] = [];
  @State cameras: Camera[] = [];
  @State currentCameraIndex: number = 0;
  @State videoUrl: string = '';
  @State showFlawDetail: boolean = false;
  @State selectedFlaw: LiveFlaw | null = null;
  @State isAudioEnabled: boolean = true;
  @State loading: boolean = true;
  @State isTaskRunning: boolean = false;
  @State cameraConnectionStatus: string = 'æ£€æµ‹ä¸­...';
  @State lastCameraCheck: string = '';
  @State newFlawAlert: NewFlawAlert = { show: false, flaw: null };
  @State lastFlawCount: number = 0;
  
  private taskId: number = 0;
  private statusTimer: number = -1;
  private flawTimer: number = -1;
  private cameraTimer: number = -1;

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params && params['taskId']) {
      this.taskId = params['taskId'] as number;
      this.loadTaskDetail();
      this.loadCameras();
      this.startStatusPolling();
      this.startFlawPolling();
      // ç§»é™¤æ‘„åƒå¤´è½®è¯¢ï¼Œæ”¹ä¸ºæ‰‹åŠ¨åˆ·æ–°
      // this.startCameraPolling();
    }
  }

  aboutToDisappear() {
    this.stopPolling();
  }



  async loadTaskDetail() {
    try {
      const response = await HttpUtil.get(`/agv/task/${this.taskId}`);
      if (response.code === 200) {
        this.task = response.data as AgvTask;
        this.isTaskRunning = this.task.taskStatus === AppConstants.TASK_STATUS.RUNNING;
        console.info('[TaskExecuteView] ğŸ“‹ ä»»åŠ¡è¯¦æƒ…åŠ è½½æˆåŠŸ:', JSON.stringify({
          taskId: this.taskId,
          taskStatus: this.task.taskStatus,
          isTaskRunning: this.isTaskRunning,
          expectedRunningStatus: AppConstants.TASK_STATUS.RUNNING
        }));
      }
    } catch (error) {
      console.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
    }
  }

  async loadCameras() {
    try {
      console.info('[TaskExecuteView] ğŸ“¹ å¼€å§‹åŠ è½½æ‘„åƒå¤´åˆ—è¡¨');
      
      // ä½¿ç”¨CameraServiceè·å–æ‘„åƒå¤´ä¿¡æ¯åˆ—è¡¨
      this.cameras = await CameraService.getCameraInfoList();
      
      const logInfo: CameraLoadLogInfo = {
        cameraCount: this.cameras.length,
        cameras: this.cameras.map((c: CameraInfo): CameraInfoItem => ({ id: c.id, name: c.name }))
      };
      console.info('[TaskExecuteView] âœ… æ‘„åƒå¤´åˆ—è¡¨åŠ è½½æˆåŠŸ:', JSON.stringify(logInfo));
      
      // å¦‚æœæœ‰æ‘„åƒå¤´ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªå¹¶å¼€å§‹æ’­æ”¾
      if (this.cameras.length > 0) {
        this.switchCamera(0);
        console.info('[TaskExecuteView] ğŸ¥ é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ‘„åƒå¤´:', this.cameras[0].name);
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        setTimeout(() => {
          try {
            promptAction.showToast({
              message: `å·²è¿æ¥${this.cameras.length}ä¸ªæ‘„åƒå¤´ï¼Œå¼€å§‹å®æ—¶ç›‘æ§`,
              duration: 2000
            });
          } catch (toastError) {
            console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
          }
        }, 0);
      } else {
        console.warn('[TaskExecuteView] âš ï¸ æœªå‘ç°å¯ç”¨æ‘„åƒå¤´');
        
        // æ˜¾ç¤ºæ— æ‘„åƒå¤´æç¤º
        setTimeout(() => {
          try {
            promptAction.showToast({
              message: 'æœªå‘ç°å¯ç”¨æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥',
              duration: 3000
            });
          } catch (toastError) {
            console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
          }
        }, 0);
      }
    } catch (error) {
      console.error('[TaskExecuteView] âŒ åŠ è½½æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥:', error);
      
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      setTimeout(() => {
        try {
          promptAction.showToast({
            message: 'æ‘„åƒå¤´æœåŠ¡è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡çŠ¶æ€',
            duration: 3000
          });
        } catch (toastError) {
          console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
        }
      }, 0);
    } finally {
      this.loading = false;
    }
  }

  switchCamera(index: number) {
    if (index >= 0 && index < this.cameras.length) {
      this.currentCameraIndex = index;
      this.videoUrl = this.cameras[index].url;
      
      console.info('[TaskExecuteView] ğŸ”„ åˆ‡æ¢æ‘„åƒå¤´:', JSON.stringify({
        cameraIndex: index,
        cameraId: this.cameras[index].id,
        cameraName: this.cameras[index].name,
        videoUrl: this.videoUrl
      }));
    } else {
      console.warn('[TaskExecuteView] âš ï¸ æ— æ•ˆçš„æ‘„åƒå¤´ç´¢å¼•:', index);
    }
  }

  startStatusPolling() {
    this.statusTimer = setInterval(() => {
      this.updateVehicleStatus();
    }, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
  }

  startFlawPolling() {
    this.flawTimer = setInterval(() => {
      this.updateLiveFlaws();
    }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æ•…éšœ
  }

  // ç§»é™¤è‡ªåŠ¨æ‘„åƒå¤´è½®è¯¢ï¼Œæ”¹ä¸ºæ‰‹åŠ¨åˆ·æ–°
  // startCameraPolling() {
  //   this.cameraTimer = setInterval(() => {
  //     this.checkCameraConnection();
  //   }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡æ‘„åƒå¤´è¿æ¥çŠ¶æ€
  // }

  stopPolling() {
    if (this.statusTimer !== -1) {
      clearInterval(this.statusTimer);
      this.statusTimer = -1;
    }
    if (this.flawTimer !== -1) {
      clearInterval(this.flawTimer);
      this.flawTimer = -1;
    }
    // ç§»é™¤æ‘„åƒå¤´å®šæ—¶å™¨ç›¸å…³é€»è¾‘
    // if (this.cameraTimer !== -1) {
    //   clearInterval(this.cameraTimer);
    //   this.cameraTimer = -1;
    // }
  }

  async updateVehicleStatus() {
    try {
      console.info('[TaskExecuteView] ğŸ“Š æ›´æ–°è½¦è¾†çŠ¶æ€');
      
      // è·å–AGVå®æ—¶çŠ¶æ€
      const agvStatusResult = await AgvMovementService.getAgvStatus();
      
      // å®šä¹‰AGVçŠ¶æ€æ•°æ®æ¥å£
      interface AgvStatusData {
        sysTime?: string;
        currentPosition?: number;
        isRunning?: boolean;
      }
      
      const agvStatus = agvStatusResult as AgvStatusData;
      
      // æ„å»ºè½¦è¾†çŠ¶æ€æ•°æ®
      const vehicleStatus: VehicleStatus = {
        taskId: this.taskId,
        systemTime: agvStatus.sysTime || new Date().toLocaleTimeString(),
        distance: agvStatus.currentPosition || 0,
        flawCount: this.liveFlaws.length,
        position: agvStatus.currentPosition || 0,
        isRunning: agvStatus.isRunning || false
      };
      
      this.vehicleStatus = vehicleStatus;
      // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œè¦†ç›–ä»»åŠ¡è¿è¡ŒçŠ¶æ€ï¼Œä»»åŠ¡çŠ¶æ€åº”è¯¥åŸºäºä»»åŠ¡æœ¬èº«è€Œä¸æ˜¯AGVçŠ¶æ€
      // this.isTaskRunning åº”è¯¥åªåœ¨ loadTaskDetail ä¸­è®¾ç½®
      
      console.info('[TaskExecuteView] âœ… è½¦è¾†çŠ¶æ€æ›´æ–°æˆåŠŸ:', JSON.stringify({
        vehicleStatus: vehicleStatus,
        taskRunning: this.isTaskRunning,
        agvRunning: agvStatus.isRunning
      }));
    } catch (error) {
      console.error('[TaskExecuteView] âŒ æ›´æ–°è½¦è¾†çŠ¶æ€å¤±è´¥:', error);
      
      // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€
      const fallbackStatus: VehicleStatus = {
        taskId: this.taskId,
        systemTime: new Date().toLocaleTimeString(),
        distance: 0,
        flawCount: this.liveFlaws.length,
        position: 0,
        isRunning: false
      };
      this.vehicleStatus = fallbackStatus;
    }
  }

  async updateLiveFlaws() {
    try {
      console.info('[TaskExecuteView] ğŸ”„ æ›´æ–°å®æ—¶æ•…éšœæ•°æ®');
      console.info(`[TaskExecuteView] ğŸ“Š è¯·æ±‚å‚æ•° - taskId: ${this.taskId}`);
      console.info(`[TaskExecuteView] ğŸ“Š å½“å‰æ•…éšœè®¡æ•°: ${this.lastFlawCount}`);
      
      // æµ‹è¯•ï¼šåŒæ—¶ä½¿ç”¨ä¸¤ä¸ªæ¥å£è·å–æ•…éšœæ•°æ®è¿›è¡Œå¯¹æ¯”
      console.info(`[TaskExecuteView] ğŸ“Š æµ‹è¯• - ä½¿ç”¨å®æ—¶æ¥å£: /agv/flaw/live/${this.taskId}`);
      const liveFlaws = await FlawService.liveInfo(this.taskId);
      console.info(`[TaskExecuteView] ğŸ“Š å®æ—¶æ¥å£è¿”å›æ•°æ®: ${JSON.stringify(liveFlaws)}`);
      
      console.info(`[TaskExecuteView] ğŸ“Š æµ‹è¯• - ä½¿ç”¨åˆ—è¡¨æ¥å£: /agv/flaw/list?taskId=${this.taskId}`);
      const listResponse = await HttpUtil.get(`/agv/flaw/list?taskId=${this.taskId}`);
      console.info(`[TaskExecuteView] ğŸ“Š åˆ—è¡¨æ¥å£å“åº”: ${JSON.stringify(listResponse)}`);
      
      // å®šä¹‰å“åº”æ•°æ®ç±»å‹
      interface TableDataInfo {
        total?: number;
        rows?: LiveFlaw[];
      }
      
      let newFlaws: LiveFlaw[] = [];
      if (listResponse.code === 200 && listResponse.data) {
        const responseData = listResponse.data as TableDataInfo;
        if (responseData && Array.isArray(responseData.rows)) {
          newFlaws = responseData.rows;
          console.info(`[TaskExecuteView] ğŸ“Š ä½¿ç”¨åˆ—è¡¨æ¥å£æ•°æ®ï¼Œæ•…éšœæ•°é‡: ${newFlaws.length}`);
        } else {
          newFlaws = liveFlaws;
          console.info(`[TaskExecuteView] ğŸ“Š åˆ—è¡¨æ¥å£æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨å®æ—¶æ¥å£æ•°æ®ï¼Œæ•…éšœæ•°é‡: ${newFlaws.length}`);
        }
      } else {
        newFlaws = liveFlaws;
        console.info(`[TaskExecuteView] ğŸ“Š åˆ—è¡¨æ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å®æ—¶æ¥å£æ•°æ®ï¼Œæ•…éšœæ•°é‡: ${newFlaws.length}`);
      }
      
      // è¯¦ç»†è®°å½•å“åº”æ•°æ®
      console.info(`[TaskExecuteView] ğŸ“Š å“åº”æ•°æ®ç±»å‹: ${typeof newFlaws}`);
      console.info(`[TaskExecuteView] ğŸ“Š å“åº”æ•°æ®é•¿åº¦: ${Array.isArray(newFlaws) ? newFlaws.length : 'N/A'}`);
      console.info(`[TaskExecuteView] ğŸ“Š å“åº”æ•°æ®å†…å®¹: ${JSON.stringify(newFlaws)}`);
      
      if (Array.isArray(newFlaws) && newFlaws.length > 0) {
        console.info(`[TaskExecuteView] ğŸ“Š æ•…éšœè¯¦æƒ…åˆ—è¡¨:`);
        newFlaws.forEach((flaw, index) => {
          console.info(`[TaskExecuteView] ğŸ“Š æ•…éšœ${index + 1}: ID=${flaw.id}, åç§°=${flaw.flawName}, ç±»å‹=${flaw.flawType}, ç¡®è®¤çŠ¶æ€=${flaw.confirmed ? 'å·²ç¡®è®¤' : 'å¾…ç¡®è®¤'}`);
        });
      } else {
        console.info(`[TaskExecuteView] ğŸ“Š å½“å‰ä»»åŠ¡æ— æ•…éšœæ•°æ®æˆ–å“åº”æ ¼å¼å¼‚å¸¸`);
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•…éšœ
      if (newFlaws.length > this.lastFlawCount) {
        const newFlawsAdded = newFlaws.slice(this.lastFlawCount);
        
        console.info(`[TaskExecuteView] ğŸš¨ æ£€æµ‹åˆ°æ–°æ•…éšœ: ä¹‹å‰${this.lastFlawCount}ä¸ªï¼Œç°åœ¨${newFlaws.length}ä¸ªï¼Œæ–°å¢${newFlawsAdded.length}ä¸ª`);
        
        // æ˜¾ç¤ºæ–°æ•…éšœæç¤º
        setTimeout(() => {
          try {
            promptAction.showToast({
              message: `å‘ç°${newFlawsAdded.length}ä¸ªæ–°æ•…éšœï¼Œè¯·åŠæ—¶å¤„ç†`,
              duration: 3000
            });
          } catch (toastError) {
            console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
          }
        }, 0);
        
        // å¦‚æœæœ‰æ–°æ•…éšœï¼Œæ˜¾ç¤ºå¼¹çª—æé†’ç¬¬ä¸€ä¸ªæ–°æ•…éšœ
        if (newFlawsAdded.length > 0) {
          this.showNewFlawAlert(newFlawsAdded[0]);
          console.info(`[TaskExecuteView] ğŸ”” æ˜¾ç¤ºæ–°æ•…éšœå¼¹çª—: ${newFlawsAdded[0].flawName}`);
        }
        
        console.info(`[TaskExecuteView] ğŸš¨ æ–°å¢æ•…éšœåˆ—è¡¨: ${newFlawsAdded.map(f => f.flawName).join(', ')}`);
      } else {
        console.info(`[TaskExecuteView] ğŸ“Š æ•…éšœæ•°é‡æ— å˜åŒ–: ${newFlaws.length}`);
      }
      
      this.liveFlaws = newFlaws;
      this.lastFlawCount = newFlaws.length;
      
      console.info(`[TaskExecuteView] âœ… å®æ—¶æ•…éšœæ•°æ®æ›´æ–°å®Œæˆ - å½“å‰æ•…éšœæ•°: ${newFlaws.length}, ä¸Šæ¬¡è®¡æ•°: ${this.lastFlawCount}`);
    } catch (error) {
      console.error('[TaskExecuteView] âŒ æ›´æ–°å®æ—¶æ•…éšœå¤±è´¥:', error);
      console.error(`[TaskExecuteView] ğŸ“Š é”™è¯¯è¯¦æƒ… - taskId: ${this.taskId}, é”™è¯¯ç±»å‹: ${typeof error}`);
      console.error(`[TaskExecuteView] ğŸ“Š é”™è¯¯å†…å®¹: ${JSON.stringify(error)}`);
    }
  }

  async controlVehicle(action: string) {
    try {
      console.info(`[TaskExecuteView] ğŸš— æ§åˆ¶è½¦è¾†: ${action}`);
      
      interface ControlResponse {
        code?: number;
        msg?: string;
      }
      
      let response: ControlResponse;
      switch (action) {
        case 'forward':
          response = await AgvMovementService.agvForward() as ControlResponse;
          break;
        case 'stop':
          response = await AgvMovementService.agvStop() as ControlResponse;
          break;
        case 'backward':
          response = await AgvMovementService.agvBackward() as ControlResponse;
          break;
        default:
          console.warn(`[TaskExecuteView] âš ï¸ æœªçŸ¥çš„æ§åˆ¶æŒ‡ä»¤: ${action}`);
          return;
      }
      
      if (response.code === 200) {
        const actionText = action === 'forward' ? 'å‰è¿›' : action === 'stop' ? 'åœæ­¢' : 'åé€€';
        console.info(`[TaskExecuteView] âœ… è½¦è¾†${actionText}æŒ‡ä»¤å‘é€æˆåŠŸ`);
        
        // ä½¿ç”¨setTimeoutç¡®ä¿åœ¨UIä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒToast
        setTimeout(() => {
          try {
            promptAction.showToast({
              message: `è½¦è¾†${actionText}æŒ‡ä»¤å·²å‘é€`,
              duration: 2000
            });
          } catch (toastError) {
            console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
          }
        }, 0);
      } else {
        throw new Error(`æ§åˆ¶æŒ‡ä»¤è¿”å›é”™è¯¯: ${response.msg || 'æœªçŸ¥é”™è¯¯'}`);
      }
    } catch (error) {
      console.error('[TaskExecuteView] âŒ æ§åˆ¶è½¦è¾†å¤±è´¥:', error);
      
      // ä½¿ç”¨setTimeoutç¡®ä¿åœ¨UIä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒToast
      setTimeout(() => {
        try {
          promptAction.showToast({
            message: 'æ§åˆ¶æŒ‡ä»¤å‘é€å¤±è´¥',
            duration: 2000
          });
        } catch (toastError) {
          console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
        }
      }, 0);
    }
  }

  async finishTask() {
    try {
      console.info('[finishTask] ğŸ å®Œæˆä»»åŠ¡ - å¼€å§‹æ‰§è¡Œ');
      console.info('[finishTask] ğŸ“Š å½“å‰çŠ¶æ€ taskId:', this.taskId);
      console.info('[finishTask] ğŸ“Š å½“å‰çŠ¶æ€ isTaskRunning:', this.isTaskRunning);
      console.info('[finishTask] ğŸ“Š å½“å‰çŠ¶æ€ timestamp:', new Date().toISOString());
      
      // å…ˆåœæ­¢AGVç¡®ä¿å®‰å…¨
      console.info('[finishTask] ğŸ›‘ æ­£åœ¨åœæ­¢AGV...');
      await AgvMovementService.agvStop();
      console.info('[finishTask] âœ… AGVå·²åœæ­¢');
      
      // è°ƒç”¨åç«¯æ¥å£ç»“æŸä»»åŠ¡
      console.info('[finishTask] ğŸ“¡ æ­£åœ¨è°ƒç”¨åç«¯æ¥å£ç»“æŸä»»åŠ¡...');
      const endTaskUrl = `/agv/task/end/${this.taskId}?isAbort=false`;
      console.info('[finishTask] ğŸ”— è¯·æ±‚URL:', endTaskUrl);
      
      const response = await HttpUtil.post(endTaskUrl);
      console.info('[finishTask] ğŸ“¥ åç«¯å“åº” code:', response.code);
      console.info('[finishTask] ğŸ“¥ åç«¯å“åº” message:', response.msg);
      console.info('[finishTask] ğŸ“¥ åç«¯å“åº” timestamp:', new Date().toISOString());
      
      if (response.code === 200) {
        console.info('[finishTask] âœ… åç«¯ä»»åŠ¡ç»“æŸæˆåŠŸ');
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        try {
          promptAction.showToast({
            message: 'ä»»åŠ¡å·²å®Œæˆ',
            duration: 2000
          });
          console.info('[finishTask] âœ… æˆåŠŸæç¤ºå·²æ˜¾ç¤º');
        } catch (toastError) {
          console.warn('[finishTask] âš ï¸ æ˜¾ç¤ºæç¤ºå¤±è´¥:', toastError);
        }
        
        // åœæ­¢è½®è¯¢å’Œæ›´æ–°çŠ¶æ€
        console.info('[finishTask] ğŸ”„ æ­£åœ¨åœæ­¢è½®è¯¢å’Œæ›´æ–°çŠ¶æ€...');
        this.stopPolling();
        this.isTaskRunning = false;
        console.info('[finishTask] âœ… è½®è¯¢å·²åœæ­¢ï¼ŒçŠ¶æ€å·²æ›´æ–°');
        
        // å‡†å¤‡é¡µé¢è·³è½¬å‚æ•°
        const routerParams: RouterParams = {
          url: 'pages/TaskReviewView',
          params: {
            taskId: this.taskId
          }
        };
        console.info('[finishTask] ğŸ”„ å‡†å¤‡é¡µé¢è·³è½¬ url:', routerParams.url);
        console.info('[finishTask] ğŸ”„ å‡†å¤‡é¡µé¢è·³è½¬ taskId:', routerParams.params.taskId);
        
        // å»¶è¿Ÿæ‰§è¡Œé¡µé¢è·³è½¬ï¼Œç¡®ä¿UIä¸Šä¸‹æ–‡ç¨³å®š
        setTimeout(() => {
          try {
            console.info('[finishTask] ğŸš€ å¼€å§‹æ‰§è¡Œé¡µé¢è·³è½¬...');
            router.replaceUrl(routerParams).then(() => {
              console.info('[finishTask] âœ… é¡µé¢è·³è½¬æˆåŠŸ');
            }).catch((routerError: Error) => {
              console.error('[finishTask] âŒ é¡µé¢è·³è½¬å¤±è´¥:', String(routerError));
              console.error('[finishTask] ğŸ” è·³è½¬å‚æ•° url:', routerParams.url);
              console.error('[finishTask] ğŸ” è·³è½¬å‚æ•° taskId:', routerParams.params.taskId);
              
              // è·³è½¬å¤±è´¥æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
              try {
                promptAction.showToast({
                  message: 'é¡µé¢è·³è½¬å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¿”å›ä»»åŠ¡åˆ—è¡¨',
                  duration: 3000
                });
              } catch (backupToastError) {
                console.error('[finishTask] âŒ å¤‡ç”¨æç¤ºä¹Ÿå¤±è´¥:', backupToastError);
              }
            });
          } catch (routerSyncError) {
            console.error('[finishTask] âŒ åŒæ­¥è·¯ç”±è°ƒç”¨å¤±è´¥:', routerSyncError);
          }
        }, 500); // å»¶è¿Ÿ500msæ‰§è¡Œè·³è½¬
        
        console.info('[finishTask] âœ… ä»»åŠ¡å®Œæˆæµç¨‹æ‰§è¡Œå®Œæ¯•');
      } else {
        console.error('[finishTask] âŒ åç«¯è¿”å›é”™è¯¯ code:', response.code);
        console.error('[finishTask] âŒ åç«¯è¿”å›é”™è¯¯ message:', response.msg);
        throw new Error(`åç«¯è¿”å›é”™è¯¯: ${response.msg}`);
      }
    } catch (error) {
      console.error('[finishTask] âŒ å®Œæˆä»»åŠ¡å¤±è´¥:', error);
      console.error('[finishTask] ğŸ” ä»»åŠ¡ID:', this.taskId);
      console.error('[finishTask] ğŸ” é”™è¯¯æ—¶é—´:', new Date().toISOString());
      
      try {
        promptAction.showToast({
          message: 'å®Œæˆä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•',
          duration: 2000
        });
      } catch (toastError) {
        console.error('[finishTask] âŒ é”™è¯¯æç¤ºæ˜¾ç¤ºå¤±è´¥:', toastError);
      }
    }
  }

  async abortTask() {
    try {
      console.info('[TaskExecuteView] ğŸ›‘ ç»ˆæ­¢ä»»åŠ¡');
      
      // ç´§æ€¥åœæ­¢AGV
      await AgvMovementService.emergencyStop();
      console.info('[TaskExecuteView] âœ… AGVç´§æ€¥åœæ­¢æˆåŠŸ');
      
      const response = await HttpUtil.post(`/agv/task/end/${this.taskId}?isAbort=true`);
      if (response.code === 200) {
        promptAction.showToast({
          message: 'ä»»åŠ¡å·²ç»ˆæ­¢',
          duration: 2000
        });
        
        this.stopPolling();
        this.isTaskRunning = false;
        
        console.info('[TaskExecuteView] âœ… ä»»åŠ¡ç»ˆæ­¢æˆåŠŸ');
        
        router.back();
      }
    } catch (error) {
      console.error('[TaskExecuteView] âŒ ç»ˆæ­¢ä»»åŠ¡å¤±è´¥:', error);
      promptAction.showToast({
        message: 'ç»ˆæ­¢ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  async checkCameraConnection() {
    try {
      console.info('[TaskExecuteView] ğŸ” æ£€æŸ¥æ‘„åƒå¤´è¿æ¥çŠ¶æ€');
      const isConnected = await CameraService.testConnection();
      this.cameraConnectionStatus = isConnected ? 'è¿æ¥æ­£å¸¸' : 'è¿æ¥å¼‚å¸¸';
      this.lastCameraCheck = new Date().toLocaleTimeString();
      
      console.info('[TaskExecuteView] ğŸ“Š æ‘„åƒå¤´è¿æ¥æ£€æŸ¥ç»“æœ isConnected:', isConnected);
      console.info('[TaskExecuteView] ğŸ“Š æ‘„åƒå¤´è¿æ¥æ£€æŸ¥ç»“æœ checkTime:', this.lastCameraCheck);
    } catch (error) {
      console.error('[TaskExecuteView] âŒ æ‘„åƒå¤´è¿æ¥æ£€æŸ¥å¤±è´¥:', error);
      this.cameraConnectionStatus = 'æ£€æŸ¥å¤±è´¥';
      this.lastCameraCheck = new Date().toLocaleTimeString();
    }
  }

  refreshVideo() {
    if (this.cameras.length > 0 && this.currentCameraIndex >= 0) {
      const currentCamera = this.cameras[this.currentCameraIndex];
      this.videoUrl = CameraService.generateRefreshStreamUrl(currentCamera.id);
      
      console.info('[TaskExecuteView] ğŸ”„ åˆ·æ–°è§†é¢‘æµ:', JSON.stringify({
        cameraId: currentCamera.id,
        cameraName: currentCamera.name,
        refreshUrl: this.videoUrl
      }));
      
      // æ˜¾ç¤ºåˆ·æ–°æç¤º
      setTimeout(() => {
        try {
          promptAction.showToast({
            message: `æ­£åœ¨åˆ·æ–°${currentCamera.name}è§†é¢‘æµ`,
            duration: 2000
          });
        } catch (toastError) {
          console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
        }
      }, 0);
    } else {
      console.warn('[TaskExecuteView] âš ï¸ æ— å¯ç”¨æ‘„åƒå¤´è¿›è¡Œåˆ·æ–°');
    }
  }

  /**
   * æ‰‹åŠ¨åˆ·æ–°æ‘„åƒå¤´åˆ—è¡¨
   */
  async refreshCameraList() {
    try {
      console.info('[TaskExecuteView] ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æ‘„åƒå¤´åˆ—è¡¨');
      
      // æ˜¾ç¤ºåŠ è½½æç¤º
      setTimeout(() => {
        try {
          promptAction.showToast({
            message: 'æ­£åœ¨åˆ·æ–°æ‘„åƒå¤´åˆ—è¡¨...',
            duration: 1500
          });
        } catch (toastError) {
          console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
        }
      }, 0);
      
      // é‡æ–°è·å–æ‘„åƒå¤´åˆ—è¡¨
      const newCameras = await CameraService.getCameraInfoList();
      const oldCameraCount = this.cameras.length;
      this.cameras = newCameras;
      
      // æ£€æŸ¥æ‘„åƒå¤´è¿æ¥çŠ¶æ€
      await this.checkCameraConnection();
      
      const logInfo: CameraLoadLogInfo = {
        cameraCount: this.cameras.length,
        cameras: this.cameras.map((c: CameraInfo): CameraInfoItem => ({ id: c.id, name: c.name }))
      };
      console.info('[TaskExecuteView] âœ… æ‘„åƒå¤´åˆ—è¡¨åˆ·æ–°æˆåŠŸ:', JSON.stringify(logInfo));
      
      // å¦‚æœå½“å‰é€‰æ‹©çš„æ‘„åƒå¤´ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œé‡ç½®ä¸ºç¬¬ä¸€ä¸ª
      if (this.currentCameraIndex >= this.cameras.length) {
        this.currentCameraIndex = 0;
      }
      
      // å¦‚æœæœ‰æ‘„åƒå¤´ä¸”å½“å‰æ²¡æœ‰é€‰æ‹©ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
      if (this.cameras.length > 0 && this.currentCameraIndex >= 0) {
        this.switchCamera(this.currentCameraIndex);
      }
      
      // æ˜¾ç¤ºåˆ·æ–°ç»“æœ
      setTimeout(() => {
        try {
          const changeText = this.cameras.length !== oldCameraCount ? 
            `æ‘„åƒå¤´æ•°é‡ä»${oldCameraCount}ä¸ªå˜ä¸º${this.cameras.length}ä¸ª` : 
            `æ‘„åƒå¤´åˆ—è¡¨å·²æ›´æ–°(${this.cameras.length}ä¸ª)`;
          promptAction.showToast({
            message: changeText,
            duration: 2500
          });
        } catch (toastError) {
          console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
        }
      }, 0);
      
    } catch (error) {
      console.error('[TaskExecuteView] âŒ åˆ·æ–°æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥:', error);
      
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      setTimeout(() => {
        try {
          promptAction.showToast({
            message: 'åˆ·æ–°æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
            duration: 3000
          });
        } catch (toastError) {
          console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
        }
      }, 0);
    }
  }

  openFlawDetail(flaw: LiveFlaw) {
    this.selectedFlaw = flaw;
    this.showFlawDetail = true;
  }

  closeFlawDetail() {
    this.showFlawDetail = false;
    this.selectedFlaw = null;
  }

  // æ˜¾ç¤ºæ–°æ•…éšœå¼¹çª—æé†’
  showNewFlawAlert(flaw: LiveFlaw) {
    this.newFlawAlert = {
      show: true,
      flaw: flaw
    };
    console.info('[TaskExecuteView] ğŸ”” æ˜¾ç¤ºæ–°æ•…éšœå¼¹çª—:', flaw.flawName);
  }

  // å…³é—­æ–°æ•…éšœå¼¹çª—
  closeNewFlawAlert() {
    this.newFlawAlert = {
      show: false,
      flaw: null
    };
  }

  // ä»æ–°æ•…éšœå¼¹çª—æŸ¥çœ‹è¯¦æƒ…
  viewFlawFromAlert() {
    if (this.newFlawAlert.flaw) {
      this.openFlawDetail(this.newFlawAlert.flaw);
      this.closeNewFlawAlert();
    }
  }

  getFlawStatusColor(status: string): string {
    switch (status) {
      case 'confirmed':
        return '#f56c6c';
      case 'pending':
        return '#e6a23c';
      default:
        return '#909399';
    }
  }

  /**
   * è·å–æ‘„åƒå¤´çŠ¶æ€é¢œè‰²
   * @param status æ‘„åƒå¤´çŠ¶æ€
   * @returns çŠ¶æ€å¯¹åº”çš„é¢œè‰²
   */
  getStatusColor(status: string): string {
    switch (status) {
      case 'online':
        return AppConstants.COLORS.SUCCESS;
      case 'offline':
        return AppConstants.COLORS.DANGER;
      default:
        return AppConstants.COLORS.WARNING;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('â† è¿”å›')
          .fontSize(14)
          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
          .backgroundColor('transparent')
          .onClick(() => {
            this.stopPolling();
            router.back();
          })
        
        Text('ä»»åŠ¡æ‰§è¡Œ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')
      .border({ width: { bottom: 1 }, color: '#eeeeee' })

      if (this.loading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color(AppConstants.COLORS.PRIMARY)
          
          Text('æ­£åœ¨è¿æ¥è®¾å¤‡...')
            .fontSize(14)
            .fontColor(AppConstants.COLORS.TEXT_REGULAR)
            .margin({ top: 10 })
        }
        .width('100%')
        .height('100%')

        .alignItems(HorizontalAlign.Center)
      } else {
        // ä¸»è¦å†…å®¹ - æ·»åŠ æ»šåŠ¨åŠŸèƒ½
        Scroll() {
          Row() {
          // å·¦ä¾§è§†é¢‘åŒºåŸŸ
          Column() {
            // æ‘„åƒå¤´è¿æ¥çŠ¶æ€ä¿¡æ¯
            Row() {
              Column() {
                Row() {
                  Text('æ‘„åƒå¤´æœåŠ¡:')
                    .fontSize(12)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                  
                  Text(this.cameraConnectionStatus)
                    .fontSize(12)
                    .fontColor(this.cameraConnectionStatus === 'è¿æ¥æ­£å¸¸' ? AppConstants.COLORS.SUCCESS : AppConstants.COLORS.DANGER)
                    .margin({ left: 8 })
                  
                  if (this.lastCameraCheck) {
                    Text(`(${this.lastCameraCheck})`)
                      .fontSize(10)
                      .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
                      .margin({ left: 5 })
                  }
                  
                  Text(`è§†é¢‘æº: ${this.cameras.length}ä¸ª`)
                    .fontSize(12)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .margin({ left: 15 })
                }
                .alignItems(VerticalAlign.Center)
              }
              .layoutWeight(1)
              
              // æ‰‹åŠ¨åˆ·æ–°æ‘„åƒå¤´åˆ—è¡¨æŒ‰é’®
              Button('ğŸ”„ åˆ·æ–°æ‘„åƒå¤´åˆ—è¡¨')
                .fontSize(11)
                .fontColor(AppConstants.COLORS.PRIMARY)
                .backgroundColor('transparent')
                .border({ width: 1, color: AppConstants.COLORS.PRIMARY })
                .borderRadius(4)
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .onClick(() => this.refreshCameraList())
            }
            .width('100%')
            .padding({ left: 10, right: 10, top: 8, bottom: 8 })
            .backgroundColor('#f8f9fa')
            .border({ width: { bottom: 1 }, color: '#eeeeee' })
            .justifyContent(FlexAlign.SpaceBetween)
            .alignItems(VerticalAlign.Center)
            // è§†é¢‘æ’­æ”¾å™¨
            Stack() {
              if (this.videoUrl && this.cameras.length > 0) {
                Video({
                  src: this.videoUrl
                })
                  .width('100%')
                  .height(450)
                  .autoPlay(true)
                  .controls(false)
                  .objectFit(ImageFit.Contain)
                  .backgroundColor('#000000')
                  .onStart(() => {
                    console.info('[TaskExecuteView] â–¶ï¸ è§†é¢‘å¼€å§‹æ’­æ”¾:', this.cameras[this.currentCameraIndex]?.name);
                  })
                  .onPause(() => {
                    console.info('[TaskExecuteView] â¸ï¸ è§†é¢‘æš‚åœ');
                  })
                  .onFinish(() => {
                    console.info('[TaskExecuteView] ğŸ”š è§†é¢‘æ’­æ”¾ç»“æŸ');
                  })
                  .onError(() => {
                    console.error('[TaskExecuteView] âŒ è§†é¢‘æ’­æ”¾é”™è¯¯');
                    setTimeout(() => {
                      try {
                        promptAction.showToast({
                          message: `è§†é¢‘æµè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡æ–°åˆ·æ–°`,
                          duration: 3000
                        });
                      } catch (toastError) {
                        console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
                      }
                    }, 0);
                  })
              } else {
                Column() {
                  Text('ğŸ“¹')
                    .fontSize(48)
                    .fontColor('#cccccc')
                  Text(this.cameras.length === 0 ? 'æ— å¯ç”¨æ‘„åƒå¤´' : 'æ­£åœ¨è¿æ¥è§†é¢‘æµ...')
                    .fontSize(16)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .margin({ top: 10 })
                  
                  if (this.cameras.length === 0) {
                    Text('è¯·æ£€æŸ¥æ‘„åƒå¤´è®¾å¤‡è¿æ¥çŠ¶æ€')
                      .fontSize(12)
                      .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
                      .margin({ top: 5 })
                  }
                }
                .width('100%')
                .height(450)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
                .backgroundColor('#f5f5f5')
              }

              // è§†é¢‘æ§åˆ¶æŒ‰é’®
              Row() {
                Button('ğŸ”„ åˆ·æ–°')
                  .fontSize(12)
                  .fontColor('#ffffff')
                  .backgroundColor('rgba(0,0,0,0.6)')
                  .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
                  .borderRadius(4)
                  .enabled(this.cameras.length > 0)
                  .onClick(() => this.refreshVideo())

                Button(this.isAudioEnabled ? 'ğŸ”Š' : 'ğŸ”‡')
                  .fontSize(12)
                  .fontColor('#ffffff')
                  .backgroundColor('rgba(0,0,0,0.6)')
                  .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
                  .borderRadius(4)
                  .margin({ left: 10 })
                  .enabled(this.cameras.length > 0)
                  .onClick(() => {
                    this.isAudioEnabled = !this.isAudioEnabled;
                    const statusText = this.isAudioEnabled ? 'éŸ³é¢‘å·²å¼€å¯' : 'éŸ³é¢‘å·²å…³é—­';
                    setTimeout(() => {
                      try {
                        promptAction.showToast({
                          message: statusText,
                          duration: 1500
                        });
                      } catch (toastError) {
                        console.warn('[TaskExecuteView] âš ï¸ Toastæ˜¾ç¤ºå¤±è´¥:', toastError);
                      }
                    }, 0);
                  })
                
                // æ˜¾ç¤ºå½“å‰æ‘„åƒå¤´çŠ¶æ€
                if (this.cameras.length > 0 && this.currentCameraIndex >= 0) {
                  Text(`ğŸ“¹ ${this.cameras[this.currentCameraIndex].name}`)
                    .fontSize(12)
                    .fontColor('#ffffff')
                    .backgroundColor('rgba(0,0,0,0.6)')
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .borderRadius(4)
                    .margin({ left: 10 })
                }
              }
              .position({ x: 10, y: 10 })
            }
            .width('100%')
            .borderRadius(8)
            .border({ width: 1, color: '#dddddd' })

            // æ‘„åƒå¤´åˆ‡æ¢
            if (this.cameras.length > 0) {
              Column() {
                Text(`æ‘„åƒå¤´åˆ—è¡¨ (${this.cameras.length}ä¸ª)`)
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  .margin({ bottom: 10 })
                
                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.cameras, (camera: Camera, index: number) => {
                    Button() {
                      Column() {
                        Text(camera.name)
                          .fontSize(12)
                          .fontColor(index === this.currentCameraIndex ? '#ffffff' : AppConstants.COLORS.TEXT_PRIMARY)
                          .maxLines(1)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                        
                        Text(camera.status || 'unknown')
                          .fontSize(10)
                          .fontColor(index === this.currentCameraIndex ? 'rgba(255,255,255,0.8)' : this.getStatusColor(camera.status || 'unknown'))
                          .margin({ top: 2 })
                      }
                      .alignItems(HorizontalAlign.Center)
                    }
                    .backgroundColor(index === this.currentCameraIndex ? AppConstants.COLORS.PRIMARY : '#ffffff')
                    .border({ 
                      width: 1, 
                      color: index === this.currentCameraIndex ? AppConstants.COLORS.PRIMARY : '#dddddd' 
                    })
                    .borderRadius(6)
                    .margin({ right: 8, bottom: 8 })
                    .padding({ left: 10, right: 10, top: 6, bottom: 6 })
                    .onClick(() => this.switchCamera(index))
                  }, (camera: Camera) => camera.id)
                }
                .width('100%')
              }
              .width('100%')
              .padding(15)
              .backgroundColor('#f8f9fa')
              .border({ width: { top: 1 }, color: '#eeeeee' })
            }
      

            // æ§åˆ¶æŒ‰é’®
            Row() {
              Button('â¬…ï¸ åé€€')
                .fontSize(14)
                .fontColor('#ffffff')
                .backgroundColor('#909399')
                .border({ width: 1, color: '#909399' })
                .enabled(this.isTaskRunning)
                .onClick(() => this.controlVehicle('backward'))

              Button('â¹ï¸ åœæ­¢')
                .fontSize(14)
                .fontColor('#ffffff')
                .backgroundColor('#f56c6c')
                .border({ width: 1, color: '#f56c6c' })
                .margin({ left: 15, right: 15 })
                .enabled(this.isTaskRunning)
                .onClick(() => this.controlVehicle('stop'))

              Button('â¡ï¸ å‰è¿›')
                .fontSize(14)
                .fontColor('#ffffff')
                .backgroundColor(AppConstants.COLORS.SUCCESS)
                .border({ width: 1, color: AppConstants.COLORS.SUCCESS })
                .enabled(this.isTaskRunning)
                .onClick(() => this.controlVehicle('forward'))
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ top: 20 })

            // ä»»åŠ¡æ§åˆ¶
            Row() {
              Button('âœ… å®Œæˆå·¡æ£€')
                .fontSize(16)
                .fontColor('#ffffff')
                .backgroundColor(AppConstants.COLORS.SUCCESS)
                .border({ width: 1, color: AppConstants.COLORS.SUCCESS })
                .layoutWeight(1)
                .enabled(this.isTaskRunning)
                .onClick(() => this.finishTask())

              Button('âŒ ç»ˆæ­¢å·¡æ£€')
                .fontSize(16)
                .fontColor('#ffffff')
                .backgroundColor('#f56c6c')
                .border({ width: 1, color: '#f56c6c' })
                .layoutWeight(1)
                .margin({ left: 15 })
                .enabled(this.isTaskRunning)
                .onClick(() => this.abortTask())
            }
            .width('100%')
            .margin({ top: 20 })
          }
          .layoutWeight(1)
          .padding(20)

          // å³ä¾§çŠ¶æ€åŒºåŸŸ
          Column() {
            // ä»»åŠ¡ä¿¡æ¯
            if (this.task) {
              Column() {
                Text('ä»»åŠ¡ä¿¡æ¯')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 15 })

                Row() {
                  Text('ä»»åŠ¡ç¼–å·:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  Text(this.task.taskCode)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                }
                .width('100%')
                .margin({ bottom: 8 })

                Row() {
                  Text('ä»»åŠ¡åç§°:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  Text(this.task.taskName)
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                }
                .width('100%')
                .margin({ bottom: 8 })

                Row() {
                  Text('çŠ¶æ€:')
                    .fontSize(14)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                    .width(80)
                  Text(this.isTaskRunning ? 'å·¡è§†ä¸­' : 'å·²åœæ­¢')
                    .fontSize(14)
                    .fontColor(this.isTaskRunning ? AppConstants.COLORS.SUCCESS : '#f56c6c')
                }
                .width('100%')
              }
              .width('100%')
              .padding(15)
              .backgroundColor('#ffffff')
              .borderRadius(8)
              .border({ width: 1, color: '#eeeeee' })
              .margin({ bottom: 20 })
            }

            // è½¦è¾†çŠ¶æ€
            if (this.vehicleStatus) {
              Column() {
                Text('è½¦è¾†çŠ¶æ€')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 15 })

                Row() {
                  Column() {
                    Text(this.vehicleStatus.systemTime)
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                    Text('ç³»ç»Ÿæ—¶é—´')
                      .fontSize(12)
                      .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                }
                .layoutWeight(1)

                Column() {
                  Text(`${this.vehicleStatus.distance}m`)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                  Text('è¡Œé©¶è·ç¦»')
                    .fontSize(12)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                }
                .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 15 })

              Row() {
                Column() {
                  Text(this.vehicleStatus.flawCount.toString())
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#f56c6c')
                  Text('æ•…éšœæ•°é‡')
                    .fontSize(12)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                }
                .layoutWeight(1)

                Column() {
                  Text(`${Math.min(Math.max(Math.round(this.vehicleStatus.position / 10), 0), 100)}%`)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(AppConstants.COLORS.PRIMARY)
                  Text('å·¡æ£€è¿›åº¦')
                    .fontSize(12)
                    .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                }
                .layoutWeight(1)
              }
              .width('100%')
            }
            .width('100%')
            .padding(15)
            .backgroundColor('#ffffff')
            .borderRadius(8)
            .border({ width: 1, color: '#eeeeee' })
            .margin({ bottom: 20 })
          }

          // è¿›åº¦æ¡
          if (this.vehicleStatus) {
            Column() {
              Text('å·¡æ£€è¿›åº¦')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 15 })

              Stack({ alignContent: Alignment.Start }) {
                // è¿›åº¦æ¡èƒŒæ™¯
                Row()
                  .width('100%')
                  .height(8)
                  .backgroundColor('#f0f0f0')
                  .borderRadius(4)

                // è¿›åº¦æ¡å¡«å……
                Row()
                  .width(`${Math.min(Math.max(Math.round(this.vehicleStatus.position / 10), 0), 100)}%`)
                  .height(8)
                  .backgroundColor(AppConstants.COLORS.PRIMARY)
                  .borderRadius(4)
                  .alignSelf(ItemAlign.Start)

                // è½¦è¾†ä½ç½®æ ‡è®°
                Text('ğŸš›')
                  .fontSize(20)
                  .position({ x: `${Math.min(Math.max(Math.round(this.vehicleStatus.position / 10), 0), 100)}%`, y: -6 })

                // æ•…éšœæ ‡è®°
                ForEach(this.liveFlaws, (flaw: LiveFlaw, index: number) => {
                  Button()
                    .width(12)
                    .height(12)
                    .borderRadius(6)
                    .backgroundColor(this.getFlawStatusColor(flaw.confirmed ? 'confirmed' : 'pending'))
                    .position({ x: `${(index + 1) * 20}%`, y: -2 })
                    .onClick(() => this.openFlawDetail(flaw))
                }, (flaw: LiveFlaw) => flaw.id.toString())
              }
              .width('100%')
              .height(20)
              .margin({ bottom: 20 })
            }
            .width('100%')
            .padding(15)
            .backgroundColor('#ffffff')
            .borderRadius(8)
            .border({ width: 1, color: '#eeeeee' })
            .margin({ bottom: 20 })
          }

          // å®æ—¶æ•…éšœåˆ—è¡¨
          Column() {
            Text('å®æ—¶æ•…éšœ')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 15 })

            if (this.liveFlaws.length === 0) {
              Text('æš‚æ— æ•…éšœ')
                .fontSize(14)
                .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                .textAlign(TextAlign.Center)
                .width('100%')
                .padding(20)
            } else {
              List() {
                ForEach(this.liveFlaws, (flaw: LiveFlaw) => {
                  ListItem() {
                    Row() {
                      Column() {
                        Text(flaw.flawName)
                          .fontSize(14)
                          .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
                          .fontWeight(FontWeight.Medium)
                        Text(flaw.flawType)
                          .fontSize(12)
                          .fontColor(AppConstants.COLORS.TEXT_REGULAR)
                          .margin({ top: 4 })
                      }
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)

                      Text('ğŸ“')
                        .fontSize(16)
                        .fontColor(this.getFlawStatusColor(flaw.confirmed ? 'confirmed' : 'pending'))
                    }
                    .width('100%')
                    .padding(12)
                    .backgroundColor('#ffffff')
                    .border({ width: 1, color: '#eeeeee' })
                    .borderRadius(6)
                    .onClick(() => this.openFlawDetail(flaw))
                  }
                  .margin({ bottom: 8 })
                }, (flaw: LiveFlaw) => flaw.id.toString())
              }
              .width('100%')
              .height(200)
            }
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .border({ width: 1, color: '#eeeeee' })
        }
        .width(400)
        .padding(20)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
        }
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
        .scrollBarColor('#CCCCCC')
        .scrollBarWidth(6)
        .edgeEffect(EdgeEffect.Spring)
        .width('100%')
        .layoutWeight(1)
    }

    // æ•…éšœè¯¦æƒ…æ¨¡æ€æ¡†
    if (this.showFlawDetail && this.selectedFlaw) {
      Stack() {
        Column() {
          // æ¨¡æ€æ¡†æ ‡é¢˜
          Row() {
            Text('å®æ—¶æ•…éšœè¯¦æƒ…')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .layoutWeight(1)
            
            Button('âœ•')
              .fontSize(16)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .backgroundColor('transparent')
              .onClick(() => this.closeFlawDetail())
          }
          .width('100%')
          .padding(20)
          .border({ width: { bottom: 1 }, color: '#eeeeee' })

          // æ¨¡æ€æ¡†å†…å®¹
          Column() {
            Text(`æ•…éšœåç§°: ${this.selectedFlaw.flawName}`)
              .fontSize(16)
              .fontColor(AppConstants.COLORS.TEXT_PRIMARY)
              .margin({ bottom: 10 })

            Text(`æ•…éšœç±»å‹: ${this.selectedFlaw.flawType}`)
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .margin({ bottom: 10 })

            Text(`å‘ç°æ—¶é—´: ${this.selectedFlaw.createTime}`)
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_REGULAR)
              .margin({ bottom: 20 })

            Text('è¯·åœ¨ä»»åŠ¡å®Œæˆåè¿›è¡Œè¯¦ç»†ç¡®è®¤')
              .fontSize(14)
              .fontColor(AppConstants.COLORS.TEXT_SECONDARY)
              .textAlign(TextAlign.Center)
          }
          .width('100%')
          .padding(20)
          .alignItems(HorizontalAlign.Start)
        }
        .width(500)
        .height(300)
        .backgroundColor('#ffffff')
        .borderRadius(8)
        .shadow({ radius: 12, color: 'rgba(0,0,0,0.2)', offsetX: 0, offsetY: 4 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('rgba(0,0,0,0.5)')
      .onClick(() => this.closeFlawDetail())
    }

    // æ–°æ•…éšœæé†’å¼¹çª—
    if (this.newFlawAlert.show && this.newFlawAlert.flaw) {
      Stack() {
        Column() {
          // å¼¹çª—æ ‡é¢˜
          Row() {
            Text('âš ï¸')
              .fontSize(24)
              .fontColor('#FF6B35')
            
            Text('å‘ç°æ–°æ•…éšœ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF6B35')
              .margin({ left: 8 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Start)
          .margin({ bottom: 16 })

          // æ•…éšœä¿¡æ¯
          Column() {
            Row() {
              Text('æ•…éšœåç§°ï¼š')
                .fontSize(14)
                .fontColor('#666666')
                .width(80)
              Text(this.newFlawAlert.flaw.flawName || 'æœªçŸ¥æ•…éšœ')
                .fontSize(14)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
                .layoutWeight(1)
            }
            .width('100%')
            .margin({ bottom: 8 })

            Row() {
              Text('æ•…éšœç±»å‹ï¼š')
                .fontSize(14)
                .fontColor('#666666')
                .width(80)
              Text(this.newFlawAlert.flaw.flawType || 'æœªçŸ¥ç±»å‹')
                .fontSize(14)
                .fontColor('#333333')
                .layoutWeight(1)
            }
            .width('100%')
            .margin({ bottom: 8 })

            Row() {
              Text('å‘ç°æ—¶é—´ï¼š')
                .fontSize(14)
                .fontColor('#666666')
                .width(80)
              Text(this.newFlawAlert.flaw.createTime ? new Date(this.newFlawAlert.flaw.createTime).toLocaleString() : '')
                .fontSize(14)
                .fontColor('#333333')
                .layoutWeight(1)
            }
            .width('100%')
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ bottom: 20 })

          // æ“ä½œæŒ‰é’®
          Row() {
            Button('ç¨åå¤„ç†')
              .fontSize(14)
              .fontColor('#666666')
              .backgroundColor('#F5F5F5')
              .borderRadius(6)
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .onClick(() => {
                this.closeNewFlawAlert();
              })

            Button('æŸ¥çœ‹è¯¦æƒ…')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .backgroundColor('#007AFF')
              .borderRadius(6)
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .margin({ left: 12 })
              .onClick(() => {
                this.viewFlawFromAlert();
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.End)
        }
        .width(320)
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({
          radius: 20,
          color: '#1A000000',
          offsetX: 0,
          offsetY: 4
        })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('rgba(0, 0, 0, 0.5)')
    }
  }
  .width('100%')
  .height('100%')
  .backgroundColor(AppConstants.COLORS.BACKGROUND_BASE)
}
}